<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÖ M√≥dulo de Asistencias - Sistema Educativo</title>
    <style>
        /* ====================================
           CSS VARIABLES & RESET
        ==================================== */
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--gradient-primary);
            min-height: 100vh;
            padding: 1.25rem;
            color: var(--gray-900);
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        /* ====================================
           HEADER SECTION
        ==================================== */
        .header {
            background: white;
            padding: 2rem;
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1.5rem;
        }
        
        .header-content h1 {
            color: var(--gray-900);
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .header-content p {
            color: var(--gray-600);
            font-size: 1rem;
        }
        
        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        /* ====================================
           PERIOD INDICATOR
        ==================================== */
        .period-indicator {
            background: var(--gradient-primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-xl);
            margin: 1rem 0 2rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .period-icon {
            font-size: 1.5rem;
            opacity: 0.9;
        }

        .period-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .period-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .period-info {
            font-size: 1.125rem;
            font-weight: 600;
            color: white;
        }

        .period-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.15);
            padding: 0.5rem 1rem;
            border-radius: 1.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .pulse {
            color: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        
        /* ====================================
           BUTTONS
        ==================================== */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: var(--gray-600);
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .btn-success {
            background: var(--gradient-success);
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .btn-warning {
            background: var(--gradient-warning);
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .btn-danger {
            background: var(--gradient-danger);
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .btn-info {
            background: var(--info);
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid currentColor;
        }
        
        /* ====================================
           MAIN LAYOUT
        ==================================== */
        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .card {
            background: white;
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 1px solid var(--gray-200);
        }
        
        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            font-weight: 600;
            color: var(--gray-900);
            font-size: 1.125rem;
            background: var(--gray-50);
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        /* ====================================
           CALENDAR STYLES
        ==================================== */
        .calendar-container {
            text-align: center;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .calendar-nav {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .calendar-nav:hover {
            background: var(--secondary);
            transform: scale(1.05);
        }
        
        .calendar-month-year {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .calendar-wrapper {
            background: var(--gray-50);
            border-radius: var(--radius-xl);
            padding: 1px;
            overflow: hidden;
            border: 1px solid var(--gray-200);
        }

        .calendar-days-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--primary);
        }

        .calendar-day-header {
            padding: 0.75rem 0.5rem;
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .calendar-days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--gray-300);
            gap: 1px;
        }

        .calendar-day {
            background: white;
            padding: 0.75rem 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            min-height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            position: relative;
        }

        .calendar-day:hover {
            background: var(--gray-100);
            transform: scale(1.05);
            z-index: 2;
        }

        .calendar-day.other-month {
            color: var(--gray-400);
            background: var(--gray-50);
            font-weight: 400;
        }

        .calendar-day.selected {
            background: var(--primary);
            color: white;
            font-weight: 700;
            box-shadow: 0 0 0 2px var(--primary);
        }

        .calendar-day.today {
            background: var(--success);
            color: white;
            font-weight: 700;
        }

        .calendar-day.weekend {
            background: #fff5f5;
        }

        .calendar-day.has-attendance {
            border: 2px solid var(--warning);
        }

        .calendar-day.has-attendance::before {
            content: 'üìù';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.5rem;
        }
        
        /* ====================================
           FILTERS
        ==================================== */
        .filter-group {
            margin-bottom: 1rem;
        }
        
        .filter-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .filter-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* ====================================
           LESSON CONFIG
        ==================================== */
        .lesson-config {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--gray-200);
        }
        
        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .config-input {
            width: 80px;
            padding: 0.375rem 0.5rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            text-align: center;
        }
        
        .config-tip {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: var(--info);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            color: var(--info);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        /* ====================================
           ATTENDANCE MAIN AREA
        ==================================== */
        .attendance-main {
            background: white;
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 1px solid var(--gray-200);
        }
        
        .attendance-header {
            padding: 2rem;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gradient-primary);
            color: white;
        }
        
        .attendance-date {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .attendance-info {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        /* ====================================
           QUICK ACTIONS
        ==================================== */
        .quick-actions {
            padding: 1.5rem;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .quick-actions-title {
            font-weight: 600;
            color: var(--gray-700);
            margin-right: 1rem;
            font-size: 0.875rem;
        }
        
        .status-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 1.5rem;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            box-shadow: var(--shadow-sm);
            border: 2px solid transparent;
        }
        
        .status-btn.present {
            background: var(--gradient-success);
            color: white;
        }
        
        .status-btn.late-justified {
            background: var(--gradient-warning);
            color: white;
        }
        
        .status-btn.late-unjustified {
            background: linear-gradient(135deg, #fd7e14, #ff8c42);
            color: white;
        }
        
        .status-btn.absent-justified {
            background: var(--info);
            color: white;
        }
        
        .status-btn.absent-unjustified {
            background: var(--gradient-danger);
            color: white;
        }
        
        .status-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: var(--shadow-lg);
        }
        
        /* ====================================
           STUDENTS TABLE
        ==================================== */
        .students-table {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }
        
        th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            position: sticky;
            top: 0;
            font-size: 0.875rem;
        }
        
        tbody tr:hover {
            background: var(--gray-50);
        }
        
        .student-photo {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .student-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }
        
        .student-id {
            color: var(--gray-500);
            font-size: 0.75rem;
        }
        
        /* ====================================
           ATTENDANCE CONTROLS
        ==================================== */
        .attendance-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .attendance-btn {
            padding: 0.375rem 0.75rem;
            border: none;
            border-radius: 1.25rem;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            min-width: 4rem;
            justify-content: center;
            box-shadow: var(--shadow-sm);
        }
        
        .attendance-btn.present {
            background: var(--gradient-success);
            color: white;
        }
        
        .attendance-btn.late-justified {
            background: var(--gradient-warning);
            color: white;
        }
        
        .attendance-btn.late-unjustified {
            background: linear-gradient(135deg, #fd7e14, #ff8c42);
            color: white;
        }
        
        .attendance-btn.absent-justified {
            background: var(--info);
            color: white;
        }
        
        .attendance-btn.absent-unjustified {
            background: var(--gradient-danger);
            color: white;
        }
        
        .attendance-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: var(--shadow-md);
        }
        
        .attendance-status {
            padding: 0.375rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            min-width: 6rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }
        
        .status-present {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        .status-late-justified {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .status-late-unjustified {
            background: rgba(253, 126, 20, 0.1);
            color: #ea580c;
            border: 1px solid rgba(253, 126, 20, 0.2);
        }
        
        .status-absent-justified {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .status-absent-unjustified {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .status-not-marked {
            background: var(--gray-100);
            color: var(--gray-600);
            border: 1px solid var(--gray-200);
        }
        
        /* ====================================
           STATS PANEL
        ==================================== */
        .stats-panel {
            background: white;
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            margin-top: 2rem;
            border: 1px solid var(--gray-200);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            padding: 2rem;
        }
        
        .stat-card {
            text-align: center;
            padding: 1.5rem;
            background: var(--gray-50);
            border-radius: var(--radius-xl);
            border: 1px solid var(--gray-200);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--gray-600);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }
        
        /* ====================================
           MODALS
        ==================================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius-2xl);
            padding: 0;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--gray-200);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-400);
            cursor: pointer;
            padding: 0;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .close-btn:hover {
            background: var(--gray-200);
            color: var(--gray-600);
        }
        
        .modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1.5rem;
            border-top: 1px solid var(--gray-200);
            background: var(--gray-50);
        }
        
        /* ====================================
           FORM ELEMENTS
        ==================================== */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
            background: white;
        }
        
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* ====================================
           NOTIFICATION SYSTEM
        ==================================== */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            max-width: 400px;
        }
        
        .notification {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            padding: 1rem 1.5rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 1rem;
            transform: translateX(420px);
            transition: all 0.3s ease;
            border: 1px solid var(--gray-200);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-left-color: var(--success);
        }
        
        .notification.error {
            border-left-color: var(--danger);
        }
        
        .notification.warning {
            border-left-color: var(--warning);
        }
        
        .notification.info {
            border-left-color: var(--info);
        }
        
        .notification-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        
        .notification.success .notification-icon {
            color: var(--success);
        }
        
        .notification.error .notification-icon {
            color: var(--danger);
        }
        
        .notification.warning .notification-icon {
            color: var(--warning);
        }
        
        .notification.info .notification-icon {
            color: var(--info);
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }
        
        .notification-message {
            color: var(--gray-600);
            font-size: 0.8rem;
            line-height: 1.4;
        }
        
        /* ====================================
           LOADING STATES
        ==================================== */
        .loading-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray-500);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            border: 2px solid var(--gray-300);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ====================================
           RESPONSIVE DESIGN
        ==================================== */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .sidebar {
                order: 2;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                display: grid;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
                padding: 1.5rem;
            }
            
            .header-actions {
                justify-content: center;
            }
            
            .period-indicator {
                flex-direction: column;
                text-align: center;
                gap: 0.75rem;
            }
            
            .quick-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .attendance-controls {
                flex-direction: column;
            }
            
            .calendar-day {
                padding: 0.5rem 0.25rem;
                font-size: 0.75rem;
                min-height: 2.5rem;
            }
            
            .calendar-day-header {
                padding: 0.5rem 0.25rem;
                font-size: 0.625rem;
            }
            
            .modal-content {
                width: 95%;
                margin: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
                padding: 1.5rem;
            }
            
            .sidebar {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .header-content h1 {
                font-size: 1.5rem;
            }
            
            .attendance-date {
                font-size: 1.25rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .attendance-controls {
                gap: 0.25rem;
            }
            
            .attendance-btn, .status-btn {
                font-size: 0.625rem;
                padding: 0.25rem 0.5rem;
            }
        }
        
        /* ====================================
           DEBUG PANEL
        ==================================== */
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 1rem;
            border-radius: var(--radius-lg);
            font-size: 0.75rem;
            max-width: 300px;
            z-index: 9999;
            display: none;
            backdrop-filter: blur(4px);
        }
        
        .debug-panel.show {
            display: block;
        }
        
        .debug-content {
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* ====================================
           CONFIRMATION MODAL
        ==================================== */
        .confirmation-modal .modal-content {
            max-width: 400px;
        }
        
        .confirmation-icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .confirmation-title {
            font-size: 1.25rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 0.5rem;
            color: var(--gray-900);
        }
        
        .confirmation-message {
            text-align: center;
            color: var(--gray-600);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        
        /* ====================================
           CUSTOM SCROLLBAR
        ==================================== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--gray-400);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <h1>üìÖ M√≥dulo de Asistencias</h1>
                <p>Control de asistencia seg√∫n reglamentos del MEP</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-info" onclick="openLessonConfigModal()">
                    ‚öôÔ∏è Configuraci√≥n
                </button>
                <button class="btn btn-primary" onclick="showClassStats()">
                    üìä Estad√≠sticas
                </button>
                <button class="btn btn-success" onclick="exportAttendance()">
                    üìÑ Exportar
                </button>
                <button class="btn btn-warning" onclick="toggleDebug()">
                    üêõ Debug
                </button>
                <a href="dashboard.html" class="btn btn-secondary">
                    ‚Üê Dashboard
                </a>
            </div>
        </div>

        <!-- Period Indicator -->
        <div class="period-indicator">
            <div class="period-icon">
                üìÖ
            </div>
            <div class="period-content">
                <span class="period-label">Per√≠odo Acad√©mico Activo:</span>
                <span class="period-info" id="activePeriodDisplay">2025 - Primer Semestre - Escuela Las Flores</span>
            </div>
            <div class="period-badge">
                <i class="pulse">‚óè</i>
                <span>Activo</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Calendar -->
                <div class="card">
                    <div class="card-header">
                        üìÖ Seleccionar Fecha
                    </div>
                    <div class="card-body">
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <button class="calendar-nav" onclick="changeMonth(-1)">‚Äπ</button>
                                <div class="calendar-month-year" id="calendarMonthYear">
                                    Mayo 2025
                                </div>
                                <button class="calendar-nav" onclick="changeMonth(1)">‚Ä∫</button>
                            </div>
                            <div class="calendar-wrapper">
                                <div class="calendar-days-header">
                                    <div class="calendar-day-header">Dom</div>
                                    <div class="calendar-day-header">Lun</div>
                                    <div class="calendar-day-header">Mar</div>
                                    <div class="calendar-day-header">Mi√©</div>
                                    <div class="calendar-day-header">Jue</div>
                                    <div class="calendar-day-header">Vie</div>
                                    <div class="calendar-day-header">S√°b</div>
                                </div>
                                <div class="calendar-days-grid" id="calendarDays">
                                    <!-- Los d√≠as se generan aqu√≠ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card">
                    <div class="card-header">
                        üéØ Filtros
                    </div>
                    <div class="card-body">
                        <div class="filter-group">
                            <label class="filter-label">Grado:</label>
                            <select class="filter-select" id="gradeFilter" onchange="loadStudents()">
                                <option value="">Seleccionar grado...</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-primary" style="width: 100%;" onclick="loadStudents()">
                                üîÑ Actualizar Lista
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Lesson Configuration -->
                <div class="card">
                    <div class="card-header">
                        üìö Configuraci√≥n Flexible
                    </div>
                    <div class="card-body">
                        <div class="lesson-config">
                            <div class="config-item">
                                <span>Lecciones/semana:</span>
                                <input type="number" class="config-input" id="lessonsPerWeek" value="5" min="1" max="10" onchange="updateFlexibleCalculation()">
                            </div>
                            <div class="config-item">
                                <span>Semanas planificadas:</span>
                                <input type="number" class="config-input" id="totalWeeks" value="40" min="1" max="52" onchange="updateFlexibleCalculation()">
                            </div>
                            <div class="config-item">
                                <span><strong>Total te√≥rico:</strong></span>
                                <span id="theoreticalLessons" style="color: var(--gray-600);">200</span>
                            </div>
                            <div class="config-item">
                                <span><strong>Lecciones reales:</strong></span>
                                <span id="actualLessons" style="color: var(--success); font-weight: bold;">0</span>
                            </div>
                            <div class="config-item">
                                <span><strong>Progreso:</strong></span>
                                <span id="progressInfo" style="color: var(--primary);">0%</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary btn-sm" style="flex: 1;" onclick="saveLessonConfig()">
                                üíæ Guardar
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="recalculateFromReal()">
                                üîÑ Ajustar
                            </button>
                        </div>
                        <div id="flexibleTip" class="config-tip">
                            üí° El sistema se ajusta autom√°ticamente a los d√≠as reales trabajados
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Area -->
            <div class="attendance-main">
                <!-- Attendance Header -->
                <div class="attendance-header">
                    <div class="attendance-date" id="attendanceDate">
                        S√°bado, 31 de Mayo de 2025
                    </div>
                    <div class="attendance-info" id="attendanceInfo">
                        Seleccione grado para comenzar
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <span class="quick-actions-title">‚ö° Acciones R√°pidas:</span>
                    <button class="status-btn present" onclick="markAllStudents('present')">
                        ‚úÖ Todos Presentes
                    </button>
                    <button class="status-btn late-justified" onclick="markAllStudents('late_justified')">
                        ‚è∞ Todos Tarde (J)
                    </button>
                    <button class="status-btn absent-justified" onclick="markAllStudents('absent_justified')">
                        üìã Todos Ausentes (J)
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="clearAllAttendance()">
                        üßπ Limpiar Todo
                    </button>
                </div>

                <!-- Students Table -->
                <div class="students-table">
                    <div id="loadingState" class="loading-state">
                        <div class="loading-spinner"></div>
                        <div style="margin-top: 1rem;">Seleccione grado para cargar estudiantes...</div>
                    </div>
                    
                    <table id="attendanceTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Estudiante</th>
                                <th>Estado Actual</th>
                                <th>Acciones</th>
                                <th>Hora Llegada</th>
                                <th>Justificaci√≥n</th>
                                <th>Asistencia MEP</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Stats Panel -->
        <div class="stats-panel">
            <div class="card-header">
                üìä Estad√≠sticas del D√≠a
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="statPresent">0</div>
                    <div class="stat-label">Presentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statLateJustified">0</div>
                    <div class="stat-label">Tard√≠as Justificadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statLateUnjustified">0</div>
                    <div class="stat-label">Tard√≠as Injustificadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statAbsentJustified">0</div>
                    <div class="stat-label">Ausencias Justificadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statAbsentUnjustified">0</div>
                    <div class="stat-label">Ausencias Injustificadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statNotMarked">0</div>
                    <div class="stat-label">Sin Marcar</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Debug Panel -->
    <div id="debugPanel" class="debug-panel">
        <h4>üêõ Debug Info</h4>
        <div class="debug-content" id="debugContent">Debug activado</div>
    </div>

    <!-- Justification Modal -->
    <div class="modal" id="justificationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Editar Asistencia</h2>
                <button class="close-btn" onclick="closeJustificationModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="justificationForm" onsubmit="saveJustification(event)">
                    <div class="form-group">
                        <label class="form-label">Estudiante:</label>
                        <div id="justificationStudent" style="font-weight: 600; color: var(--gray-700); padding: 0.5rem; background: var(--gray-50); border-radius: var(--radius-md);"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Estado:</label>
                        <select class="form-select" id="justificationStatus" required>
                            <option value="present">‚úÖ Presente</option>
                            <option value="late_justified">‚è∞ Tard√≠a Justificada</option>
                            <option value="late_unjustified">üî∂ Tard√≠a Injustificada</option>
                            <option value="absent_justified">üìã Ausencia Justificada</option>
                            <option value="absent_unjustified">‚ùå Ausencia Injustificada</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Hora de Llegada (opcional):</label>
                        <input type="time" class="form-input" id="justificationTime">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Justificaci√≥n:</label>
                        <textarea class="form-textarea" id="justificationText" rows="3" 
                                  placeholder="Describa la justificaci√≥n o motivo..."></textarea>
                    </div>
                </form>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeJustificationModal()">Cancelar</button>
                <button type="submit" form="justificationForm" class="btn btn-primary">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Lesson Config Modal -->
    <div class="modal" id="lessonConfigModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚öôÔ∏è Configuraci√≥n de la Nota</h2>
                <button class="close-btn" onclick="closeLessonConfigModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="lessonConfigForm" onsubmit="saveLessonConfigModal(event)">
                    <div class="form-group">
                        <label class="form-label">üìä Escala M√°xima de Notas:</label>
                        <input type="number" class="form-input" id="maxScaleInput" step="0.1" min="1" max="100" value="5.0" required>
                        <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.5rem;">
                            5.0 = MEP tradicional | 10.0 = escala de 10 | 100 = porcentajes
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeLessonConfigModal()">Cancelar</button>
                <button type="submit" form="lessonConfigForm" class="btn btn-primary">Guardar Configuraci√≥n</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal confirmation-modal" id="confirmationModal">
        <div class="modal-content">
            <div class="modal-body">
                <div class="confirmation-icon" id="confirmationIcon">‚ùì</div>
                <div class="confirmation-title" id="confirmationTitle">¬øConfirmar acci√≥n?</div>
                <div class="confirmation-message" id="confirmationMessage">Esta acci√≥n no se puede deshacer.</div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeConfirmationModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmationButton" onclick="executeConfirmedAction()">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // VARIABLES GLOBALES
        // ========================================
        let students = [];
        let currentDate = new Date();
        let selectedDate = new Date();
        let isBulkMarking = false;
        let currentGrade = '';
        let currentSubject = '';
        let currentStudentId = null;
        let attendanceData = {};
        let lessonConfig = { lessonsPerWeek: 5, totalWeeks: 40, totalLessons: 200 };
        let debugMode = false;
        let studentMEPStats = {}; // Cache para estad√≠sticas MEP
        let pendingConfirmationAction = null;

        function getCurrentAcademicPeriod() {
            if (window.unifiedPeriodSelector) {
                return window.unifiedPeriodSelector.getCurrentPeriod();
            }
            const saved = localStorage.getItem(getPeriodStorageKey ? getPeriodStorageKey() : 'currentAcademicPeriod');
            if (saved) {
                try { return JSON.parse(saved); } catch (e) {}
            }
            return { schoolId: '1', year: 2025, periodType: 'semester', periodNumber: 1 };
        }

        // ========================================
        // NOTIFICATION SYSTEM
        // ========================================
        function showNotification(type, title, message, duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            notification.innerHTML = `
                <div class="notification-icon">${icons[type] || icons.info}</div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Trigger animation
            setTimeout(() => notification.classList.add('show'), 10);
            
            // Auto remove
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, duration);
            
            // Click to dismiss
            notification.addEventListener('click', () => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            });
        }

        // ========================================
        // CONFIRMATION MODAL SYSTEM
        // ========================================
        function showConfirmation(options) {
            const modal = document.getElementById('confirmationModal');
            const icon = document.getElementById('confirmationIcon');
            const title = document.getElementById('confirmationTitle');
            const message = document.getElementById('confirmationMessage');
            const button = document.getElementById('confirmationButton');
            
            icon.textContent = options.icon || '‚ùì';
            title.textContent = options.title || '¬øConfirmar acci√≥n?';
            message.textContent = options.message || 'Esta acci√≥n no se puede deshacer.';
            button.textContent = options.confirmText || 'Confirmar';
            button.className = `btn ${options.confirmClass || 'btn-primary'}`;
            
            pendingConfirmationAction = options.onConfirm;
            modal.classList.add('show');
        }

        function closeConfirmationModal() {
            document.getElementById('confirmationModal').classList.remove('show');
            pendingConfirmationAction = null;
        }

        function executeConfirmedAction() {
            if (pendingConfirmationAction && typeof pendingConfirmationAction === 'function') {
                pendingConfirmationAction();
            }
            closeConfirmationModal();
        }

        // Helper para peticiones autenticadas
        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('sessionToken');

            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            };

            const mergedOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...(options.headers || {})
                }
            };

            const response = await fetch(url, mergedOptions);

            if (response.status === 401) {
                localStorage.removeItem('sessionToken');
                localStorage.removeItem('teacherInfo');
                window.location.href = '/login.html';
                return;
            }

            return response;
        }

        // ========================================
        // INICIALIZACI√ìN
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando m√≥dulo de asistencias mejorado...');
            initializeCalendar();
            loadFilters();
            updateCurrentDate();
            calculateTotalLessons();
            
            debugLog('Sistema iniciado correctamente');
        });

        // ========================================
        // FUNCIONES DE DEBUG
        // ========================================
        function debugLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] ${message}`, data);
            
            if (debugMode) {
                const debugContent = document.getElementById('debugContent');
                debugContent.innerHTML += `<div><strong>${timestamp}:</strong> ${message}</div>`;
                if (data) {
                    debugContent.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }

        function toggleDebug() {
            debugMode = !debugMode;
            const debugPanel = document.getElementById('debugPanel');
            if (debugMode) {
                debugPanel.classList.add('show');
                debugLog('Debug mode activado');
                showNotification('info', 'Debug Activado', 'Panel de debugging habilitado');
            } else {
                debugPanel.classList.remove('show');
                showNotification('info', 'Debug Desactivado', 'Panel de debugging deshabilitado');
            }
        }

        // ========================================
        // FUNCIONES DEL CALENDARIO
        // ========================================
        function initializeCalendar() {
            debugLog('üöÄ Inicializando calendario...');
            
            const now = new Date();
            currentDate = new Date(now.getFullYear(), now.getMonth(), 1);
            selectedDate = new Date(now);
            
            renderCalendar();
            updateCurrentDate();
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            debugLog(`üóìÔ∏è Renderizando: ${month + 1}/${year}`);
            
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            document.getElementById('calendarMonthYear').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const firstDayOfWeek = firstDay.getDay();
            
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';
            
            for (let i = 0; i < 42; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                let dayNumber;
                let dayDate;
                
                if (i < firstDayOfWeek) {
                    const prevMonth = month - 1;
                    const prevYear = prevMonth < 0 ? year - 1 : year;
                    const prevMonthActual = prevMonth < 0 ? 11 : prevMonth;
                    const daysInPrevMonth = new Date(prevYear, prevMonthActual + 1, 0).getDate();
                    
                    dayNumber = daysInPrevMonth - (firstDayOfWeek - 1 - i);
                    dayDate = new Date(prevYear, prevMonthActual, dayNumber);
                    dayElement.classList.add('other-month');
                    
                } else if (i < firstDayOfWeek + daysInMonth) {
                    dayNumber = i - firstDayOfWeek + 1;
                    dayDate = new Date(year, month, dayNumber);
                    
                } else {
                    const nextMonth = month + 1;
                    const nextYear = nextMonth > 11 ? year + 1 : year;
                    const nextMonthActual = nextMonth > 11 ? 0 : nextMonth;
                    
                    dayNumber = i - firstDayOfWeek - daysInMonth + 1;
                    dayDate = new Date(nextYear, nextMonthActual, dayNumber);
                    dayElement.classList.add('other-month');
                }
                
                dayElement.textContent = dayNumber;
                
                if (dayDate.getDay() === 0 || dayDate.getDay() === 6) {
                    dayElement.classList.add('weekend');
                }
                
                if (isSameDay(dayDate, new Date())) {
                    dayElement.classList.add('today');
                }
                
                if (isSameDay(dayDate, selectedDate)) {
                    dayElement.classList.add('selected');
                }
                
                dayElement.addEventListener('click', () => selectDate(dayDate));
                calendarDays.appendChild(dayElement);
            }
            
            debugLog('‚úÖ Calendario renderizado');
        }

        function selectDate(date) {
            if (isBulkMarking) {
                showNotification('warning', 'Operaci√≥n en Progreso', 'Espera a que termine el marcado masivo antes de cambiar la fecha');
                return;
            }

            debugLog('üìÖ Fecha seleccionada:', date.toISOString().split('T')[0]);
            
            if (date.getMonth() !== currentDate.getMonth() || date.getFullYear() !== currentDate.getFullYear()) {
                currentDate = new Date(date.getFullYear(), date.getMonth(), 1);
            }
            
            selectedDate = new Date(date);
            renderCalendar();
            updateCurrentDate();
            loadAttendanceForDate();
        }

        function changeMonth(delta) {
            if (isBulkMarking) {
                showNotification('warning', 'Operaci√≥n en Progreso', 'Espera a que termine el marcado masivo antes de cambiar la fecha');
                return;
            }

            const newMonth = currentDate.getMonth() + delta;
            const newYear = currentDate.getFullYear();
            
            if (newMonth < 0) {
                currentDate = new Date(newYear - 1, 11, 1);
            } else if (newMonth > 11) {
                currentDate = new Date(newYear + 1, 0, 1);
            } else {
                currentDate = new Date(newYear, newMonth, 1);
            }
            
            renderCalendar();
        }

        function isSameDay(date1, date2) {
            if (!date1 || !date2) return false;
            
            return date1.getDate() === date2.getDate() &&
                date1.getMonth() === date2.getMonth() &&
                date1.getFullYear() === date2.getFullYear();
        }

        function updateCurrentDate() {
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            
            try {
                const dateString = selectedDate.toLocaleDateString('es-ES', options);
                const capitalizedDate = dateString.charAt(0).toUpperCase() + dateString.slice(1);
                document.getElementById('attendanceDate').textContent = capitalizedDate;
            } catch (error) {
                console.error('Error actualizando fecha:', error);
            }
        }

        // ========================================
        // CARGA DE DATOS
        // ========================================
        async function loadFilters() {
            try {
                debugLog('üìã Cargando filtros...');
                
                const gradesResponse = await authenticatedFetch('/api/grades');
                const gradesResult = await gradesResponse.json();
                
                const gradeFilter = document.getElementById('gradeFilter');
                gradeFilter.innerHTML = '<option value="">Seleccionar grado...</option>';
                
                if (gradesResult.success) {
                    gradesResult.data.forEach(grade => {
                        gradeFilter.innerHTML += `<option value="${grade.name}">${grade.name}</option>`;
                    });
                    debugLog('‚úÖ Grados cargados:', gradesResult.data.length);
                    showNotification('success', 'Filtros Cargados', 'Los grados se han cargado correctamente');
                } else {
                    debugLog('‚ö†Ô∏è No se pudieron cargar los grados');
                    showNotification('error', 'Error', 'No se pudieron cargar los grados');
                }
                
            } catch (error) {
                debugLog('‚ùå Error cargando filtros:', error);
                showNotification('error', 'Error de Conexi√≥n', 'Error cargando filtros: ' + error.message);
            }
        }

        async function loadStudents() {
            const grade = document.getElementById('gradeFilter').value;
            
            debugLog('üë• Cargando estudiantes...', { grade });
            
            if (!grade) {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('loadingState').innerHTML = `
                    <div class="loading-spinner"></div>
                    <div style="margin-top: 1rem;">Seleccione grado para cargar estudiantes...</div>
                `;
                document.getElementById('attendanceTable').style.display = 'none';
                return;
            }
            
            currentGrade = grade;
            currentSubject = null; // Ya no usamos filtro de materias
            
            try {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('loadingState').innerHTML = `
                    <div class="loading-spinner"></div>
                    <div style="margin-top: 1rem;">Cargando estudiantes...</div>
                `;
                document.getElementById('attendanceTable').style.display = 'none';
                
                const period = getCurrentAcademicPeriod();
                const url = `/api/students?year=${period.year}&period_type=${period.periodType}&period_number=${period.periodNumber}`;
                const response = await authenticatedFetch(url);
                const result = await response.json();
                
                if (result.success) {
                    students = result.data.filter(student => {
                        const gradeMatch = student.grade_level === grade;
                        const statusMatch = student.status === 'active';
                        
                        return gradeMatch && statusMatch;
                    });
                    
                    debugLog(`‚úÖ Estudiantes filtrados: ${students.length}`, { grade });
                    
                    document.getElementById('attendanceInfo').textContent = 
                        `üìä ${grade} - ${students.length} estudiantes (Todas las materias)`;
                    
                    await loadAttendanceForDate();
                    await loadConfigurationForCurrentGrade();
                    
                    renderStudentsTable();
                    updateStats();
                    
                    if (students.length > 0) {
                        document.getElementById('loadingState').style.display = 'none';
                        document.getElementById('attendanceTable').style.display = 'table';
                        debugLog('‚úÖ Lista de estudiantes cargada correctamente');
                        showNotification('success', 'Estudiantes Cargados', `${students.length} estudiantes cargados para ${grade}`);
                    } else {
                        document.getElementById('loadingState').innerHTML = 
                            `üì≠ No hay estudiantes activos en ${grade}`;
                    }
                    
                } else {
                    document.getElementById('loadingState').innerHTML = '‚ùå Error cargando estudiantes';
                    debugLog('‚ùå Error en respuesta:', result.message);
                    showNotification('error', 'Error', 'Error cargando estudiantes: ' + result.message);
                }
                
            } catch (error) {
                debugLog('‚ùå Error cargando estudiantes:', error);
                document.getElementById('loadingState').innerHTML = '‚ùå Error de conexi√≥n al cargar estudiantes';
                showNotification('error', 'Error de Conexi√≥n', 'Error de conexi√≥n al cargar estudiantes');
            }
        }

        async function loadConfigurationForCurrentGrade() {
            if (!currentGrade) return;
            
            try {
                debugLog('üìö Cargando configuraci√≥n para grado:', currentGrade);
                
                const response = await authenticatedFetch(`/api/lesson-config?grade=${encodeURIComponent(currentGrade)}&subject=general`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const config = result.data;
                    
                    document.getElementById('lessonsPerWeek').value = config.lessons_per_week || 5;
                    document.getElementById('totalWeeks').value = config.total_weeks || 40;
                    
                    const theoreticalTotal = (config.lessons_per_week || 5) * (config.total_weeks || 40);
                    const actualLessons = await getActualLessonsGiven();
                    
                    updateFlexibleLessonInfo(theoreticalTotal, actualLessons, config);
                    
                    debugLog('‚úÖ Configuraci√≥n cargada:', config);
                } else {
                    debugLog('‚ö†Ô∏è No hay configuraci√≥n guardada, usando valores por defecto');
                    updateFlexibleLessonInfo(200, 0, null);
                }
                
            } catch (error) {
                debugLog('‚ùå Error cargando configuraci√≥n:', error);
                updateFlexibleLessonInfo(200, 0, null);
            }
        }

        async function getActualLessonsGiven() {
            if (!currentGrade) return 0;
            
            try {
                const period = getCurrentAcademicPeriod();
                const response = await authenticatedFetch(`/api/attendance/lesson-count?grade=${encodeURIComponent(currentGrade)}&year=${period.year}&period_type=${period.periodType}&period_number=${period.periodNumber}&school_id=${period.schoolId}`);
                const result = await response.json();
                
                if (result.success) {
                    return result.data.total_lessons || 0;
                }
                
                return 0;
            } catch (error) {
                debugLog('‚ùå Error obteniendo lecciones reales:', error);
                return 0;
            }
        }

        function updateFlexibleLessonInfo(theoretical, actual, config) {
            document.getElementById('theoreticalLessons').textContent = theoretical;
            document.getElementById('actualLessons').textContent = actual;
            
            const progress = theoretical > 0 ? Math.round((actual / theoretical) * 100) : 0;
            document.getElementById('progressInfo').textContent = `${progress}%`;
            
            const tipElement = document.getElementById('flexibleTip');
            if (actual > theoretical) {
                tipElement.innerHTML = 'üéØ ¬°Excelente! Has dado m√°s lecciones de las planificadas';
                tipElement.style.background = 'rgba(16, 185, 129, 0.1)';
                tipElement.style.color = '#059669';
                tipElement.style.borderColor = 'rgba(16, 185, 129, 0.2)';
            } else if (actual < theoretical * 0.8) {
                tipElement.innerHTML = '‚ö†Ô∏è Considera ajustar la planificaci√≥n por d√≠as feriados';
                tipElement.style.background = 'rgba(245, 158, 11, 0.1)';
                tipElement.style.color = '#d97706';
                tipElement.style.borderColor = 'rgba(245, 158, 11, 0.2)';
            } else {
                tipElement.innerHTML = 'üí° El sistema se ajusta autom√°ticamente a los d√≠as reales trabajados';
                tipElement.style.background = 'rgba(59, 130, 246, 0.1)';
                tipElement.style.color = '#2563eb';
                tipElement.style.borderColor = 'rgba(59, 130, 246, 0.2)';
            }
        }

        function updateFlexibleCalculation() {
            const lessonsPerWeek = parseInt(document.getElementById('lessonsPerWeek').value) || 5;
            const totalWeeks = parseInt(document.getElementById('totalWeeks').value) || 40;
            const theoretical = lessonsPerWeek * totalWeeks;
            
            document.getElementById('theoreticalLessons').textContent = theoretical;
            
            const actual = parseInt(document.getElementById('actualLessons').textContent) || 0;
            const progress = theoretical > 0 ? Math.round((actual / theoretical) * 100) : 0;
            document.getElementById('progressInfo').textContent = `${progress}%`;
        }

        function recalculateFromReal() {
            const actualLessons = parseInt(document.getElementById('actualLessons').textContent) || 0;
            const lessonsPerWeek = parseInt(document.getElementById('lessonsPerWeek').value) || 5;
            
            if (actualLessons > 0 && lessonsPerWeek > 0) {
                const adjustedWeeks = Math.ceil(actualLessons / lessonsPerWeek);
                document.getElementById('totalWeeks').value = adjustedWeeks;
                document.getElementById('theoreticalLessons').textContent = actualLessons;
                document.getElementById('progressInfo').textContent = '100%';
                
                showNotification('success', 'Configuraci√≥n Ajustada', `‚úÖ Ajustado a ${adjustedWeeks} semanas basado en ${actualLessons} lecciones reales`);
            } else {
                showNotification('info', 'Sin Datos', 'Necesitas registrar asistencia primero para usar esta funci√≥n');
            }
        }

        async function loadAttendanceForDate() {
            if (!currentGrade || students.length === 0) {
                debugLog('‚ö†Ô∏è No se puede cargar asistencia: falta grado o estudiantes');
                return;
            }
            
            studentMEPStats = {};
            
            try {
                const dateStr = selectedDate.toISOString().split('T')[0];
                debugLog('üìä Cargando asistencia para:', { date: dateStr, grade: currentGrade, subject: currentSubject });
                
                const period = getCurrentAcademicPeriod();
                let url = `/api/attendance?date=${dateStr}&grade=${encodeURIComponent(currentGrade)}&year=${period.year}&period_type=${period.periodType}&period_number=${period.periodNumber}&school_id=${period.schoolId}`;
                
                const response = await authenticatedFetch(url);
                const result = await response.json();
                
                attendanceData = {};
                if (result.success && result.data) {
                    debugLog('üîç DATOS CRUDOS del servidor:', result.data);
                    
                    result.data.forEach(record => {
                        const studentKey = record.student_id;
                        attendanceData[studentKey] = record;
                        debugLog(`üìù Asistencia mapeada: key=${studentKey} (code: ${record.student_code}), status=${record.status}, name=${record.first_name}`);
                    });
                    
                    debugLog('‚úÖ Asistencia cargada:', result.data.length, 'registros');
                    debugLog('üìã AttendanceData final:', attendanceData);
                    debugLog('üë• Student IDs disponibles:', students.map(s => `${s.id}(${s.first_name})`));
                    
                    students.forEach(student => {
                        const hasAttendance = !!attendanceData[student.id];
                        const attendanceStatus = attendanceData[student.id]?.status || 'none';
                        debugLog(`üîç Estudiante ${student.id} (${student.first_name}) vs AttendanceKey: ${hasAttendance ? '‚úÖ COINCIDE' : '‚ùå NO COINCIDE'} - Status: ${attendanceStatus}`);
                    });
                    
                } else {
                    debugLog('‚ö†Ô∏è No hay asistencia previa para esta fecha');
                }
                
                renderStudentsTable();
                updateStats();
                
            } catch (error) {
                debugLog('‚ùå Error cargando asistencia:', error);
                showNotification('error', 'Error', 'Error cargando asistencia');
            }
        }

        // ========================================
        // RENDERIZADO DE TABLA
        // ========================================
        async function renderStudentsTable() {
            if (students.length === 0) {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('loadingState').innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                        üìù No hay estudiantes para mostrar
                    </div>
                `;
                document.getElementById('attendanceTable').style.display = 'none';
                return;
            }
            
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('attendanceTable').style.display = 'table';
            
            debugLog('üé® Renderizando tabla con estudiantes:', students.map(s => ({ id: s.id, name: s.first_name })));
            debugLog('üìä Datos de asistencia disponibles:', attendanceData);
            
            studentMEPStats = {};
            
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';
            
            for (const student of students) {
                const attendance = attendanceData[student.id];
                const initials = ((student.first_name?.[0] || '') + (student.first_surname?.[0] || '')).toUpperCase();
                const fullName = `${student.first_surname || ''} ${student.second_surname || ''} ${student.first_name || ''}`.trim();
                
                const status = attendance?.status || 'not_marked';
                const statusText = getStatusText(status);
                const statusClass = getStatusClass(status);
                
                debugLog(`üë§ Estudiante ${student.id} (${student.first_name}):`, {
                    hasAttendance: !!attendance,
                    status: status
                });
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div class="student-photo">${initials}</div>
                            <div>
                                <div class="student-name">${fullName}</div>
                                <div class="student-id">${student.student_id || '-'} (ID: ${student.id})</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="attendance-status ${statusClass}">${statusText}</span>
                    </td>
                    <td>
                        <div class="attendance-controls">
                            <button class="attendance-btn present" onclick="markAttendance(${student.id}, 'present')" title="Presente">
                                ‚úÖ P
                            </button>
                            <button class="attendance-btn late-justified" onclick="markAttendance(${student.id}, 'late_justified')" title="Tard√≠a Justificada">
                                ‚è∞ TJ
                            </button>
                            <button class="attendance-btn late-unjustified" onclick="markAttendance(${student.id}, 'late_unjustified')" title="Tard√≠a Injustificada">
                                üî∂ TI
                            </button>
                            <button class="attendance-btn absent-justified" onclick="markAttendance(${student.id}, 'absent_justified')" title="Ausencia Justificada">
                                üìã AJ
                            </button>
                            <button class="attendance-btn absent-unjustified" onclick="markAttendance(${student.id}, 'absent_unjustified')" title="Ausencia Injustificada">
                                ‚ùå AI
                            </button>
                            <button class="btn btn-info btn-sm" onclick="openJustificationModal(${student.id})" title="Editar">
                                ‚úèÔ∏è
                            </button>
                        </div>
                    </td>
                    <td>${attendance?.arrival_time || '-'}</td>
                    <td>${attendance?.justification || '-'}</td>
                    <td id="stats-${student.id}">
                        <div style="text-align: center; color: var(--gray-500);">
                            <div class="loading-spinner" style="width: 1rem; height: 1rem; margin: 0 auto;"></div>
                            <div style="margin-top: 0.5rem; font-size: 0.75rem;">Calculando...</div>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
                
                getMEPGradeForStudent(student.id).then(mepStats => {
                    const statsCell = document.getElementById(`stats-${student.id}`);
                    if (statsCell) {
                        const attendancePercentage = mepStats.attendance_percentage;
                        const notaAsistencia = mepStats.nota_asistencia;
                        const nota10 = mepStats.nota_0_10;
                        
                        statsCell.innerHTML = `
                            <div style="text-align: center;">
                                <div style="font-weight: 600; color: ${attendancePercentage >= 90 ? 'var(--success)' : attendancePercentage >= 75 ? 'var(--warning)' : 'var(--danger)'};">
                                    ${attendancePercentage.toFixed(1)}%
                                </div>
                                <div style="font-size: 0.75rem; color: var(--gray-600);">
                                    Nota: ${notaAsistencia.toFixed(1)}/${mepStats.max_scale || 5.0}
                                </div>
                                <div style="font-size: 0.625rem; color: var(--gray-500);" title="Nota en escala 0-10 seg√∫n MEP">
                                    (${nota10}/10)
                                </div>
                            </div>
                        `;
                    }
                }).catch(error => {
                    debugLog(`‚ùå Error cargando estad√≠sticas para estudiante ${student.id}:`, error);
                    const statsCell = document.getElementById(`stats-${student.id}`);
                    if (statsCell) {
                        statsCell.innerHTML = `
                            <div style="text-align: center; color: var(--danger);">
                                Error
                            </div>
                        `;
                    }
                });
            }
            
            debugLog('‚úÖ Tabla renderizada con', students.length, 'estudiantes');
        }

        function getStatusText(status) {
            const statusMap = {
                'present': '‚úÖ Presente',
                'late_justified': '‚è∞ Tard√≠a (J)',
                'late_unjustified': 'üî∂ Tard√≠a (I)',
                'absent_justified': 'üìã Ausencia (J)',
                'absent_unjustified': '‚ùå Ausencia (I)',
                'not_marked': '‚≠ï Sin marcar'
            };
            return statusMap[status] || '‚≠ï Sin marcar';
        }

        function getStatusClass(status) {
            const classMap = {
                'present': 'status-present',
                'late_justified': 'status-late-justified',
                'late_unjustified': 'status-late-unjustified',
                'absent_justified': 'status-absent-justified',
                'absent_unjustified': 'status-absent-unjustified',
                'not_marked': 'status-not-marked'
            };
            return classMap[status] || 'status-not-marked';
        }

        // ========================================
        // FUNCIONES DE ASISTENCIA
        // ========================================
        async function markAttendance(studentId, status, date = selectedDate) {
            try {
                debugLog(`üìù Marcando asistencia:`, { studentId, status, grade: currentGrade, subject: currentSubject });
                
                const dateStr = date.toISOString().split('T')[0];
                const now = new Date();
                
                const student = students.find(s => s.id === studentId);
                const subjectArea = student?.subject_area || 'general';
                
                const period = getCurrentAcademicPeriod();
                const attendanceRecord = {
                    student_id: studentId,
                    date: dateStr,
                    status: status,
                    grade_level: currentGrade,
                    subject_area: subjectArea,
                    arrival_time: status.includes('late') ? now.toTimeString().substr(0, 5) : null,
                    justification: null,
                    notes: null,
                    school_id: period.schoolId,
                    year: period.year,
                    period_type: period.periodType,
                    period_number: period.periodNumber
                };
                
                debugLog('üì§ Enviando datos:', attendanceRecord);
                
                const response = await authenticatedFetch('/api/attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(attendanceRecord)
                });
                
                const result = await response.json();
                debugLog('üì• Respuesta del servidor:', result);
                
                if (result.success) {
                    attendanceData[studentId] = {
                        ...attendanceRecord,
                        id: result.data.id,
                        student_id: studentId
                    };
                    
                    delete studentMEPStats[studentId];
                    
                    debugLog('‚úÖ Datos locales actualizados:', attendanceData[studentId]);
                    
                    renderStudentsTable();
                    updateStats();
                    
                    const statusText = getStatusText(status);
                    debugLog(`‚úÖ Asistencia guardada: ${studentId} = ${status}`);
                    showNotification('success', 'Asistencia Guardada', `${statusText} registrado correctamente`);
                } else {
                    debugLog('‚ùå Error del servidor:', result);
                    showNotification('error', 'Error', 'Error: ' + result.message);
                }
            } catch (error) {
                debugLog('‚ùå Error marcando asistencia:', error);
                showNotification('error', 'Error de Conexi√≥n', 'Error de conexi√≥n al guardar asistencia');
            }
        }

        async function markAllStudents(status) {
            if (isBulkMarking) {
                showNotification('warning', 'Operaci√≥n en Progreso', 'El marcado masivo ya est√° en progreso');
                return;
            }

            if (students.length === 0) {
                showNotification('error', 'Sin Estudiantes', 'No hay estudiantes cargados');
                return;
            }
            
            const statusText = getStatusText(status);
            
            showConfirmation({
                icon: 'üë•',
                title: 'Confirmar Marcado Masivo',
                message: `¬øMarcar a todos los ${students.length} estudiantes como "${statusText}"?`,
                confirmText: 'Marcar Todos',
                confirmClass: 'btn-warning',
                onConfirm: () => executeMarkAllStudents(status)
            });
        }

        async function executeMarkAllStudents(status) {
            debugLog(`üìã Marcando todos como: ${status}`);

            const dateSnapshot = new Date(selectedDate);
            isBulkMarking = true;

            try {
                let successCount = 0;
                let errorCount = 0;
                
                showNotification('info', 'Marcado Masivo', 'Procesando estudiantes...');
                
                for (const student of students) {
                    try {
                        await markAttendance(student.id, status, dateSnapshot);
                        successCount++;
                        await new Promise(resolve => setTimeout(resolve, 100));
                    } catch (error) {
                        errorCount++;
                        debugLog(`‚ùå Error marcando estudiante ${student.id}:`, error);
                    }
                }
                
                const statusText = getStatusText(status);
                if (errorCount === 0) {
                    showNotification('success', 'Marcado Completo', `‚úÖ ${successCount} estudiantes marcados como "${statusText}"`);
                } else {
                    showNotification('warning', 'Marcado Parcial', `‚ö†Ô∏è ${successCount} exitosos, ${errorCount} errores`);
                }
                
                debugLog(`üìä Resultado: ${successCount} exitosos, ${errorCount} errores`);
                
            } catch (error) {
                debugLog('‚ùå Error marcando todos:', error);
                showNotification('error', 'Error', 'Error marcando estudiantes');
            } finally {
                isBulkMarking = false;
            }
        }

        async function clearAllAttendance() {
            showConfirmation({
                icon: 'üóëÔ∏è',
                title: 'Eliminar Asistencia',
                message: '¬øEliminar toda la asistencia del d√≠a seleccionado? Esta acci√≥n no se puede deshacer.',
                confirmText: 'Eliminar Todo',
                confirmClass: 'btn-danger',
                onConfirm: () => executeClearAllAttendance()
            });
        }

        async function executeClearAllAttendance() {
            try {
                const dateStr = selectedDate.toISOString().split('T')[0];
                const period = getCurrentAcademicPeriod();
                let url = `/api/attendance?date=${dateStr}&grade=${encodeURIComponent(currentGrade)}&year=${period.year}&period_type=${period.periodType}&period_number=${period.periodNumber}&school_id=${period.schoolId}`;
                if (currentSubject) {
                    url += `&subject=${encodeURIComponent(currentSubject)}`;
                }
                
                debugLog('üóëÔ∏è Eliminando asistencia:', { date: dateStr, grade: currentGrade, subject: currentSubject });
                
                const response = await authenticatedFetch(url, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                debugLog('üì• Respuesta eliminaci√≥n:', result);
                
                if (result.success) {
                    attendanceData = {};
                    renderStudentsTable();
                    updateStats();
                    showNotification('success', 'Asistencia Eliminada', '‚úÖ Asistencia eliminada correctamente');
                } else {
                    showNotification('error', 'Error', 'Error: ' + result.message);
                }
            } catch (error) {
                debugLog('‚ùå Error eliminando asistencia:', error);
                showNotification('error', 'Error', 'Error eliminando asistencia');
            }
        }

        // ========================================
        // ESTAD√çSTICAS Y C√ÅLCULOS MEP
        // ========================================
        async function calculateAttendancePercentage(studentId) {
            try {
                const mepStats = await getMEPGradeForStudent(studentId);
                return mepStats.attendance_percentage;
            } catch (error) {
                debugLog('‚ùå Error calculando porcentaje:', error);
                return 100;
            }
        }
        
        async function getMEPGradeForStudent(studentId) {
            try {
                const config = await getLessonConfigForCurrentSelection();
                const totalLessons = config?.total_lessons || 200;
                
                // Buscar en cache primero
                if (studentMEPStats[studentId] && studentMEPStats[studentId].total_lessons === totalLessons) {
                    debugLog(`üìà Usando cache para estudiante ${studentId}`);
                    return studentMEPStats[studentId];
                }
                
                // Construir URL con par√°metros correctos
                const period = getCurrentAcademicPeriod();
                const params = new URLSearchParams({
                    grade: currentGrade,
                    subject: currentSubject || 'general',
                    totalLessons: totalLessons.toString(),
                    year: period.year,
                    period_type: period.periodType,
                    period_number: period.periodNumber,
                    school_id: period.schoolId
                });
                
                const url = `/api/attendance/stats/${studentId}?${params.toString()}`;
                debugLog(`üîç Llamando API: ${url}`);
                
                // Hacer la petici√≥n
                const response = await authenticatedFetch(url);
                debugLog(`üì° Respuesta HTTP: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                debugLog(`üìã Resultado completo:`, result);
                
                if (result.success && result.data) {
                    // Guardar en cache
                    studentMEPStats[studentId] = result.data;
                    debugLog(`‚úÖ Estad√≠sticas MEP obtenidas para estudiante ${studentId}:`, result.data);
                    return result.data;
                } else {
                    throw new Error(result.message || 'Respuesta sin datos');
                }
                
            } catch (error) {
                debugLog(`‚ùå Error detallado obteniendo estad√≠sticas MEP para estudiante ${studentId}:`, {
                    error: error.message,
                    stack: error.stack,
                    currentGrade: currentGrade,
                    currentSubject: currentSubject,
                    studentId: studentId
                });
                
                // Devolver datos por defecto en caso de error
                return {
                    attendance_percentage: 100,
                    nota_asistencia: 5.0,
                    nota_0_10: 10,
                    absence_percentage: 0,
                    total_lessons: 200,
                    error: error.message
                };
            }
        }

        function updateStats() {
            const stats = {
                present: 0,
                lateJustified: 0,
                lateUnjustified: 0,
                absentJustified: 0,
                absentUnjustified: 0,
                notMarked: 0
            };
            
            debugLog('üë• Estudiantes para estad√≠sticas:', students.length);
            debugLog('üìä AttendanceData disponible:', Object.keys(attendanceData));
            
            students.forEach(student => {
                const attendance = attendanceData[student.id];
                const status = attendance?.status || 'not_marked';
                
                debugLog(`üìù Estudiante ${student.id} (${student.first_name}): ${status}`);
                
                switch (status) {
                    case 'present': stats.present++; break;
                    case 'late_justified': stats.lateJustified++; break;
                    case 'late_unjustified': stats.lateUnjustified++; break;
                    case 'absent_justified': stats.absentJustified++; break;
                    case 'absent_unjustified': stats.absentUnjustified++; break;
                    default: stats.notMarked++; break;
                }
            });
            
            document.getElementById('statPresent').textContent = stats.present;
            document.getElementById('statLateJustified').textContent = stats.lateJustified;
            document.getElementById('statLateUnjustified').textContent = stats.lateUnjustified;
            document.getElementById('statAbsentJustified').textContent = stats.absentJustified;
            document.getElementById('statAbsentUnjustified').textContent = stats.absentUnjustified;
            document.getElementById('statNotMarked').textContent = stats.notMarked;
            
            debugLog('üìä Estad√≠sticas finales:', stats);
        }

        // ========================================
        // CONFIGURACI√ìN DE LECCIONES
        // ========================================
        function calculateTotalLessons() {
            const lessonsInput = document.getElementById('lessonsPerWeek');
            const weeksInput = document.getElementById('totalWeeks');
            const lessonsPerWeek = parseInt(lessonsInput ? lessonsInput.value : 5) || 5;
            const totalWeeks = parseInt(weeksInput ? weeksInput.value : 40) || 40;
            const totalLessons = lessonsPerWeek * totalWeeks;

            const totalLessonsElement = document.getElementById('totalLessons');
            if (totalLessonsElement) {
                totalLessonsElement.textContent = totalLessons;
            }
            lessonConfig.totalLessons = totalLessons;

            const configLessonsPerWeek = document.getElementById('configLessonsPerWeek');
            const configTotalWeeks = document.getElementById('configTotalWeeks');
            const calculated = document.getElementById('calculatedLessons');
            if (configLessonsPerWeek && configTotalWeeks && calculated) {
                const modalLessons = (parseInt(configLessonsPerWeek.value) || 0) * (parseInt(configTotalWeeks.value) || 0);
                calculated.textContent = modalLessons;
            }
        }

        async function saveLessonConfig() {
            if (!currentGrade) {
                showNotification('error', 'Error', 'Seleccione un grado primero');
                return;
            }
            
            try {
                const period = getCurrentAcademicPeriod();
                const configData = {
                    grade_level: currentGrade,
                    subject_area: 'general',
                    lessons_per_week: parseInt(document.getElementById('lessonsPerWeek').value),
                    total_weeks: parseInt(document.getElementById('totalWeeks').value),
                    teacher_name: null,
                    year: period.year,
                    period_type: period.periodType,
                    period_number: period.periodNumber
                };
                
                const response = await authenticatedFetch('/api/lesson-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('success', 'Configuraci√≥n Guardada', '‚úÖ Configuraci√≥n guardada correctamente');
                } else {
                    showNotification('error', 'Error', 'Error: ' + result.message);
                }
            } catch (error) {
                debugLog('Error guardando configuraci√≥n:', error);
                showNotification('error', 'Error', 'Error guardando configuraci√≥n');
            }
        }

        // ========================================
        // MODALES
        // ========================================
        function openJustificationModal(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            currentStudentId = studentId;
            const fullName = `${student.first_surname || ''} ${student.second_surname || ''} ${student.first_name || ''}`.trim();
            
            document.getElementById('justificationStudent').textContent = fullName;
            
            const attendance = attendanceData[studentId];
            if (attendance) {
                document.getElementById('justificationStatus').value = attendance.status;
                document.getElementById('justificationTime').value = attendance.arrival_time || '';
                document.getElementById('justificationText').value = attendance.justification || '';
            } else {
                document.getElementById('justificationForm').reset();
            }
            
            document.getElementById('justificationModal').classList.add('show');
        }

        function closeJustificationModal() {
            document.getElementById('justificationModal').classList.remove('show');
            currentStudentId = null;
        }

        async function saveJustification(event) {
            event.preventDefault();
            
            if (!currentStudentId) return;
            
            try {
                const dateStr = selectedDate.toISOString().split('T')[0];
                const student = students.find(s => s.id === currentStudentId);
                const subjectArea = currentSubject || student?.subject_area || 'general';
                
                const period = getCurrentAcademicPeriod();
                const attendanceRecord = {
                    student_id: currentStudentId,
                    date: dateStr,
                    status: document.getElementById('justificationStatus').value,
                    arrival_time: document.getElementById('justificationTime').value || null,
                    justification: document.getElementById('justificationText').value || null,
                    grade_level: currentGrade,
                    subject_area: subjectArea,
                    school_id: period.schoolId,
                    year: period.year,
                    period_type: period.periodType,
                    period_number: period.periodNumber
                };
                
                const response = await authenticatedFetch('/api/attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(attendanceRecord)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    attendanceData[currentStudentId] = {
                        ...attendanceRecord,
                        id: result.data.id
                    };
                    
                    renderStudentsTable();
                    updateStats();
                    closeJustificationModal();
                    showNotification('success', 'Asistencia Actualizada', '‚úÖ Asistencia guardada correctamente');
                } else {
                    showNotification('error', 'Error', 'Error: ' + result.message);
                }
            } catch (error) {
                debugLog('Error guardando justificaci√≥n:', error);
                showNotification('error', 'Error', 'Error guardando asistencia');
            }
        }

        function openLessonConfigModal() {
            if (!currentGrade) {
                showNotification('error', 'Error', 'Seleccione un grado primero');
                return;
            }
            
            document.getElementById('lessonConfigModal').classList.add('show');
            loadCurrentScale();
        }

        async function loadCurrentScale() {
            try {
                if (!currentGrade) {
                    document.getElementById('maxScaleInput').value = 5.0;
                    debugLog('‚ö†Ô∏è No hay grado seleccionado, usando escala por defecto');
                    return;
                }

                const response = await authenticatedFetch(`/api/grade-scale?grade=${encodeURIComponent(currentGrade)}&subject=general`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('maxScaleInput').value = data.max_scale;
                    debugLog(`‚úÖ Escala cargada: ${data.max_scale}`);
                } else {
                    document.getElementById('maxScaleInput').value = 5.0;
                    debugLog('‚ö†Ô∏è No se encontr√≥ escala, usando 5.0 por defecto');
                }
            } catch (error) {
                console.error('Error cargando escala:', error);
                document.getElementById('maxScaleInput').value = 5.0;
                debugLog('‚ùå Error cargando escala, usando 5.0 por defecto');
            }
        }

        function closeLessonConfigModal() {
            document.getElementById('lessonConfigModal').classList.remove('show');
        }

        async function saveLessonConfigModal(event) {
            event.preventDefault();
            
            try {
                const maxScale = parseFloat(document.getElementById('maxScaleInput').value);
                const attendanceWeight = maxScale;
                
                if (!currentGrade) {
                    showNotification('error', 'Error', 'Seleccione un grado primero');
                    return;
                }
                
                const scaleResponse = await authenticatedFetch('/api/grade-scale', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        grade: currentGrade,
                        subject: currentSubject || 'general',
                        maxScale: maxScale
                    })
                });
                
                const scaleResult = await scaleResponse.json();

                if (scaleResult.success) {
                    const period = getCurrentAcademicPeriod();
                    await authenticatedFetch('/api/sea/weights', {
                        method: 'PUT',
                        body: JSON.stringify({
                            attendance_weight: attendanceWeight,
                            academic_period_id: period.periodId,
                            school_id: period.schoolId
                        })
                    }).catch(err => console.error('Error guardando peso:', err));

                    showNotification('success', 'Configuraci√≥n Guardada', '‚úÖ Configuraci√≥n de nota guardada correctamente');
                    closeLessonConfigModal();
                    
                    if (typeof showClassStats === 'function') {
                        showClassStats();
                    }
                } else {
                    showNotification('error', 'Error', 'Error guardando configuraci√≥n: ' + scaleResult.message);
                }
                
            } catch (error) {
                debugLog('Error guardando configuraci√≥n:', error);
                showNotification('error', 'Error', 'Error guardando configuraci√≥n: ' + error.message);
            }
        }

        async function getLessonConfigForCurrentSelection() {
            try {
                if (!currentGrade) {
                    debugLog('‚ö†Ô∏è No hay grado seleccionado para configuraci√≥n');
                    return null;
                }
                
                const period = getCurrentAcademicPeriod();
                const params = new URLSearchParams({
                    grade: currentGrade,
                    subject: currentSubject || 'general',
                    year: period.year,
                    period_type: period.periodType,
                    period_number: period.periodNumber
                });
                
                const url = `/api/lesson-config?${params.toString()}`;
                debugLog(`üîç Obteniendo configuraci√≥n: ${url}`);
                
                const response = await authenticatedFetch(url);
                
                if (!response.ok) {
                    debugLog(`‚ö†Ô∏è Error HTTP obteniendo configuraci√≥n: ${response.status}`);
                    return null;
                }
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    debugLog(`‚úÖ Configuraci√≥n obtenida:`, result.data);
                    return result.data;
                } else {
                    debugLog(`‚ö†Ô∏è Configuraci√≥n no disponible, usando defaults`);
                    return null;
                }
                
            } catch (error) {
                debugLog('‚ùå Error obteniendo configuraci√≥n de lecciones:', error);
                return null;
            }
        }

        function exportAttendance() {
            showNotification('info', 'Funci√≥n en Desarrollo', 'üìÑ Funci√≥n de exportar en desarrollo');
        }

        function exportClassStats() {
            showNotification('info', 'Funci√≥n en Desarrollo', 'üìä Funci√≥n de exportar estad√≠sticas en desarrollo');
        }

        // ========================================
        // ESTAD√çSTICAS DE CLASE MEP
        // ========================================
        async function showClassStats() {
            if (!currentGrade) {
                showNotification('error', 'Error', 'Seleccione un grado primero');
                return;
            }
            
            try {
                const config = await getLessonConfigForCurrentSelection();
                const totalLessons = config?.total_lessons || 200;
                
                showNotification('info', 'Calculando Estad√≠sticas', 'üìä Calculando estad√≠sticas MEP...');
                
                const period = getCurrentAcademicPeriod();
                const response = await authenticatedFetch(`/api/attendance/class-stats?grade=${encodeURIComponent(currentGrade)}&subject=${encodeURIComponent(currentSubject || 'general')}&totalLessons=${totalLessons}&year=${period.year}&period_type=${period.periodType}&period_number=${period.periodNumber}&school_id=${period.schoolId}`);
                const result = await response.json();
                
                if (result.success) {
                    displayClassStatsModal(result.data, result.summary, config);
                } else {
                    showNotification('error', 'Error', 'Error: ' + result.message);
                }
            } catch (error) {
                debugLog('‚ùå Error obteniendo estad√≠sticas de clase:', error);
                showNotification('error', 'Error', 'Error obteniendo estad√≠sticas de clase');
            }
        }
        
        function displayClassStatsModal(classStats, summary, config) {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
                    <div class="modal-header">
                        <h2 class="modal-title">üìä Estad√≠sticas MEP - ${currentGrade}</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <!-- Resumen general -->
                        <div style="background: var(--gray-50); border-radius: var(--radius-xl); padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--gray-200);">
                            <h3 style="margin-bottom: 1rem; color: var(--gray-900);">üìà Resumen General</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div style="text-align: center; padding: 1rem; background: white; border-radius: var(--radius-lg); border: 1px solid var(--gray-200);">
                                    <div style="font-size: 1.75rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem;">${classStats.length}</div>
                                    <div style="color: var(--gray-600); font-size: 0.75rem; text-transform: uppercase; font-weight: 500;">ESTUDIANTES</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: white; border-radius: var(--radius-lg); border: 1px solid var(--gray-200);">
                                    <div style="font-size: 1.75rem; font-weight: 700; color: var(--success); margin-bottom: 0.5rem;">${summary.average_attendance.toFixed(1)}%</div>
                                    <div style="color: var(--gray-600); font-size: 0.75rem; text-transform: uppercase; font-weight: 500;">ASISTENCIA PROMEDIO</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: white; border-radius: var(--radius-lg); border: 1px solid var(--gray-200);">
                                    <div style="font-size: 1.75rem; font-weight: 700; color: var(--success); margin-bottom: 0.5rem;">${summary.average_grade.toFixed(1)}/${summary.max_scale || 5.0}</div>
                                    <div style="color: var(--gray-600); font-size: 0.75rem; text-transform: uppercase; font-weight: 500;">NOTA PROMEDIO</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: white; border-radius: var(--radius-lg); border: 1px solid var(--gray-200);">
                                    <div style="font-size: 1.75rem; font-weight: 700; color: var(--info); margin-bottom: 0.5rem;">${config?.total_lessons || 200}</div>
                                    <div style="color: var(--gray-600); font-size: 0.75rem; text-transform: uppercase; font-weight: 500;">LECCIONES TOTAL</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabla de estudiantes -->
                        <h3 style="margin-bottom: 1rem; color: var(--gray-900);">üë• Detalle por Estudiante</h3>
                        <div style="overflow-x: auto; border: 1px solid var(--gray-200); border-radius: var(--radius-lg);">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                <thead>
                                    <tr style="background: var(--gray-50);">
                                        <th style="padding: 1rem; border-bottom: 1px solid var(--gray-200); text-align: left; font-weight: 600;">Estudiante</th>
                                        <th style="padding: 1rem; border-bottom: 1px solid var(--gray-200); text-align: center; font-weight: 600;">Asistencia</th>
                                        <th style="padding: 1rem; border-bottom: 1px solid var(--gray-200); text-align: center; font-weight: 600;">Ausencias</th>
                                        <th style="padding: 1rem; border-bottom: 1px solid var(--gray-200); text-align: center; font-weight: 600;">Nota 0-10</th>
                                        <th style="padding: 1rem; border-bottom: 1px solid var(--gray-200); text-align: center; font-weight: 600;">Nota Final</th>
                                        <th style="padding: 1rem; border-bottom: 1px solid var(--gray-200); text-align: center; font-weight: 600;">Registros</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${classStats.map(student => {
                                        const stats = student.mep_stats;
                                        return `
                                            <tr style="border-bottom: 1px solid var(--gray-100);">
                                                <td style="padding: 1rem;">
                                                    <div style="font-weight: 600; color: var(--gray-900);">${student.first_surname} ${student.second_surname}, ${student.first_name}</div>
                                                    <div style="font-size: 0.75rem; color: var(--gray-500);">${student.student_id}</div>
                                                </td>
                                                <td style="padding: 1rem; text-align: center;">
                                                    <span style="color: ${stats.attendance_percentage >= 90 ? 'var(--success)' : stats.attendance_percentage >= 75 ? 'var(--warning)' : 'var(--danger)'}; font-weight: 600;">
                                                        ${stats.attendance_percentage.toFixed(1)}%
                                                    </span>
                                                </td>
                                                <td style="padding: 1rem; text-align: center;">
                                                    ${stats.total_absences.toFixed(1)} / ${stats.total_lessons}
                                                </td>
                                                <td style="padding: 1rem; text-align: center; font-weight: 600;">
                                                    ${stats.nota_0_10}/10
                                                </td>
                                                <td style="padding: 1rem; text-align: center;">
                                                    <span style="color: ${stats.nota_asistencia >= 4 ? 'var(--success)' : stats.nota_asistencia >= 3 ? 'var(--warning)' : 'var(--danger)'}; font-weight: 600;">
                                                        ${stats.nota_asistencia.toFixed(1)}/${stats.max_scale || 5.0}
                                                    </span>
                                                </td>
                                                <td style="padding: 1rem; text-align: center; font-size: 0.75rem;">
                                                    <div>P:${stats.stats.present} | TJ:${stats.stats.late_justified} | TI:${stats.stats.late_unjustified}</div>
                                                    <div>AJ:${stats.stats.absent_justified} | AI:${stats.stats.absent_unjustified}</div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Explicaci√≥n de la f√≥rmula MEP -->
                        <div style="background: rgba(59, 130, 246, 0.05); border-radius: var(--radius-lg); padding: 1.5rem; margin-top: 2rem; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <h4 style="color: var(--info); margin-bottom: 1rem;">üìã F√≥rmula MEP Aplicada</h4>
                            <div style="color: var(--gray-700); line-height: 1.6;">
                                <p style="margin: 0.5rem 0;"><strong>1.</strong> Ausencias = Ausencias Injustificadas + (Tard√≠as √ó 0.5)</p>
                                <p style="margin: 0.5rem 0;"><strong>2.</strong> % Ausencias = (Ausencias √∑ Total Lecciones) √ó 100</p>
                                <p style="margin: 0.5rem 0;"><strong>3.</strong> Nota 0-10 seg√∫n tabla oficial MEP</p>
                                <p style="margin: 0.5rem 0;"><strong>4.</strong> Nota Final = Nota 0-10 √ó Escala (${summary.max_scale || 5.0}/10)</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cerrar</button>
                        <button class="btn btn-success" onclick="exportClassStats()">üìÑ Exportar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cerrar al hacer clic fuera
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.remove();
                }
            });
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================
        document.addEventListener('click', function(event) {
            // Cerrar modales al hacer clic fuera
            if (event.target.classList.contains('modal')) {
                if (event.target.id === 'justificationModal') {
                    closeJustificationModal();
                } else if (event.target.id === 'lessonConfigModal') {
                    closeLessonConfigModal();
                } else if (event.target.id === 'confirmationModal') {
                    closeConfirmationModal();
                }
            }
        });

        // Event listeners para inputs de configuraci√≥n
        const lpwInput = document.getElementById('lessonsPerWeek');
        if (lpwInput) lpwInput.addEventListener('input', calculateTotalLessons);

        const twInput = document.getElementById('totalWeeks');
        if (twInput) twInput.addEventListener('input', calculateTotalLessons);

        // ===============================
        // INDICADOR DE PER√çODO
        // ===============================
        class SimplePeriodIndicator {
            constructor() {
                this.init();
            }

            init() {
                this.updateDisplay();
                this.setupEventListeners();
                console.log('üìÖ Indicador simple de per√≠odo inicializado');
            }

            setupEventListeners() {
                window.addEventListener('academicPeriodChanged', () => {
                    console.log('üìÖ Per√≠odo cambi√≥, actualizando indicador...');
                    this.updateDisplay();
                    this.reloadPageData();
                });

                window.addEventListener('reloadPeriodData', () => {
                    console.log('üîÑ Recargando datos por cambio de per√≠odo...');
                    this.updateDisplay();
                    this.reloadPageData();
                });
            }

            updateDisplay() {
                const display = document.getElementById('activePeriodDisplay');
                if (!display) return;

                try {
                    const currentPeriod = getCurrentAcademicPeriod();
                    const teacherData = this.getTeacherInfo();
                    const periodText = this.buildPeriodText(currentPeriod, teacherData);
                    display.textContent = periodText;
                    this.updateBannerState('active');
                } catch (error) {
                    console.error('Error actualizando indicador de per√≠odo:', error);
                    display.textContent = 'Error cargando per√≠odo acad√©mico';
                    this.updateBannerState('error');
                }
            }

            getTeacherInfo() {
                const teacherData = sessionStorage.getItem('teacherData');
                if (teacherData) {
                    try {
                        const teacher = JSON.parse(teacherData);
                        return {
                            name: teacher.name || teacher.full_name || 'Profesor',
                            school: teacher.school || teacher.school_name || 'Mi Escuela'
                        };
                    } catch (error) {
                        console.warn('Error parseando datos del profesor:', error);
                    }
                }
                return { name: 'Profesor', school: 'Mi Escuela' };
            }

            buildPeriodText(period, teacher) {
                const periodTypeName = period.periodType === 'semester' ? 'Semestre' : 'Trimestre';
                const periodNumber = period.periodNumber === 1 ? 'Primer' :
                                    period.periodNumber === 2 ? 'Segundo' : 'Tercer';
                return `${teacher.name} - ${period.year} - ${periodNumber} ${periodTypeName} - ${teacher.school}`;
            }

            updateBannerState(state) {
                const banner = document.querySelector('.period-indicator');
                if (!banner) return;
                banner.classList.remove('loading', 'error', 'outdated');
                if (state !== 'active') {
                    banner.classList.add(state);
                }
            }

            reloadPageData() {
                if (typeof window.loadStudents === 'function') {
                    console.log('üîÑ Recargando estudiantes...');
                    window.loadStudents();
                }

                if (typeof window.loadAttendance === 'function') {
                    console.log('üîÑ Recargando asistencia...');
                    window.loadAttendance();
                }
            }
        }

        // Inicializar indicador de per√≠odo cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                window.simplePeriodIndicator = new SimplePeriodIndicator();
            });
        } else {
            window.simplePeriodIndicator = new SimplePeriodIndicator();
        }

        window.updatePeriodIndicator = function() {
            if (window.simplePeriodIndicator) {
                window.simplePeriodIndicator.updateDisplay();
            }
        };

        // Exponer funciones para recarga externa
        window.loadStudents = loadStudents;
        window.loadAttendance = loadAttendanceForDate;
        window.loadAttendanceData = loadAttendanceForDate;
    </script>
    <script src="js/global-period-selector.js"></script>
</body>
</html>