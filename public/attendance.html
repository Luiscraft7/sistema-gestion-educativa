<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÖ M√≥dulo de Asistencias - Sistema Educativo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .header p {
            color: #666;
            font-size: 14px;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-purple { background: #6f42c1; color: white; }
        
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .card-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }
        
        .card-body {
            padding: 20px;
        }
        
        /* ========================================
           CALENDARIO - CSS COMPLETAMENTE CORREGIDO
           ======================================== */
        .calendar-container {
            text-align: center;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-nav {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .calendar-nav:hover {
            background: #5a6fd8;
        }
        
        .calendar-month-year {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .calendar-wrapper {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1px;
            overflow: hidden;
        }

        .calendar-days-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #667eea;
        }

        .calendar-day-header {
            padding: 12px 8px;
            color: white;
            font-size: 12px;
            font-weight: 700;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendar-days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #e9ecef;
            gap: 1px;
        }

        .calendar-day {
            background: white;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            min-height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            position: relative;
        }

        .calendar-day:hover {
            background: #e3f2fd !important;
            transform: scale(1.05);
            z-index: 2;
        }

        .calendar-day.other-month {
            color: #adb5bd;
            background: #f8f9fa;
            font-weight: 400;
        }

        .calendar-day.other-month:hover {
            background: #e9ecef !important;
        }

        .calendar-day.selected {
            background: #667eea !important;
            color: white !important;
            font-weight: 700;
            box-shadow: 0 0 0 2px #667eea;
        }

        .calendar-day.today {
            background: #28a745 !important;
            color: white !important;
            font-weight: 700;
        }

        .calendar-day.today::after {
            content: '‚óè';
            position: absolute;
            bottom: 4px;
            right: 6px;
            font-size: 8px;
        }

        .calendar-day.weekend {
            background: #fff5f5 !important;
        }

        .calendar-day.weekend:hover {
            background: #fed7d7 !important;
        }

        .calendar-day.has-attendance {
            border: 2px solid #ffc107;
        }

        .calendar-day.has-attendance::before {
            content: 'üìù';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 8px;
        }
        
        /* Filtros */
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }
        
        .filter-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* Panel de configuraci√≥n de lecciones */
        .lesson-config {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .config-input {
            width: 80px;
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        
        /* √Årea principal de asistencia */
        .attendance-main {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .attendance-header {
            padding: 25px;
            border-bottom: 1px solid #eee;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .attendance-date {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .attendance-info {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* ========================================
           BOTONES DE ESTADO MEJORADOS
           ======================================== */
        .quick-actions {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .quick-actions-title {
            font-weight: 600;
            color: #333;
            margin-right: 15px;
        }
        
        .status-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* ‚úÖ NUEVOS ESTILOS MEJORADOS PARA ESTADOS */
        .status-btn.present { 
            background: linear-gradient(135deg, #28a745, #20c997); 
            color: white; 
            border: 2px solid #1e7e34;
        }
        .status-btn.late-justified { 
            background: linear-gradient(135deg, #ffc107, #ffca2c); 
            color: #212529; 
            border: 2px solid #d39e00;
        }
        .status-btn.late-unjustified { 
            background: linear-gradient(135deg, #fd7e14, #ff8c42); 
            color: white; 
            border: 2px solid #dc6002;
        }
        .status-btn.absent-justified { 
            background: linear-gradient(135deg, #17a2b8, #20c997); 
            color: white; 
            border: 2px solid #117a8b;
        }
        .status-btn.absent-unjustified { 
            background: linear-gradient(135deg, #dc3545, #e74c3c); 
            color: white; 
            border: 2px solid #bd2130;
        }
        
        .status-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        
        .status-btn:active {
            transform: translateY(-1px);
        }
        
        /* Tabla de estudiantes */
        .students-table {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        .student-photo {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        .student-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }
        
        .student-id {
            color: #666;
            font-size: 11px;
        }
        
        /* ========================================
           CONTROLES DE ASISTENCIA MEJORADOS
           ======================================== */
        .attendance-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .attendance-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            min-width: 70px;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .attendance-btn.present { 
            background: linear-gradient(135deg, #28a745, #20c997); 
            color: white; 
        }
        .attendance-btn.late-justified { 
            background: linear-gradient(135deg, #ffc107, #ffca2c); 
            color: #212529; 
        }
        .attendance-btn.late-unjustified { 
            background: linear-gradient(135deg, #fd7e14, #ff8c42); 
            color: white; 
        }
        .attendance-btn.absent-justified { 
            background: linear-gradient(135deg, #17a2b8, #20c997); 
            color: white; 
        }
        .attendance-btn.absent-unjustified { 
            background: linear-gradient(135deg, #dc3545, #e74c3c); 
            color: white; 
        }
        
        .attendance-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .attendance-status {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            min-width: 90px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .status-present { 
            background: linear-gradient(135deg, #d4edda, #c3e6cb); 
            color: #155724; 
            border: 1px solid #c3e6cb;
        }
        .status-late-justified { 
            background: linear-gradient(135deg, #fff3cd, #ffeaa7); 
            color: #856404; 
            border: 1px solid #ffeaa7;
        }
        .status-late-unjustified { 
            background: linear-gradient(135deg, #f8d7da, #f5c6cb); 
            color: #721c24; 
            border: 1px solid #f5c6cb;
        }
        .status-absent-justified { 
            background: linear-gradient(135deg, #d1ecf1, #bee5eb); 
            color: #0c5460; 
            border: 1px solid #bee5eb;
        }
        .status-absent-unjustified { 
            background: linear-gradient(135deg, #f5c6cb, #f1b0b7); 
            color: #721c24; 
            border: 1px solid #f1b0b7;
        }
        .status-not-marked { 
            background: linear-gradient(135deg, #e9ecef, #dee2e6); 
            color: #495057; 
            border: 1px solid #dee2e6;
        }
        
        /* Panel de estad√≠sticas */
        .stats-panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-top: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 25px;
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
        }
        
        /* Debug panel */
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            max-width: 300px;
            z-index: 9999;
            display: none;
        }
        
        .debug-panel.show {
            display: block;
        }
        
        /* Responsivo */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: 2;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .quick-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .attendance-controls {
                flex-direction: column;
            }
            
            .calendar-day {
                padding: 8px 4px;
                font-size: 12px;
                min-height: 35px;
            }
            
            .calendar-day-header {
                padding: 8px 4px;
                font-size: 10px;
            }
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-input, .form-textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        /* Success/Error messages */
        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message.show {
            display: block;
        }

        /* INDICADOR SIMPLE DE PER√çODO ACAD√âMICO */
        .period-indicator-banner {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            margin: 15px 0 25px 0;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .period-icon {
            font-size: 20px;
            color: rgba(255, 255, 255, 0.9);
        }

        .period-text {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .period-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .period-info {
            font-size: 16px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .period-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .period-badge .pulse {
            color: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .period-indicator-banner {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .period-text {
                align-items: center;
            }

            .period-info {
                font-size: 14px;
            }
        }

        /* Variantes de color para diferentes estados */
        .period-indicator-banner.loading {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }

        .period-indicator-banner.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .period-indicator-banner.outdated {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>üìÖ M√≥dulo de Asistencias</h1>
                <p>Control de asistencia seg√∫n reglamentos del MEP</p>

                <div class="period-indicator-banner">
                    <div class="period-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="period-text">
                        <span class="period-label">Per√≠odo Acad√©mico Activo:</span>
                        <span class="period-info" id="activePeriodDisplay">2025 - Primer Semestre - Escuela Las Flores</span>
                    </div>
                    <div class="period-badge">
                        <i class="fas fa-circle pulse"></i>
                        <span>Activo</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-info" onclick="openLessonConfigModal()">
                    ‚öôÔ∏è Configuraci√≥n de la nota
                </button>
                <button class="btn btn-purple" onclick="showClassStats()">
                    üìä Estad√≠sticas MEP
                </button>
                <button class="btn btn-success" onclick="exportAttendance()">
                    üìÑ Exportar Reportes
                </button>
                <button class="btn btn-warning" onclick="toggleDebug()">
                    üêõ Debug
                </button>
                <a href="dashboard.html" class="btn btn-secondary">
                    ‚Üê Dashboard
                </a>
            </div>
        </div>

        <!-- Mensajes -->
        <div id="successMessage" class="message success">‚úÖ Operaci√≥n completada exitosamente</div>
        <div id="errorMessage" class="message error">‚ùå Error en la operaci√≥n</div>

        <!-- Contenido Principal -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Calendario -->
                <div class="card">
                    <div class="card-header">
                        üìÖ Seleccionar Fecha
                    </div>
                    <div class="card-body">
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <button class="calendar-nav" onclick="changeMonth(-1)">‚Äπ</button>
                                <div class="calendar-month-year" id="calendarMonthYear">
                                    Mayo 2025
                                </div>
                                <button class="calendar-nav" onclick="changeMonth(1)">‚Ä∫</button>
                            </div>
                            <div class="calendar-wrapper">
                                <div class="calendar-days-header">
                                    <div class="calendar-day-header">Dom</div>
                                    <div class="calendar-day-header">Lun</div>
                                    <div class="calendar-day-header">Mar</div>
                                    <div class="calendar-day-header">Mi√©</div>
                                    <div class="calendar-day-header">Jue</div>
                                    <div class="calendar-day-header">Vie</div>
                                    <div class="calendar-day-header">S√°b</div>
                                </div>
                                <div class="calendar-days-grid" id="calendarDays">
                                    <!-- Los d√≠as se generan aqu√≠ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="card">
                    <div class="card-header">
                        üéØ Filtros
                    </div>
                    <div class="card-body">
                        <div class="filter-group">
                            <label class="filter-label">Grado:</label>
                            <select class="filter-select" id="gradeFilter" onchange="loadStudents()">
                                <option value="">Seleccionar grado...</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-primary" style="width: 100%;" onclick="loadStudents()">
                                üîÑ Actualizar Lista
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Configuraci√≥n de Lecciones MEJORADA -->
                <div class="card">
                    <div class="card-header">
                        üìö Configuraci√≥n Flexible
                    </div>
                    <div class="card-body">
                        <div class="lesson-config">
                            <div class="config-item">
                                <span>Lecciones/semana:</span>
                                <input type="number" class="config-input" id="lessonsPerWeek" value="5" min="1" max="10" onchange="updateFlexibleCalculation()">
                            </div>
                            <div class="config-item">
                                <span>Semanas planificadas:</span>
                                <input type="number" class="config-input" id="totalWeeks" value="40" min="1" max="52" onchange="updateFlexibleCalculation()">
                            </div>
                            <div class="config-item">
                                <span><strong>Total te√≥rico:</strong></span>
                                <span id="theoreticalLessons" style="color: #666;">200</span>
                            </div>
                            <div class="config-item">
                                <span><strong>Lecciones reales:</strong></span>
                                <span id="actualLessons" style="color: #27ae60; font-weight: bold;">0</span>
                            </div>
                            <div class="config-item">
                                <span><strong>Progreso:</strong></span>
                                <span id="progressInfo" style="color: #667eea;">0%</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-primary btn-sm" style="flex: 1;" onclick="saveLessonConfig()">
                                üíæ Guardar Config
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="recalculateFromReal()">
                                üîÑ Usar Real
                            </button>
                        </div>
                        <div id="flexibleTip" style="margin-top: 10px; padding: 8px; background: #e8f4fd; border-radius: 5px; font-size: 12px; color: #2c5aa0;">
                            üí° El sistema se ajusta autom√°ticamente a los d√≠as reales trabajados
                        </div>
                    </div>
                </div>
            </div>
            <!-- √Årea Principal -->
            <div class="attendance-main">
                <!-- Header de Asistencia -->
                <div class="attendance-header">
                    <div class="attendance-date" id="attendanceDate">
                        S√°bado, 31 de Mayo de 2025
                    </div>
                    <div class="attendance-info" id="attendanceInfo">
                        Seleccione grado para comenzar
                    </div>
                </div>

                <!-- Acciones R√°pidas -->
                <div class="quick-actions">
                    <span class="quick-actions-title">‚ö° Acciones R√°pidas:</span>
                    <button class="status-btn present" onclick="markAllStudents('present')">
                        ‚úÖ Todos Presentes
                    </button>
                    <button class="status-btn late-justified" onclick="markAllStudents('late_justified')">
                        ‚è∞ Todos Tarde (J)
                    </button>
                    <button class="status-btn absent-justified" onclick="markAllStudents('absent_justified')">
                        üìã Todos Ausentes (J)
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="clearAllAttendance()">
                        üßπ Limpiar Todo
                    </button>
                </div>

                <!-- Tabla de Estudiantes -->
                <div class="students-table">
                    <div id="loadingState" style="text-align: center; padding: 50px; color: #666;">
                        üîÑ Seleccione grado para cargar estudiantes...
                    </div>
                    
                    <table id="attendanceTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Estudiante</th>
                                <th>Estado Actual</th>
                                <th>Acciones</th>
                                <th>Hora Llegada</th>
                                <th>Justificaci√≥n</th>
                                <th>Asistencia MEP</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Panel de Estad√≠sticas -->
        <div class="stats-panel">
            <div class="card-header">
                üìä Estad√≠sticas del D√≠a
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="statPresent">0</div>
                    <div class="stat-label">Presentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statLateJustified">0</div>
                    <div class="stat-label">Tard√≠as Justificadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statLateUnjustified">0</div>
                    <div class="stat-label">Tard√≠as Injustificadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statAbsentJustified">0</div>
                    <div class="stat-label">Ausencias Justificadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statAbsentUnjustified">0</div>
                    <div class="stat-label">Ausencias Injustificadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statNotMarked">0</div>
                    <div class="stat-label">Sin Marcar</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Panel -->
    <div id="debugPanel" class="debug-panel">
        <h4>üêõ Debug Info</h4>
        <div id="debugContent">Debug activado</div>
    </div>

    <!-- Modal para Justificaci√≥n -->
    <div class="modal" id="justificationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Agregar Justificaci√≥n</h2>
                <button class="close-btn" onclick="closeJustificationModal()">&times;</button>
            </div>
            
            <form id="justificationForm" onsubmit="saveJustification(event)">
                <div class="form-group">
                    <label class="form-label">Estudiante:</label>
                    <div id="justificationStudent" style="font-weight: 600; color: #333;"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estado:</label>
                    <select class="form-input" id="justificationStatus" required>
                        <option value="present">‚úÖ Presente</option>
                        <option value="late_justified">‚è∞ Tard√≠a Justificada</option>
                        <option value="late_unjustified">üî∂ Tard√≠a Injustificada</option>
                        <option value="absent_justified">üìã Ausencia Justificada</option>
                        <option value="absent_unjustified">‚ùå Ausencia Injustificada</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Hora de Llegada (opcional):</label>
                    <input type="time" class="form-input" id="justificationTime">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Justificaci√≥n:</label>
                    <textarea class="form-textarea" id="justificationText" rows="3" 
                              placeholder="Describa la justificaci√≥n o motivo..."></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeJustificationModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Configuraci√≥n de Notas -->
    <div class="modal" id="lessonConfigModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚öôÔ∏è Configuraci√≥n de la Nota</h2>
                <button class="close-btn" onclick="closeLessonConfigModal()">&times;</button>
            </div>
            
            <form id="lessonConfigForm" onsubmit="saveLessonConfigModal(event)">
                <div class="form-group">
                    <label class="form-label">üìä Escala M√°xima de Notas:</label>
                    <input type="number"
                        class="form-input"
                        id="maxScaleInput"
                        step="0.1"
                        min="1"
                        max="100"
                        value="5.0"
                        required>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        5.0 = MEP tradicional | 10.0 = escala de 10 | 100 = porcentajes
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">üìÖ Peso en SEA (%):</label>
                    <input type="number"
                        class="form-input"
                        id="attendanceWeightInput"
                        step="0.1"
                        min="0"
                        max="100"
                        value="10"
                        required>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeLessonConfigModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Configuraci√≥n</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========================================
        // VARIABLES GLOBALES
        // ========================================
        let students = [];
        let currentDate = new Date();
        let selectedDate = new Date();
        let isBulkMarking = false;
        let currentGrade = '';
        let currentSubject = '';
        let currentStudentId = null;
        let attendanceData = {};
        let lessonConfig = { lessonsPerWeek: 5, totalWeeks: 40, totalLessons: 200 };
        let debugMode = false;

        function getCurrentAcademicPeriod() {
            if (window.unifiedPeriodSelector) {
                return window.unifiedPeriodSelector.getCurrentPeriod();
            }
            const saved = localStorage.getItem(getPeriodStorageKey ? getPeriodStorageKey() : 'currentAcademicPeriod');
            if (saved) {
                try { return JSON.parse(saved); } catch (e) {}
            }
            return { schoolId: '1', year: 2025, periodType: 'semester', periodNumber: 1 };
        }

        // Helper para peticiones autenticadas
        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('sessionToken');

            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            };

            const mergedOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...(options.headers || {})
                }
            };

            const response = await fetch(url, mergedOptions);

            if (response.status === 401) {
                localStorage.removeItem('sessionToken');
                localStorage.removeItem('teacherInfo');
                window.location.href = '/login.html';
                return;
            }

            return response;
        }

        // ========================================
        // INICIALIZACI√ìN
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando m√≥dulo de asistencias - VERSI√ìN CORREGIDA...');
            initializeCalendar();
            loadFilters();
            updateCurrentDate();
            calculateTotalLessons();
            
            // Debug inicial
            debugLog('Sistema iniciado correctamente');
        });

        // ========================================
        // FUNCIONES DE DEBUG
        // ========================================
        function debugLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] ${message}`, data);
            
            if (debugMode) {
                const debugContent = document.getElementById('debugContent');
                debugContent.innerHTML += `<div><strong>${timestamp}:</strong> ${message}</div>`;
                if (data) {
                    debugContent.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }

        function toggleDebug() {
            debugMode = !debugMode;
            const debugPanel = document.getElementById('debugPanel');
            if (debugMode) {
                debugPanel.classList.add('show');
                debugLog('Debug mode activado');
            } else {
                debugPanel.classList.remove('show');
            }
        }

        function showMessage(type, message, callback) {
            const messageEl = document.getElementById(type + 'Message');
            messageEl.textContent = message;
            messageEl.classList.add('show');

            setTimeout(() => {
                messageEl.classList.remove('show');
                if (typeof callback === 'function') {
                    callback();
                }
            }, 5000);
        }

        // ========================================
        // FUNCIONES DEL CALENDARIO
        // ========================================
        function initializeCalendar() {
            debugLog('üöÄ Inicializando calendario...');
            
            const now = new Date();
            currentDate = new Date(now.getFullYear(), now.getMonth(), 1);
            selectedDate = new Date(now);
            
            renderCalendar();
            updateCurrentDate();
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            debugLog(`üóìÔ∏è Renderizando: ${month + 1}/${year}`);
            
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            document.getElementById('calendarMonthYear').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const firstDayOfWeek = firstDay.getDay();
            
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';
            
            for (let i = 0; i < 42; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                let dayNumber;
                let dayDate;
                
                if (i < firstDayOfWeek) {
                    const prevMonth = month - 1;
                    const prevYear = prevMonth < 0 ? year - 1 : year;
                    const prevMonthActual = prevMonth < 0 ? 11 : prevMonth;
                    const daysInPrevMonth = new Date(prevYear, prevMonthActual + 1, 0).getDate();
                    
                    dayNumber = daysInPrevMonth - (firstDayOfWeek - 1 - i);
                    dayDate = new Date(prevYear, prevMonthActual, dayNumber);
                    dayElement.classList.add('other-month');
                    
                } else if (i < firstDayOfWeek + daysInMonth) {
                    dayNumber = i - firstDayOfWeek + 1;
                    dayDate = new Date(year, month, dayNumber);
                    
                } else {
                    const nextMonth = month + 1;
                    const nextYear = nextMonth > 11 ? year + 1 : year;
                    const nextMonthActual = nextMonth > 11 ? 0 : nextMonth;
                    
                    dayNumber = i - firstDayOfWeek - daysInMonth + 1;
                    dayDate = new Date(nextYear, nextMonthActual, dayNumber);
                    dayElement.classList.add('other-month');
                }
                
                dayElement.textContent = dayNumber;
                
                if (dayDate.getDay() === 0 || dayDate.getDay() === 6) {
                    dayElement.classList.add('weekend');
                }
                
                if (isSameDay(dayDate, new Date())) {
                    dayElement.classList.add('today');
                }
                
                if (isSameDay(dayDate, selectedDate)) {
                    dayElement.classList.add('selected');
                }
                
                dayElement.addEventListener('click', () => selectDate(dayDate));
                calendarDays.appendChild(dayElement);
            }
            
            debugLog('‚úÖ Calendario renderizado');
        }

        function selectDate(date) {
            if (isBulkMarking) {
                showMessage('error', 'Espera a que termine el marcado masivo antes de cambiar la fecha');
                return;
            }

            debugLog('üìÖ Fecha seleccionada:', date.toISOString().split('T')[0]);
            
            if (date.getMonth() !== currentDate.getMonth() || date.getFullYear() !== currentDate.getFullYear()) {
                currentDate = new Date(date.getFullYear(), date.getMonth(), 1);
            }
            
            selectedDate = new Date(date);
            renderCalendar();
            updateCurrentDate();
            loadAttendanceForDate();
        }

        function changeMonth(delta) {
            if (isBulkMarking) {
                showMessage('error', 'Espera a que termine el marcado masivo antes de cambiar la fecha');
                return;
            }

            const newMonth = currentDate.getMonth() + delta;
            const newYear = currentDate.getFullYear();
            
            if (newMonth < 0) {
                currentDate = new Date(newYear - 1, 11, 1);
            } else if (newMonth > 11) {
                currentDate = new Date(newYear + 1, 0, 1);
            } else {
                currentDate = new Date(newYear, newMonth, 1);
            }
            
            renderCalendar();
        }

        function isSameDay(date1, date2) {
            if (!date1 || !date2) return false;
            
            return date1.getDate() === date2.getDate() &&
                date1.getMonth() === date2.getMonth() &&
                date1.getFullYear() === date2.getFullYear();
        }

        function updateCurrentDate() {
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            
            try {
                const dateString = selectedDate.toLocaleDateString('es-ES', options);
                const capitalizedDate = dateString.charAt(0).toUpperCase() + dateString.slice(1);
                document.getElementById('attendanceDate').textContent = capitalizedDate;
            } catch (error) {
                console.error('Error actualizando fecha:', error);
            }
        }

        // ========================================
        // CARGA DE DATOS - CORREGIDO
        // ========================================
        async function loadFilters() {
            try {
                debugLog('üìã Cargando filtros...');
                
                // Cargar grados
                const gradesResponse = await authenticatedFetch('/api/grades');
                const gradesResult = await gradesResponse.json();
                
                const gradeFilter = document.getElementById('gradeFilter');
                gradeFilter.innerHTML = '<option value="">Seleccionar grado...</option>';
                
                if (gradesResult.success) {
                    gradesResult.data.forEach(grade => {
                        gradeFilter.innerHTML += `<option value="${grade.name}">${grade.name}</option>`;
                    });
                    debugLog('‚úÖ Grados cargados:', gradesResult.data.length);
                } else {
                    debugLog('‚ö†Ô∏è No se pudieron cargar los grados');
                    showMessage('error', 'No se pudieron cargar los grados');
                }
                
            } catch (error) {
                debugLog('‚ùå Error cargando filtros:', error);
                showMessage('error', 'Error cargando filtros: ' + error.message);
            }
        }

        async function loadStudents() {
            const grade = document.getElementById('gradeFilter').value;
            
            debugLog('üë• Cargando estudiantes...', { grade });
            
            if (!grade) {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('loadingState').innerHTML = 'üîÑ Seleccione grado para cargar estudiantes...';
                document.getElementById('attendanceTable').style.display = 'none';
                return;
            }
            
            currentGrade = grade;
            currentSubject = null; // Ya no usamos filtro de materias
            
            try {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('loadingState').innerHTML = 'üîÑ Cargando estudiantes...';
                document.getElementById('attendanceTable').style.display = 'none';
                
                const period = getCurrentAcademicPeriod();
                const url = `/api/students?year=${period.year}&period_type=${period.periodType}&period_number=${period.periodNumber}`;
                const response = await authenticatedFetch(url);
                const result = await response.json();
                
                if (result.success) {
                    // Filtrar estudiantes solo por grado y status activo
                    students = result.data.filter(student => {
                        const gradeMatch = student.grade_level === grade;
                        const statusMatch = student.status === 'active';
                        
                        return gradeMatch && statusMatch;
                    });
                    
                    debugLog(`‚úÖ Estudiantes filtrados: ${students.length}`, { grade });
                    
                    // Actualizar informaci√≥n del header
                    document.getElementById('attendanceInfo').textContent = 
                        `üìä ${grade} - ${students.length} estudiantes (Todas las materias)`;
                    
                    // Cargar asistencia existente para la fecha
                    await loadAttendanceForDate();
                    
                    // Renderizar tabla
                    renderStudentsTable();
                    updateStats();
                    
                    if (students.length > 0) {
                        document.getElementById('loadingState').style.display = 'none';
                        document.getElementById('attendanceTable').style.display = 'table';
                        debugLog('‚úÖ Lista de estudiantes cargada correctamente');

                        // ‚úÖ AGREGAR ESTA L√çNEA AL FINAL
                        await loadConfigurationForCurrentGrade();

                    } else {
                        document.getElementById('loadingState').innerHTML = 
                            `üì≠ No hay estudiantes activos en ${grade}`;
                    }
                    
                } else {
                    document.getElementById('loadingState').innerHTML = '‚ùå Error cargando estudiantes';
                    debugLog('‚ùå Error en respuesta:', result.message);
                    showMessage('error', 'Error cargando estudiantes: ' + result.message);
                }
                
            } catch (error) {
                debugLog('‚ùå Error cargando estudiantes:', error);
                document.getElementById('loadingState').innerHTML = '‚ùå Error de conexi√≥n al cargar estudiantes';
                showMessage('error', 'Error de conexi√≥n al cargar estudiantes');
            }
        }



        async function loadConfigurationForCurrentGrade() {
            if (!currentGrade) return;
            
            try {
                debugLog('üìö Cargando configuraci√≥n para grado:', currentGrade);
                
                const response = await authenticatedFetch(`/api/lesson-config?grade=${encodeURIComponent(currentGrade)}&subject=general`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const config = result.data;
                    
                    // Actualizar los valores en la interfaz
                    document.getElementById('lessonsPerWeek').value = config.lessons_per_week || 5;
                    document.getElementById('totalWeeks').value = config.total_weeks || 40;
                    
                    // Calcular total te√≥rico
                    const theoreticalTotal = (config.lessons_per_week || 5) * (config.total_weeks || 40);
                    
                    // Obtener lecciones reales basadas en asistencia
                    const actualLessons = await getActualLessonsGiven();
                    
                    // Actualizar la interfaz con informaci√≥n flexible
                    updateFlexibleLessonInfo(theoreticalTotal, actualLessons, config);
                    
                    debugLog('‚úÖ Configuraci√≥n cargada:', config);
                } else {
                    debugLog('‚ö†Ô∏è No hay configuraci√≥n guardada, usando valores por defecto');
                    updateFlexibleLessonInfo(200, 0, null);
                }
                
            } catch (error) {
                debugLog('‚ùå Error cargando configuraci√≥n:', error);
                updateFlexibleLessonInfo(200, 0, null);
            }
        }


        async function getActualLessonsGiven() {
            if (!currentGrade) return 0;
            
            try {
                // Contar d√≠as √∫nicos con asistencia registrada para este grado
                const period = getCurrentAcademicPeriod();
                const response = await authenticatedFetch(`/api/attendance/lesson-count?grade=${encodeURIComponent(currentGrade)}&year=${period.year}&period_type=${period.periodType}&period_number=${period.periodNumber}&school_id=${period.schoolId}`);
                const result = await response.json();
                
                if (result.success) {
                    return result.data.total_lessons || 0;
                }
                
                return 0;
            } catch (error) {
                debugLog('‚ùå Error obteniendo lecciones reales:', error);
                return 0;
            }
        }



    function updateFlexibleLessonInfo(theoretical, actual, config) {
        document.getElementById('theoreticalLessons').textContent = theoretical;
        document.getElementById('actualLessons').textContent = actual;
        
        const progress = theoretical > 0 ? Math.round((actual / theoretical) * 100) : 0;
        document.getElementById('progressInfo').textContent = `${progress}%`;
        
        // Actualizar tip seg√∫n el progreso
        const tipElement = document.getElementById('flexibleTip');
        if (actual > theoretical) {
            tipElement.innerHTML = 'üéØ ¬°Excelente! Has dado m√°s lecciones de las planificadas';
            tipElement.style.background = '#d4edda';
            tipElement.style.color = '#155724';
        } else if (actual < theoretical * 0.8) {
            tipElement.innerHTML = '‚ö†Ô∏è Considera ajustar la planificaci√≥n por d√≠as feriados';
            tipElement.style.background = '#fff3cd';
            tipElement.style.color = '#856404';
        } else {
            tipElement.innerHTML = 'üí° El sistema se ajusta autom√°ticamente a los d√≠as reales trabajados';
            tipElement.style.background = '#e8f4fd';
            tipElement.style.color = '#2c5aa0';
        }
    }

    function updateFlexibleCalculation() {
        const lessonsPerWeek = parseInt(document.getElementById('lessonsPerWeek').value) || 5;
        const totalWeeks = parseInt(document.getElementById('totalWeeks').value) || 40;
        const theoretical = lessonsPerWeek * totalWeeks;
        
        document.getElementById('theoreticalLessons').textContent = theoretical;
        
        // Recalcular progreso
        const actual = parseInt(document.getElementById('actualLessons').textContent) || 0;
        const progress = theoretical > 0 ? Math.round((actual / theoretical) * 100) : 0;
        document.getElementById('progressInfo').textContent = `${progress}%`;
    }

    function recalculateFromReal() {
        const actualLessons = parseInt(document.getElementById('actualLessons').textContent) || 0;
        const lessonsPerWeek = parseInt(document.getElementById('lessonsPerWeek').value) || 5;
        
        if (actualLessons > 0 && lessonsPerWeek > 0) {
            const adjustedWeeks = Math.ceil(actualLessons / lessonsPerWeek);
            document.getElementById('totalWeeks').value = adjustedWeeks;
            document.getElementById('theoreticalLessons').textContent = actualLessons;
            document.getElementById('progressInfo').textContent = '100%';
            
            showMessage('success', `‚úÖ Ajustado a ${adjustedWeeks} semanas basado en ${actualLessons} lecciones reales`);
        } else {
            showMessage('info', 'Necesitas registrar asistencia primero para usar esta funci√≥n');
        }
    }

        async function loadAttendanceForDate() {
            if (!currentGrade || students.length === 0) {
                debugLog('‚ö†Ô∏è No se puede cargar asistencia: falta grado o estudiantes');
                return;
            }
            
            // ‚úÖ NUEVO: Invalidar cache de estad√≠sticas al cambiar fecha
            studentMEPStats = {};
            
            try {
                const dateStr = selectedDate.toISOString().split('T')[0];
                debugLog('üìä Cargando asistencia para:', { date: dateStr, grade: currentGrade, subject: currentSubject });
                
                const period = getCurrentAcademicPeriod();
                let url = `/api/attendance?date=${dateStr}&grade=${encodeURIComponent(currentGrade)}&year=${period.year}&period_type=${period.periodType}&period_number=${period.periodNumber}&school_id=${period.schoolId}`;
                // Ya no a√±adimos el par√°metro subject porque no usamos filtro de materias
                
                const response = await authenticatedFetch(url);
                const result = await response.json();
                
                attendanceData = {};
                if (result.success && result.data) {
                    debugLog('üîç DATOS CRUDOS del servidor:', result.data);
                    
                    result.data.forEach(record => {
                        // ‚úÖ CORREGIDO: Usar el ID num√©rico correcto
                        const studentKey = record.student_id; // Ahora deber√≠a ser num√©rico
                        attendanceData[studentKey] = record;
                        debugLog(`üìù Asistencia mapeada: key=${studentKey} (code: ${record.student_code}), status=${record.status}, name=${record.first_name}`);
                    });
                    
                    debugLog('‚úÖ Asistencia cargada:', result.data.length, 'registros');
                    debugLog('üìã AttendanceData final:', attendanceData);
                    debugLog('üë• Student IDs disponibles:', students.map(s => `${s.id}(${s.first_name})`));
                    
                    // ‚úÖ VERIFICACI√ìN DE COINCIDENCIAS MEJORADA
                    students.forEach(student => {
                        const hasAttendance = !!attendanceData[student.id];
                        const attendanceStatus = attendanceData[student.id]?.status || 'none';
                        debugLog(`üîç Estudiante ${student.id} (${student.first_name}) vs AttendanceKey: ${hasAttendance ? '‚úÖ COINCIDE' : '‚ùå NO COINCIDE'} - Status: ${attendanceStatus}`);
                    });
                    
                } else {
                    debugLog('‚ö†Ô∏è No hay asistencia previa para esta fecha');
                }
                
                renderStudentsTable();
                updateStats();
                
            } catch (error) {
                debugLog('‚ùå Error cargando asistencia:', error);
                showMessage('error', 'Error cargando asistencia');
            }
        }

        // ========================================
        // RENDERIZADO DE TABLA - MEJORADO
        // ========================================
        async function renderStudentsTable() {
            if (students.length === 0) {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('loadingState').innerHTML = 'üìù No hay estudiantes para mostrar';
                document.getElementById('attendanceTable').style.display = 'none';
                return;
            }
            
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('attendanceTable').style.display = 'table';
            
            debugLog('üé® Renderizando tabla con estudiantes:', students.map(s => ({ id: s.id, name: s.first_name })));
            debugLog('üìä Datos de asistencia disponibles:', attendanceData);
            
            // Invalidar cache de estad√≠sticas cuando renderizamos
            studentMEPStats = {};
            
            const tbody = document.getElementById('attendanceTableBody');
            
            // Renderizar filas una por una para cargar estad√≠sticas progresivamente
            tbody.innerHTML = '';
            
            for (const student of students) {
                const attendance = attendanceData[student.id];
                const initials = ((student.first_name?.[0] || '') + (student.first_surname?.[0] || '')).toUpperCase();
                const fullName = `${student.first_surname || ''} ${student.second_surname || ''} ${student.first_name || ''}`.trim();
                
                const status = attendance?.status || 'not_marked';
                const statusText = getStatusText(status);
                const statusClass = getStatusClass(status);
                
                // Debug por estudiante
                debugLog(`üë§ Estudiante ${student.id} (${student.first_name}):`, {
                    hasAttendance: !!attendance,
                    status: status
                });
                
                // Crear fila inicial con datos b√°sicos
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="student-photo">${initials}</div>
                            <div>
                                <div class="student-name">${fullName}</div>
                                <div class="student-id">${student.student_id || '-'} (ID: ${student.id})</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="attendance-status ${statusClass}">${statusText}</span>
                    </td>
                    <td>
                        <div class="attendance-controls">
                            <button class="attendance-btn present" onclick="markAttendance(${student.id}, 'present')" title="Presente">
                                ‚úÖ P
                            </button>
                            <button class="attendance-btn late-justified" onclick="markAttendance(${student.id}, 'late_justified')" title="Tard√≠a Justificada">
                                ‚è∞ TJ
                            </button>
                            <button class="attendance-btn late-unjustified" onclick="markAttendance(${student.id}, 'late_unjustified')" title="Tard√≠a Injustificada">
                                üî∂ TI
                            </button>
                            <button class="attendance-btn absent-justified" onclick="markAttendance(${student.id}, 'absent_justified')" title="Ausencia Justificada">
                                üìã AJ
                            </button>
                            <button class="attendance-btn absent-unjustified" onclick="markAttendance(${student.id}, 'absent_unjustified')" title="Ausencia Injustificada">
                                ‚ùå AI
                            </button>
                            <button class="btn btn-info btn-sm" onclick="openJustificationModal(${student.id})" title="Editar">
                                ‚úèÔ∏è
                            </button>
                        </div>
                    </td>
                    <td>${attendance?.arrival_time || '-'}</td>
                    <td>${attendance?.justification || '-'}</td>
                    <td id="stats-${student.id}">
                        <div style="text-align: center; color: #666;">üîÑ Calculando...</div>
                    </td>
                `;
                
                tbody.appendChild(row);
                
                // Cargar estad√≠sticas MEP de forma as√≠ncrona
                getMEPGradeForStudent(student.id).then(mepStats => {
                    const statsCell = document.getElementById(`stats-${student.id}`);
                    if (statsCell) {
                        const attendancePercentage = mepStats.attendance_percentage;
                        const notaAsistencia = mepStats.nota_asistencia;
                        const nota10 = mepStats.nota_0_10;
                        
                        statsCell.innerHTML = `
                            <div style="text-align: center;">
                                <div style="font-weight: 600; color: ${attendancePercentage >= 90 ? '#28a745' : attendancePercentage >= 75 ? '#ffc107' : '#dc3545'};">
                                    ${attendancePercentage.toFixed(1)}%
                                </div>
                                <div style="font-size: 11px; color: #666;">
                                    Nota: ${notaAsistencia.toFixed(1)}/${mepStats.max_scale || 5.0}
                                </div>
                                <div style="font-size: 10px; color: #999;" title="Nota en escala 0-10 seg√∫n MEP">
                                    (${nota10}/10)
                                </div>
                            </div>
                        `;
                    }
                }).catch(error => {
                    debugLog(`‚ùå Error cargando estad√≠sticas para estudiante ${student.id}:`, error);
                    const statsCell = document.getElementById(`stats-${student.id}`);
                    if (statsCell) {
                        statsCell.innerHTML = `
                            <div style="text-align: center; color: #dc3545;">
                                Error
                            </div>
                        `;
                    }
                });
            }
            
            debugLog('‚úÖ Tabla renderizada con', students.length, 'estudiantes');
        }

        function getStatusText(status) {
            const statusMap = {
                'present': '‚úÖ Presente',
                'late_justified': '‚è∞ Tard√≠a (J)',
                'late_unjustified': 'üî∂ Tard√≠a (I)',
                'absent_justified': 'üìã Ausencia (J)',
                'absent_unjustified': '‚ùå Ausencia (I)',
                'not_marked': '‚≠ï Sin marcar'
            };
            return statusMap[status] || '‚≠ï Sin marcar';
        }

        function getStatusClass(status) {
            const classMap = {
                'present': 'status-present',
                'late_justified': 'status-late-justified',
                'late_unjustified': 'status-late-unjustified',
                'absent_justified': 'status-absent-justified',
                'absent_unjustified': 'status-absent-unjustified',
                'not_marked': 'status-not-marked'
            };
            return classMap[status] || 'status-not-marked';
        }

        // ========================================
        // FUNCIONES DE ASISTENCIA - COMPLETAMENTE CORREGIDAS
        // ========================================
        async function markAttendance(studentId, status, date = selectedDate) {
            try {
                debugLog(`üìù Marcando asistencia:`, { studentId, status, grade: currentGrade, subject: currentSubject });
                
                const dateStr = date.toISOString().split('T')[0];
                const now = new Date();
                
                // ‚úÖ CORREGIDO: Usar la materia del estudiante o 'general'
                const student = students.find(s => s.id === studentId);
                const subjectArea = student?.subject_area || 'general';
                
                const period = getCurrentAcademicPeriod();
                const attendanceRecord = {
                    student_id: studentId,
                    date: dateStr,
                    status: status,
                    grade_level: currentGrade,
                    subject_area: subjectArea,
                    arrival_time: status.includes('late') ? now.toTimeString().substr(0, 5) : null,
                    justification: null,
                    notes: null,
                    school_id: period.schoolId,
                    year: period.year,
                    period_type: period.periodType,
                    period_number: period.periodNumber
                };
                
                debugLog('üì§ Enviando datos:', attendanceRecord);
                
                const response = await authenticatedFetch('/api/attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(attendanceRecord)
                });
                
                const result = await response.json();
                debugLog('üì• Respuesta del servidor:', result);
                
                if (result.success) {
                    // ‚úÖ CORREGIDO: Actualizar datos locales correctamente
                    attendanceData[studentId] = {
                        ...attendanceRecord,
                        id: result.data.id,
                        student_id: studentId // Asegurar que coincide con el ID del estudiante
                    };
                    
                    // ‚úÖ NUEVO: Invalidar cache de estad√≠sticas MEP para este estudiante
                    delete studentMEPStats[studentId];
                    
                    debugLog('‚úÖ Datos locales actualizados:', attendanceData[studentId]);
                    
                    renderStudentsTable();
                    updateStats();
                    
                    const statusText = getStatusText(status);
                    debugLog(`‚úÖ Asistencia guardada: ${studentId} = ${status}`);
                    showMessage('success', `Asistencia marcada: ${statusText}`);
                } else {
                    debugLog('‚ùå Error del servidor:', result);
                    showMessage('error', 'Error: ' + result.message);
                }
            } catch (error) {
                debugLog('‚ùå Error marcando asistencia:', error);
                showMessage('error', 'Error de conexi√≥n al guardar asistencia');
            }
        }

        async function markAllStudents(status) {
            if (isBulkMarking) {
                showMessage('error', 'El marcado masivo ya est√° en progreso');
                return;
            }

            if (students.length === 0) {
                showMessage('error', 'No hay estudiantes cargados');
                return;
            }
            
            if (!confirm(`¬øMarcar a todos los ${students.length} estudiantes como "${getStatusText(status)}"?`)) {
                return;
            }
            
            debugLog(`üìã Marcando todos como: ${status}`);

            const dateSnapshot = new Date(selectedDate);

            isBulkMarking = true;

            try {
                let successCount = 0;
                let errorCount = 0;
                
                for (const student of students) {
                    try {
                        await markAttendance(student.id, status, dateSnapshot);
                        successCount++;
                        // Peque√±a pausa para no sobrecargar el servidor
                        await new Promise(resolve => setTimeout(resolve, 100));
                    } catch (error) {
                        errorCount++;
                        debugLog(`‚ùå Error marcando estudiante ${student.id}:`, error);
                    }
                }
                
                const statusText = getStatusText(status);
                if (errorCount === 0) {
                    showMessage(
                        'success',
                        `‚úÖ ${successCount} estudiantes marcados como "${statusText}"`,
                        () => { isBulkMarking = false; }
                    );
                } else {
                    showMessage(
                        'error',
                        `‚ö†Ô∏è ${successCount} exitosos, ${errorCount} errores`,
                        () => { isBulkMarking = false; }
                    );
                }
                
                debugLog(`üìä Resultado: ${successCount} exitosos, ${errorCount} errores`);
                
            } catch (error) {
                debugLog('‚ùå Error marcando todos:', error);
                showMessage('error', 'Error marcando estudiantes', () => { isBulkMarking = false; });
            }
        }

        async function clearAllAttendance() {
            if (!confirm('¬øEliminar toda la asistencia del d√≠a seleccionado?')) {
                return;
            }
            
            try {
                const dateStr = selectedDate.toISOString().split('T')[0];
                const period = getCurrentAcademicPeriod();
                let url = `/api/attendance?date=${dateStr}&grade=${encodeURIComponent(currentGrade)}&year=${period.year}&period_type=${period.periodType}&period_number=${period.periodNumber}&school_id=${period.schoolId}`;
                if (currentSubject) {
                    url += `&subject=${encodeURIComponent(currentSubject)}`;
                }
                
                debugLog('üóëÔ∏è Eliminando asistencia:', { date: dateStr, grade: currentGrade, subject: currentSubject });
                
                const response = await authenticatedFetch(url, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                debugLog('üì• Respuesta eliminaci√≥n:', result);
                
                if (result.success) {
                    attendanceData = {};
                    renderStudentsTable();
                    updateStats();
                    showMessage('success', '‚úÖ Asistencia eliminada correctamente');
                } else {
                    showMessage('error', 'Error: ' + result.message);
                }
            } catch (error) {
                debugLog('‚ùå Error eliminando asistencia:', error);
                showMessage('error', 'Error eliminando asistencia');
            }
        }

        // ========================================
        // ESTAD√çSTICAS Y C√ÅLCULOS - USANDO L√ìGICA REAL DEL MEP
        // ========================================
        
        let studentMEPStats = {}; // Cache para estad√≠sticas MEP
        
        async function calculateAttendancePercentage(studentId) {
            try {
                const mepStats = await getMEPGradeForStudent(studentId);
                return mepStats.attendance_percentage;
            } catch (error) {
                debugLog('‚ùå Error calculando porcentaje:', error);
                return 100; // Por defecto si hay error
            }
        }
        
        async function getMEPGradeForStudent(studentId) {
            try {
                // Obtener configuraci√≥n de lecciones
                const config = await getLessonConfigForCurrentSelection();
                const totalLessons = config?.total_lessons || 200;
                
                // Buscar en cache primero
                if (studentMEPStats[studentId] && studentMEPStats[studentId].total_lessons === totalLessons) {
                    debugLog(`üìà Usando cache para estudiante ${studentId}`);
                    return studentMEPStats[studentId];
                }
                
                // Construir URL con par√°metros correctos
                const period = getCurrentAcademicPeriod();
                const params = new URLSearchParams({
                    grade: currentGrade,
                    subject: currentSubject || 'general',
                    totalLessons: totalLessons.toString(),
                    year: period.year,
                    period_type: period.periodType,
                    period_number: period.periodNumber,
                    school_id: period.schoolId
                });
                
                const url = `/api/attendance/stats/${studentId}?${params.toString()}`;
                debugLog(`üîç Llamando API: ${url}`);
                
                // Hacer la petici√≥n
                const response = await authenticatedFetch(url);
                debugLog(`üì° Respuesta HTTP: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                debugLog(`üìã Resultado completo:`, result);
                
                if (result.success && result.data) {
                    // Guardar en cache
                    studentMEPStats[studentId] = result.data;
                    debugLog(`‚úÖ Estad√≠sticas MEP obtenidas para estudiante ${studentId}:`, result.data);
                    return result.data;
                } else {
                    throw new Error(result.message || 'Respuesta sin datos');
                }
                
            } catch (error) {
                debugLog(`‚ùå Error detallado obteniendo estad√≠sticas MEP para estudiante ${studentId}:`, {
                    error: error.message,
                    stack: error.stack,
                    currentGrade: currentGrade,
                    currentSubject: currentSubject,
                    studentId: studentId
                });
                
                // Devolver datos por defecto en caso de error
                return {
                    attendance_percentage: 100,
                    nota_asistencia: 5.0,
                    nota_0_10: 10,
                    absence_percentage: 0,
                    total_lessons: 200,
                    error: error.message
                };
            }
        }

        function updateStats() {
            const stats = {
                present: 0,
                lateJustified: 0,
                lateUnjustified: 0,
                absentJustified: 0,
                absentUnjustified: 0,
                notMarked: 0
            };
            
            debugLog('üë• Estudiantes para estad√≠sticas:', students.length);
            debugLog('üìä AttendanceData disponible:', Object.keys(attendanceData));
            
            students.forEach(student => {
                const attendance = attendanceData[student.id];
                const status = attendance?.status || 'not_marked';
                
                debugLog(`üìù Estudiante ${student.id} (${student.first_name}): ${status}`);
                
                switch (status) {
                    case 'present': stats.present++; break;
                    case 'late_justified': stats.lateJustified++; break;
                    case 'late_unjustified': stats.lateUnjustified++; break;
                    case 'absent_justified': stats.absentJustified++; break;
                    case 'absent_unjustified': stats.absentUnjustified++; break;
                    default: stats.notMarked++; break;
                }
            });
            
            document.getElementById('statPresent').textContent = stats.present;
            document.getElementById('statLateJustified').textContent = stats.lateJustified;
            document.getElementById('statLateUnjustified').textContent = stats.lateUnjustified;
            document.getElementById('statAbsentJustified').textContent = stats.absentJustified;
            document.getElementById('statAbsentUnjustified').textContent = stats.absentUnjustified;
            document.getElementById('statNotMarked').textContent = stats.notMarked;
            
            debugLog('üìä Estad√≠sticas finales:', stats);
        }

        // ========================================
        // CONFIGURACI√ìN DE LECCIONES
        // ========================================
        function calculateTotalLessons() {
            const lessonsInput = document.getElementById('lessonsPerWeek');
            const weeksInput = document.getElementById('totalWeeks');
            const lessonsPerWeek = parseInt(lessonsInput ? lessonsInput.value : 5) || 5;
            const totalWeeks = parseInt(weeksInput ? weeksInput.value : 40) || 40;
            const totalLessons = lessonsPerWeek * totalWeeks;

            const totalLessonsElement = document.getElementById('totalLessons');
            if (totalLessonsElement) {
                totalLessonsElement.textContent = totalLessons;
            }
            lessonConfig.totalLessons = totalLessons;

            const configLessonsPerWeek = document.getElementById('configLessonsPerWeek');
            const configTotalWeeks = document.getElementById('configTotalWeeks');
            const calculated = document.getElementById('calculatedLessons');
            if (configLessonsPerWeek && configTotalWeeks && calculated) {
                const modalLessons = (parseInt(configLessonsPerWeek.value) || 0) * (parseInt(configTotalWeeks.value) || 0);
                calculated.textContent = modalLessons;
            }
        }

        async function saveLessonConfig() {
            if (!currentGrade) {
                showMessage('error', 'Seleccione un grado primero');
                return;
            }
            
            try {
                const period = getCurrentAcademicPeriod();
                const configData = {
                    grade_level: document.getElementById('configGrade').value,
                    subject_area: 'general', // ‚úÖ Siempre usar 'general'
                    lessons_per_week: parseInt(document.getElementById('configLessonsPerWeek').value),
                    total_weeks: parseInt(document.getElementById('configTotalWeeks').value),
                    teacher_name: document.getElementById('configTeacher').value || null,
                    year: period.year,
                    period_type: period.periodType,
                    period_number: period.periodNumber
                };
                
                const response = await authenticatedFetch('/api/lesson-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', '‚úÖ Configuraci√≥n guardada correctamente');
                } else {
                    showMessage('error', 'Error: ' + result.message);
                }
            } catch (error) {
                debugLog('Error guardando configuraci√≥n:', error);
                showMessage('error', 'Error guardando configuraci√≥n');
            }
        }

        // ========================================
        // MODALES
        // ========================================
        function openJustificationModal(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            currentStudentId = studentId;
            const fullName = `${student.first_surname || ''} ${student.second_surname || ''} ${student.first_name || ''}`.trim();
            
            document.getElementById('justificationStudent').textContent = fullName;
            
            const attendance = attendanceData[studentId];
            if (attendance) {
                document.getElementById('justificationStatus').value = attendance.status;
                document.getElementById('justificationTime').value = attendance.arrival_time || '';
                document.getElementById('justificationText').value = attendance.justification || '';
            } else {
                document.getElementById('justificationForm').reset();
            }
            
            document.getElementById('justificationModal').classList.add('show');
        }

        function closeJustificationModal() {
            document.getElementById('justificationModal').classList.remove('show');
            currentStudentId = null;
        }

        async function saveJustification(event) {
            event.preventDefault();
            
            if (!currentStudentId) return;
            
            try {
                const dateStr = selectedDate.toISOString().split('T')[0];
                const student = students.find(s => s.id === currentStudentId);
                const subjectArea = currentSubject || student?.subject_area || 'general';
                
                const period = getCurrentAcademicPeriod();
                const attendanceRecord = {
                    student_id: currentStudentId,
                    date: dateStr,
                    status: document.getElementById('justificationStatus').value,
                    arrival_time: document.getElementById('justificationTime').value || null,
                    justification: document.getElementById('justificationText').value || null,
                    grade_level: currentGrade,
                    subject_area: subjectArea,
                    school_id: period.schoolId,
                    year: period.year,
                    period_type: period.periodType,
                    period_number: period.periodNumber
                };
                
                const response = await authenticatedFetch('/api/attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(attendanceRecord)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    attendanceData[currentStudentId] = {
                        ...attendanceRecord,
                        id: result.data.id
                    };
                    
                    renderStudentsTable();
                    updateStats();
                    closeJustificationModal();
                    showMessage('success', '‚úÖ Asistencia guardada correctamente');
                } else {
                    showMessage('error', 'Error: ' + result.message);
                }
            } catch (error) {
                debugLog('Error guardando justificaci√≥n:', error);
                showMessage('error', 'Error guardando asistencia');
            }
        }

        function openLessonConfigModal() {
            if (!currentGrade) {
                showMessage('error', 'Seleccione un grado primero');
                return;
            }
            
            document.getElementById('lessonConfigModal').classList.add('show');

            // ‚úÖ CARGAR ESCALA ACTUAL Y PESO
            loadCurrentScale();
        }

        // ‚úÖ FUNCI√ìN NUEVA - AGREGAR DESPU√âS DE openLessonConfigModal()
        async function loadCurrentScale() {
            try {
                if (!currentGrade) {
                    document.getElementById('maxScaleInput').value = 5.0;
                    document.getElementById('attendanceWeightInput').value = 10;
                    debugLog('‚ö†Ô∏è No hay grado seleccionado, usando escala por defecto');
                    return;
                }

                const response = await authenticatedFetch(`/api/grade-scale?grade=${encodeURIComponent(currentGrade)}&subject=general`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('maxScaleInput').value = data.max_scale;
                    document.getElementById('attendanceWeightInput').value = 10;
                    debugLog(`‚úÖ Escala cargada: ${data.max_scale}`);
                } else {
                    document.getElementById('maxScaleInput').value = 5.0; // Default
                    document.getElementById('attendanceWeightInput').value = 10;
                    debugLog('‚ö†Ô∏è No se encontr√≥ escala, usando 5.0 por defecto');
                }
            } catch (error) {
                console.error('Error cargando escala:', error);
                document.getElementById('maxScaleInput').value = 5.0; // Default en caso de error
                document.getElementById('attendanceWeightInput').value = 10;
                debugLog('‚ùå Error cargando escala, usando 5.0 por defecto');
            }

            try {
                const period = getCurrentAcademicPeriod();
                const weightResp = await authenticatedFetch(`/api/sea/weights?academic_period_id=${period.periodId}&school_id=${period.schoolId}`);
                const weightData = await weightResp.json();
                if (weightData.success && weightData.data) {
                    document.getElementById('attendanceWeightInput').value = weightData.data.attendance_weight;
                    debugLog(`‚úÖ Peso de asistencia cargado: ${weightData.data.attendance_weight}`);
                }
            } catch (wError) {
                console.error('Error cargando peso:', wError);
            }
        }
        function closeLessonConfigModal() {
            document.getElementById('lessonConfigModal').classList.remove('show');
        }

        async function saveLessonConfigModal(event) {
            event.preventDefault();
            
            try {
                // ‚úÖ OBTENER LA ESCALA M√ÅXIMA Y EL PESO
                const maxScale = parseFloat(document.getElementById('maxScaleInput').value);
                const attendanceWeight = parseFloat(document.getElementById('attendanceWeightInput').value);
                
                if (!currentGrade) {
                    showMessage('error', 'Seleccione un grado primero');
                    return;
                }
                
                // ‚úÖ GUARDAR ESCALA M√ÅXIMA (usando grado/materia actual)
                const scaleResponse = await authenticatedFetch('/api/grade-scale', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        grade: currentGrade,
                        subject: currentSubject || 'general',
                        maxScale: maxScale
                    })
                });
                
                const scaleResult = await scaleResponse.json();

                if (scaleResult.success) {
                    const period = getCurrentAcademicPeriod();
                    await authenticatedFetch('/api/sea/weights', {
                        method: 'PUT',
                        body: JSON.stringify({
                            attendance_weight: attendanceWeight,
                            academic_period_id: period.periodId,
                            school_id: period.schoolId
                        })
                    }).catch(err => console.error('Error guardando peso:', err));

                    showMessage('success', '‚úÖ Configuraci√≥n de nota guardada correctamente');
                    closeLessonConfigModal();
                    // Recargar estad√≠sticas para ver los cambios
                    if (typeof showClassStats === 'function') {
                        showClassStats();
                    }
                } else {
                    showMessage('error', 'Error guardando configuraci√≥n: ' + scaleResult.message);
                }
                
            } catch (error) {
                debugLog('Error guardando configuraci√≥n:', error);
                showMessage('error', 'Error guardando configuraci√≥n: ' + error.message);
            }
        }

        async function getLessonConfigForCurrentSelection() {
            try {
                if (!currentGrade) {
                    debugLog('‚ö†Ô∏è No hay grado seleccionado para configuraci√≥n');
                    return null;
                }
                
                const period = getCurrentAcademicPeriod();
                const params = new URLSearchParams({
                    grade: currentGrade,
                    subject: currentSubject || 'general',
                    year: period.year,
                    period_type: period.periodType,
                    period_number: period.periodNumber
                });
                
                const url = `/api/lesson-config?${params.toString()}`;
                debugLog(`üîç Obteniendo configuraci√≥n: ${url}`);
                
                const response = await authenticatedFetch(url);
                
                if (!response.ok) {
                    debugLog(`‚ö†Ô∏è Error HTTP obteniendo configuraci√≥n: ${response.status}`);
                    return null;
                }
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    debugLog(`‚úÖ Configuraci√≥n obtenida:`, result.data);
                    return result.data;
                } else {
                    debugLog(`‚ö†Ô∏è Configuraci√≥n no disponible, usando defaults`);
                    return null;
                }
                
            } catch (error) {
                debugLog('‚ùå Error obteniendo configuraci√≥n de lecciones:', error);
                return null;
            }
        }


        function exportAttendance() {
            showMessage('info', 'üìÑ Funci√≥n de exportar en desarrollo');
        }

        function exportClassStats() {
            showMessage('info', 'üìä Funci√≥n de exportar estad√≠sticas en desarrollo');
        }

        // ========================================
        // ESTAD√çSTICAS DE CLASE MEP
        // ========================================
        
        async function showClassStats() {
            if (!currentGrade) {
                showMessage('error', 'Seleccione un grado primero');
                return;
            }
            
            try {
                const config = await getLessonConfigForCurrentSelection();
                const totalLessons = config?.total_lessons || 200;
                
                showMessage('success', 'üìä Calculando estad√≠sticas MEP...');
                
                const period = getCurrentAcademicPeriod();
                const response = await authenticatedFetch(`/api/attendance/class-stats?grade=${encodeURIComponent(currentGrade)}&subject=${encodeURIComponent(currentSubject || 'general')}&totalLessons=${totalLessons}&year=${period.year}&period_type=${period.periodType}&period_number=${period.periodNumber}&school_id=${period.schoolId}`);
                const result = await response.json();
                
                if (result.success) {
                    displayClassStatsModal(result.data, result.summary, config);
                } else {
                    showMessage('error', 'Error: ' + result.message);
                }
            } catch (error) {
                debugLog('‚ùå Error obteniendo estad√≠sticas de clase:', error);
                showMessage('error', 'Error obteniendo estad√≠sticas de clase');
            }
        }
        
        function displayClassStatsModal(classStats, summary, config) {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
                    <div class="modal-header">
                        <h2 class="modal-title">üìä Estad√≠sticas MEP - ${currentGrade}</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    
                    <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
                        <!-- Resumen general -->
                        <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                            <h3>üìà Resumen General</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: #667eea;">${classStats.length}</div>
                                    <div style="color: #666; font-size: 12px;">ESTUDIANTES</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: #28a745;">${summary.average_attendance.toFixed(1)}%</div>
                                    <div style="color: #666; font-size: 12px;">ASISTENCIA PROMEDIO</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: #28a745;">${summary.average_grade.toFixed(1)}/${summary.max_scale || 5.0}</div>
                                    <div style="color: #666; font-size: 12px;">NOTA PROMEDIO</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: #17a2b8;">${config?.total_lessons || 200}</div>
                                    <div style="color: #666; font-size: 12px;">LECCIONES TOTAL</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabla de estudiantes -->
                        <h3>üë• Detalle por Estudiante</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">Estudiante</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">Asistencia</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">Ausencias</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">Nota 0-10</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">Nota Final</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">Registros</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${classStats.map(student => {
                                        const stats = student.mep_stats;
                                        return `
                                            <tr>
                                                <td style="padding: 8px; border: 1px solid #ddd;">
                                                    <strong>${student.first_surname} ${student.second_surname}, ${student.first_name}</strong><br>
                                                    <small style="color: #666;">${student.student_id}</small>
                                                </td>
                                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                                                    <span style="color: ${stats.attendance_percentage >= 90 ? '#28a745' : stats.attendance_percentage >= 75 ? '#ffc107' : '#dc3545'}; font-weight: 600;">
                                                        ${stats.attendance_percentage.toFixed(1)}%
                                                    </span>
                                                </td>
                                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                                                    ${stats.total_absences.toFixed(1)} / ${stats.total_lessons}
                                                </td>
                                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 600;">
                                                    ${stats.nota_0_10}/10
                                                </td>
                                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                                                    <span style="color: ${stats.nota_asistencia >= 4 ? '#28a745' : stats.nota_asistencia >= 3 ? '#ffc107' : '#dc3545'}; font-weight: 600;">
                                                        ${stats.nota_asistencia.toFixed(1)}/${stats.max_scale || 5.0}
                                                    </span>
                                                </td>
                                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 11px;">
                                                    P:${stats.stats.present} | TJ:${stats.stats.late_justified} | TI:${stats.stats.late_unjustified}<br>
                                                    AJ:${stats.stats.absent_justified} | AI:${stats.stats.absent_unjustified}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Explicaci√≥n de la f√≥rmula MEP -->
                        <div style="background: #e3f2fd; border-radius: 10px; padding: 15px; margin-top: 20px;">
                            <h4>üìã F√≥rmula MEP Aplicada</h4>
                            <p style="margin: 5px 0;"><strong>1.</strong> Ausencias = Ausencias Injustificadas + (Tard√≠as √ó 0.5)</p>
                            <p style="margin: 5px 0;"><strong>2.</strong> % Ausencias = (Ausencias √∑ Total Lecciones) √ó 100</p>
                            <p style="margin: 5px 0;"><strong>3.</strong> Nota 0-10 seg√∫n tabla oficial MEP</p>
                            <p style="margin: 5px 0;"><strong>4.</strong> Nota Final = Nota 0-10 √ó 0.5 (5% del per√≠odo)</p>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cerrar</button>
                        <button class="btn btn-success" onclick="exportClassStats()">üìÑ Exportar</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cerrar al hacer clic fuera
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.remove();
                }
            });
        }

        // Event listeners (se verifican elementos opcionales)
        const lpwInput = document.getElementById('lessonsPerWeek');
        if (lpwInput) lpwInput.addEventListener('input', calculateTotalLessons);

        const twInput = document.getElementById('totalWeeks');
        if (twInput) twInput.addEventListener('input', calculateTotalLessons);

        const clpwInput = document.getElementById('configLessonsPerWeek');
        if (clpwInput) clpwInput.addEventListener('input', calculateTotalLessons);

        const ctwInput = document.getElementById('configTotalWeeks');
        if (ctwInput) ctwInput.addEventListener('input', calculateTotalLessons);

        // Cerrar modales al hacer clic fuera
        const justificationModal = document.getElementById('justificationModal');
        if (justificationModal) {
            justificationModal.addEventListener('click', function(event) {
                if (event.target === this) closeJustificationModal();
            });
        }

        const lessonConfigModalEl = document.getElementById('lessonConfigModal');
        if (lessonConfigModalEl) {
            lessonConfigModalEl.addEventListener('click', function(event) {
                if (event.target === this) closeLessonConfigModal();
            });
        }

        // ===============================
        // INDICADOR SIMPLE DE PER√çODO
        // ===============================
        class SimplePeriodIndicator {
            constructor() {
                this.init();
            }

            init() {
                this.updateDisplay();
                this.setupEventListeners();
                console.log('üìÖ Indicador simple de per√≠odo inicializado');
            }

            setupEventListeners() {
                window.addEventListener('academicPeriodChanged', () => {
                    console.log('üìÖ Per√≠odo cambi√≥, actualizando indicador...');
                    this.updateDisplay();
                    this.reloadPageData();
                });

                window.addEventListener('reloadPeriodData', () => {
                    console.log('üîÑ Recargando datos por cambio de per√≠odo...');
                    this.updateDisplay();
                    this.reloadPageData();
                });
            }

            updateDisplay() {
                const display = document.getElementById('activePeriodDisplay');
                if (!display) return;

                try {
                    const currentPeriod = getCurrentAcademicPeriod();
                    const teacherData = this.getTeacherInfo();
                    const periodText = this.buildPeriodText(currentPeriod, teacherData);
                    display.textContent = periodText;
                    this.updateBannerState('active');
                } catch (error) {
                    console.error('Error actualizando indicador de per√≠odo:', error);
                    display.textContent = 'Error cargando per√≠odo acad√©mico';
                    this.updateBannerState('error');
                }
            }

            getTeacherInfo() {
                const teacherData = sessionStorage.getItem('teacherData');
                if (teacherData) {
                    try {
                        const teacher = JSON.parse(teacherData);
                        return {
                            name: teacher.name || teacher.full_name || 'Profesor',
                            school: teacher.school || teacher.school_name || 'Mi Escuela'
                        };
                    } catch (error) {
                        console.warn('Error parseando datos del profesor:', error);
                    }
                }
                return { name: 'Profesor', school: 'Mi Escuela' };
            }

            buildPeriodText(period, teacher) {
                const periodTypeName = period.periodType === 'semester' ? 'Semestre' : 'Trimestre';
                const periodNumber = period.periodNumber === 1 ? 'Primer' :
                                    period.periodNumber === 2 ? 'Segundo' : 'Tercer';
                return `${teacher.name} - ${period.year} - ${periodNumber} ${periodTypeName} - ${teacher.school}`;
            }

            updateBannerState(state) {
                const banner = document.querySelector('.period-indicator-banner');
                if (!banner) return;
                banner.classList.remove('loading', 'error', 'outdated');
                if (state !== 'active') {
                    banner.classList.add(state);
                }
            }

            reloadPageData() {
                if (typeof window.loadStudents === 'function') {
                    console.log('üîÑ Recargando estudiantes...');
                    window.loadStudents();
                }

                if (typeof window.loadAttendance === 'function') {
                    console.log('üîÑ Recargando asistencia...');
                    window.loadAttendance();
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.simplePeriodIndicator = new SimplePeriodIndicator();
        });

        window.updatePeriodIndicator = function() {
            if (window.simplePeriodIndicator) {
                window.simplePeriodIndicator.updateDisplay();
            }
        };

        // Exponer funciones para recarga externa
        window.loadStudents = loadStudents;
        window.loadAttendance = loadAttendanceForDate;
        // Function expected by the global period selector to reload data
        window.loadAttendanceData = loadAttendanceForDate;
    </script>
    <script src="js/global-period-selector.js"></script>
</body>
</html>