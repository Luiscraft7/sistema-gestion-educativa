<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Sistema Educativo</title>
    <style>
        /* Variables CSS */
        :root {
            --primary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #06b6d4;
            --bg-color: #f8fafc;
            --text-color: #334155;
            --border-color: #e2e8f0;
            --active-color: #22c55e;
            --inactive-color: #f87171;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-title h1 {
            font-size: 2rem;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Container Styles */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Tabs Styles */
        .tab-navigation {
            display: flex;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .tab-button {
            flex: 1;
            padding: 1rem 2rem;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .tab-button:hover {
            background: #f1f5f9;
        }

        .tab-button.active {
            background: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Card Styles */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .card-header {
            padding: 1.5rem 2rem;
            background: #f8fafc;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body {
            padding: 2rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
        }

        .stat-card.success {
            border-left-color: var(--success-color);
        }

        .stat-card.warning {
            border-left-color: var(--warning-color);
        }

        .stat-card.danger {
            border-left-color: var(--danger-color);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            color: #64748b;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: var(--text-color);
        }

        tr:hover {
            background: #f8fafc;
        }

        /* Button Styles */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-info {
            background: var(--info-color);
            color: white;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-paid {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-unpaid {
            background: #fef3c7;
            color: #92400e;
        }

        /* Calendar Styles */
        .calendar-container {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 2rem;
            margin-top: 1rem;
        }

        .calendar-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .month-selector {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .month-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        /* Payment Calendar Styles - Inspired by Attendance Calendar */
        .payment-calendar-container {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .payment-calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--primary-color);
        }

        .payment-day-header {
            padding: 0.75rem 0.5rem;
            text-align: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .payment-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .payment-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid #f1f1f1;
            transition: all 0.2s ease;
            position: relative;
            background: white;
        }

        .payment-day:hover {
            background: #f8fafc;
            transform: scale(1.05);
        }

        .payment-day.today {
            background: #3b82f6 !important;
            color: white !important;
            font-weight: 700;
        }

        .payment-day.payment-scheduled {
            background: #22c55e !important;
            color: white !important;
            font-weight: 700;
        }

        .payment-day.payment-completed {
            background: #f59e0b !important;
            color: white !important;
            font-weight: 700;
        }

        .payment-day.payment-completed::after {
            content: 'üí∞';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
        }

        .payment-day.payment-scheduled::after {
            content: 'üìÖ';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
        }

        .payment-day.other-month {
            color: #d1d5db;
            background: #f9fafb;
        }

        .payment-day.selected {
            background: #667eea !important;
            color: white !important;
            font-weight: 700;
            box-shadow: 0 0 0 2px #667eea;
        }

        .payment-day.weekend {
            background: #fff5f5;
        }

        .payment-day.weekend:hover {
            background: #fed7d7;
        }

        /* Teacher Selection Styles */
        .teacher-checkbox-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
            transition: background 0.2s;
        }

        .teacher-checkbox-item:hover {
            background: #f8fafc;
        }

        .teacher-checkbox-item:last-child {
            border-bottom: none;
        }

        .teacher-checkbox {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }

        .teacher-info {
            flex: 1;
        }

        .teacher-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .teacher-details {
            font-size: 0.875rem;
            color: #64748b;
        }

        .calendar-header {
            padding: 1rem;
            background: var(--primary-color);
            color: white;
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

        .calendar-day:hover {
            background: #f8fafc;
        }

        .calendar-day.has-payment {
            background: #dcfce7;
            font-weight: 600;
        }

        .calendar-day.selected {
            background: var(--primary-color);
            color: white;
        }

        /* Payment Controls */
        .payment-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        /* Activity Log */
        .activity-log {
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-icon {
            font-size: 1.5rem;
        }

        .log-content {
            flex: 1;
        }

        .log-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .log-details {
            font-size: 0.875rem;
            color: #64748b;
        }

        .log-time {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .calendar-container {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .payment-controls {
                flex-direction: column;
            }

            .tab-button {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }

            /* Responsive para la p√°gina de pagos */
            .payments-tab .card-body > div:first-child {
                grid-template-columns: 1fr !important;
            }

            .mini-calendar {
                max-width: 100%;
            }

            .teacher-checkbox-item {
                padding: 0.5rem;
            }

            .teacher-name {
                font-size: 0.875rem;
            }

            .teacher-details {
                font-size: 0.75rem;
            }
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="header-title">
                <span style="font-size: 2rem;">üîß</span>
                <h1>Panel de Administraci√≥n</h1>
            </div>
            <div class="header-actions">
                <!-- Info del admin se agrega din√°micamente -->
            </div>
        </div>
    </div>

    <!-- Container Principal -->
    <div class="container">
        <!-- Estad√≠sticas Generales -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-teachers">0</div>
                <div class="stat-label">Total Profesores</div>
            </div>
            <div class="stat-card success">
                <div class="stat-value" id="active-sessions">0</div>
                <div class="stat-label">Sesiones Activas</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-value" id="paid-teachers">0</div>
                <div class="stat-label">Profesores al D√≠a</div>
            </div>
            <div class="stat-card danger">
                <div class="stat-value" id="unpaid-teachers">0</div>
                <div class="stat-label">Pendientes de Pago</div>
            </div>
        </div>

        <!-- Navegaci√≥n por Tabs -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('teachers')">
                üë• Gesti√≥n Profesores
            </button>
            <button class="tab-button" onclick="switchTab('payments')">
                üí∞ Gesti√≥n Pagos
            </button>
            <button class="tab-button" onclick="switchTab('sessions')">
                üîí Control Sesiones
            </button>
            <button class="tab-button" onclick="switchTab('activity')">
                üìä Actividad
            </button>
        </div>

        <!-- Tab: Gesti√≥n de Profesores -->
        <div id="teachers-tab" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h3>üë• Gesti√≥n de Profesores</h3>
                    <button class="btn btn-primary" onclick="refreshTeachers()">
                        üîÑ Actualizar
                    </button>
                </div>
                <div class="card-body">
                    <div id="teachers-table-container">
                        <!-- Tabla se carga din√°micamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Gesti√≥n de Pagos -->
        <div id="payments-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>üí∞ Gesti√≥n de Pagos Mensual</h3>
                    <div class="payment-controls">
                        <button class="btn btn-success" onclick="markSelectedAsPaid()">
                            ‚úÖ Marcar Seleccionados Pagados
                        </button>
                        <button class="btn btn-warning" onclick="markAllAsPaid()">
                            ‚úÖ Marcar TODOS Pagados
                        </button>
                        <button class="btn btn-info" onclick="generatePaymentReport()">
                            üìä Generar Reporte
                        </button>
                        <button class="btn btn-secondary" onclick="configurePaymentDates()">
                            ‚öôÔ∏è Configurar Fechas
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Lista de Profesores con Checkboxes -->
                    <div style="display: grid; grid-template-columns: 1fr 350px; gap: 2rem; margin-bottom: 2rem;">
                        <div>
                            <h4 style="margin-bottom: 1rem;">üë• Seleccionar Profesores para Pago:</h4>
                            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                <button class="btn btn-sm btn-primary" onclick="selectAllTeachers()">
                                    ‚òëÔ∏è Seleccionar Todos
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="deselectAllTeachers()">
                                    ‚¨ú Deseleccionar Todos
                                </button>
                                <button class="btn btn-sm btn-info" onclick="selectUnpaidOnly()">
                                    üéØ Solo Pendientes
                                </button>
                            </div>
                            <div id="teachers-payment-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem;">
                                <!-- Lista de profesores se carga din√°micamente -->
                            </div>
                        </div>
                        
                        <!-- Calendario Interactivo Mejorado -->
                        <div>
                            <h4 style="margin-bottom: 1rem;">üìÖ Calendario de Fechas de Pago:</h4>
                            <div class="calendar-controls" style="margin-bottom: 1rem;">
                                <div class="month-selector">
                                    <button class="month-btn" onclick="changeMonth(-1)">‚óÄ</button>
                                    <span id="current-month" style="font-weight: 600;">Enero 2025</span>
                                    <button class="month-btn" onclick="changeMonth(1)">‚ñ∂</button>
                                </div>
                            </div>
                            
                            <!-- Calendario Interactivo -->
                            <div class="payment-calendar-container">
                                <div class="payment-calendar-header">
                                    <div class="payment-day-header">Dom</div>
                                    <div class="payment-day-header">Lun</div>
                                    <div class="payment-day-header">Mar</div>
                                    <div class="payment-day-header">Mi√©</div>
                                    <div class="payment-day-header">Jue</div>
                                    <div class="payment-day-header">Vie</div>
                                    <div class="payment-day-header">S√°b</div>
                                </div>
                                <div class="payment-calendar-grid" id="payment-calendar">
                                    <!-- Calendario se genera din√°micamente -->
                                </div>
                            </div>
                            
                            <!-- Leyenda del calendario -->
                            <div style="margin-top: 1rem; font-size: 0.75rem; background: #f8fafc; padding: 1rem; border-radius: 8px;">
                                <strong>üìã Leyenda:</strong><br>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
                                    <span>üü¢ <strong>Fecha de pago programada</strong></span>
                                    <span>üí∞ <strong>Pago realizado</strong></span>
                                    <span>üîµ <strong>D√≠a actual</strong></span>
                                    <span style="color: #64748b;">Haz clic en un d√≠a para programar fecha de pago</span>
                                </div>
                            </div>
                            
                            <!-- Configuraci√≥n de fechas -->
                            <div style="margin-top: 1rem; background: #f1f5f9; padding: 1rem; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <strong>‚öôÔ∏è Config. Autom√°tica:</strong>
                                    <input type="checkbox" id="auto-payment-reset" onchange="toggleAutoPaymentReset()" checked>
                                </div>
                                <div style="font-size: 0.875rem; color: #64748b;">
                                    <div>D√≠a de pago: <strong id="payment-day-config">15</strong> de cada mes</div>
                                    <button class="btn btn-sm btn-secondary" onclick="changePaymentDay()" style="margin-top: 0.5rem;">
                                        üìÖ Cambiar D√≠a
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resumen de Selecci√≥n -->
                    <div id="payment-summary" style="background: #f8fafc; padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <strong>üìä Resumen:</strong> <span id="summary-text">No hay profesores seleccionados</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Control de Sesiones -->
        <div id="sessions-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>üîí Control de Sesiones Activas</h3>
                    <button class="btn btn-info" onclick="refreshSessions()">
                        üîÑ Actualizar Estado
                    </button>
                </div>
                <div class="card-body">
                    <div id="sessions-table-container">
                        <!-- Tabla de sesiones se carga din√°micamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Actividad -->
        <div id="activity-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>üìä Log de Actividad</h3>
                    <button class="btn btn-secondary" onclick="clearActivityLog()">
                        üóëÔ∏è Limpiar Log
                    </button>
                </div>
                <div class="card-body">
                    <div class="activity-log" id="activity-log">
                        <!-- Log de actividad se carga din√°micamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentDate = new Date();
        let teachers = [];
        let sessions = [];
        let paymentData = {};
        let paymentConfig = {
            autoReset: true,
            paymentDay: 15, // D√≠a 15 de cada mes por defecto
            scheduledDates: [], // Fechas espec√≠ficas programadas
            completedPayments: [] // Pagos completados
        };
        let selectedPaymentDate = null;

        // Verificar autenticaci√≥n administrativa al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuthentication();
            initializeAdmin();
        });

        // Funci√≥n para verificar autenticaci√≥n
        function checkAdminAuthentication() {
            const adminSession = sessionStorage.getItem('adminSession');
            const adminUser = sessionStorage.getItem('adminUser');

            if (
                adminSession !== 'true' ||
                !adminUser ||
                adminUser.toLowerCase() !== 'luiscraft'
            ) {
                alert('üö´ Acceso denegado. Redirigiendo al login administrativo...');
                window.location.href = 'admin-login.html';
                return false;
            }
            
            updateHeaderWithAdmin(adminUser);
            return true;
        }

        // Actualizar header con informaci√≥n del admin
        function updateHeaderWithAdmin(adminUser) {
            const headerActions = document.querySelector('.header-actions');
            
            const adminInfo = document.createElement('div');
            adminInfo.style.cssText = 'display: flex; align-items: center; gap: 10px; margin-right: 15px;';
            adminInfo.innerHTML = `
                <span style="color: white; font-weight: 600;">üë§ ${adminUser}</span>
                <button class="btn btn-secondary" onclick="logoutAdmin()" style="padding: 8px 15px;">
                    üö™ Salir
                </button>
            `;
            
            headerActions.appendChild(adminInfo);
        }

        // Inicializar panel administrativo
        async function initializeAdmin() {
            loadPaymentConfig(); // Cargar configuraci√≥n de pagos
            await loadTeachers();
            await loadSessions();
            updateStats();
            updateCalendar();
            loadActivityLog();
            
            // Renderizar lista de pagos si existe el contenedor
            if (document.getElementById('teachers-payment-list')) {
                renderTeachersPaymentList();
            }
            
            // Verificar si necesita reset autom√°tico
            checkAutoResetNeeded();
            
            // REMOVED: Actualizaci√≥n autom√°tica cada 30 segundos
            // Solo actualizar cuando se haga clic en "Actualizar Estado"
        }

        function checkAutoResetNeeded() {
            if (!paymentConfig.autoReset) return;
            
            const today = new Date();
            const currentMonth = today.toISOString().slice(0, 7);
            const paymentDay = paymentConfig.paymentDay;
            
            // Si ya pas√≥ el d√≠a de pago y hay profesores que no han pagado
            if (today.getDate() > paymentDay) {
                const hasPaymentsThisMonth = paymentConfig.completedPayments.some(date => 
                    date.startsWith(currentMonth)
                );
                
                if (!hasPaymentsThisMonth && teachers.some(t => t.is_paid)) {
                    // Sugerir reset autom√°tico
                    setTimeout(() => {
                        if (confirm(`üîÑ RESET AUTOM√ÅTICO\n\nYa pas√≥ el d√≠a ${paymentDay} del mes y algunos profesores aparecen como pagados.\n\n¬øReiniciar el estado de pagos para este mes?`)) {
                            resetAllPaymentsForNewMonth();
                        }
                    }, 2000);
                }
            }
        }

        // ========================================
        // GESTI√ìN DE TABS
        // ========================================
        function switchTab(tabName) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar tab seleccionado
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            // Cargar contenido espec√≠fico del tab si es necesario
            if (tabName === 'payments') {
                setTimeout(() => {
                    if (document.getElementById('teachers-payment-list')) {
                        renderTeachersPaymentList();
                    }
                }, 100);
            }
        }

        // ========================================
        // GESTI√ìN DE PROFESORES
        // ========================================
        async function loadTeachers() {
            try {
                const response = await fetch('/api/teachers');
                const data = await response.json();
                
                if (data.success) {
                    teachers = data.data;
                    renderTeachersTable();
                }
            } catch (error) {
                console.error('Error cargando profesores:', error);
                addActivityLog('error', 'Error', 'Fall√≥ la carga de profesores');
            }
        }

        function renderTeachersTable() {
            const container = document.getElementById('teachers-table-container');
            
            const tableHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Profesor</th>
                                <th>Email</th>
                                <th>Escuela</th>
                                <th>Estado</th>
                                <th>Pago</th>
                                <th>√öltimo Acceso</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${teachers.map(teacher => `
                                <tr>
                                    <td>
                                        <strong>${teacher.full_name}</strong><br>
                                        <small>ID: ${teacher.cedula}</small>
                                    </td>
                                    <td>${teacher.email}</td>
                                    <td>${teacher.school_name}</td>
                                    <td>
                                        <span class="status-indicator ${teacher.is_active ? 'status-active' : 'status-inactive'}">
                                            ${teacher.is_active ? 'üü¢ Activo' : 'üî¥ Inactivo'}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="status-indicator ${teacher.is_paid ? 'status-paid' : 'status-unpaid'}">
                                            ${teacher.is_paid ? 'üí∞ Pagado' : '‚è≥ Pendiente'}
                                        </span>
                                    </td>
                                    <td>
                                        ${teacher.last_login ? new Date(teacher.last_login).toLocaleString() : 'Nunca'}
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button class="btn btn-sm ${teacher.is_active ? 'btn-danger' : 'btn-success'}" 
                                                    onclick="toggleTeacherStatus(${teacher.id}, '${teacher.is_active ? 'deactivate' : 'activate'}')">
                                                ${teacher.is_active ? '‚ùå' : '‚úÖ'}
                                            </button>
                                            <button class="btn btn-sm ${teacher.is_paid ? 'btn-warning' : 'btn-success'}" 
                                                    onclick="togglePayment(${teacher.id}, ${!teacher.is_paid})">
                                                üí∞
                                            </button>
                                            <button class="btn btn-sm btn-info" onclick="viewTeacherDetails(${teacher.id})">
                                                üëÅÔ∏è
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHTML;
            
            // Tambi√©n actualizar la lista de pagos si existe
            if (document.getElementById('teachers-payment-list')) {
                renderTeachersPaymentList();
            }
        }

        async function toggleTeacherStatus(teacherId, action) {
            try {
                const response = await fetch(`/api/teachers/${teacherId}/toggle-status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action })
                });

                const data = await response.json();
                if (data.success) {
                    await loadTeachers();
                    updateStats();
                    addActivityLog('status', 'Estado Cambiado', `Profesor ${action === 'activate' ? 'activado' : 'desactivado'}`);
                }
            } catch (error) {
                console.error('Error cambiando estado:', error);
            }
        }

        async function togglePayment(teacherId, isPaid) {
            try {
                const response = await fetch(`/api/teachers/${teacherId}/toggle-payment`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_paid: isPaid })
                });

                const data = await response.json();
                if (data.success) {
                    await loadTeachers();
                    updateStats();
                    addActivityLog('payment', 'Pago Actualizado', `Estado de pago ${isPaid ? 'marcado' : 'desmarcado'}`);
                }
            } catch (error) {
                console.error('Error actualizando pago:', error);
            }
        }

        function viewTeacherDetails(teacherId) {
            const teacher = teachers.find(t => t.id === teacherId);
            if (teacher) {
                alert(`
                    üìã DETALLES DEL PROFESOR
                    
                    Nombre: ${teacher.full_name}
                    C√©dula: ${teacher.cedula}
                    Email: ${teacher.email}
                    Escuela: ${teacher.school_name}
                    Tipo: ${teacher.teacher_type}
                    Estado: ${teacher.is_active ? 'Activo' : 'Inactivo'}
                    Pago: ${teacher.is_paid ? 'Al d√≠a' : 'Pendiente'}
                    Registro: ${new Date(teacher.created_at).toLocaleString()}
                    √öltimo acceso: ${teacher.last_login ? new Date(teacher.last_login).toLocaleString() : 'Nunca'}
                `);
            }
        }

        async function refreshTeachers() {
            await loadTeachers();
            addActivityLog('refresh', 'Actualizaci√≥n', 'Lista de profesores actualizada');
        }

        // ========================================
        // GESTI√ìN DE PAGOS
        // ========================================
        
        function renderTeachersPaymentList() {
            const container = document.getElementById('teachers-payment-list');
            
            const listHTML = teachers.map(teacher => `
                <div class="teacher-checkbox-item">
                    <input type="checkbox" 
                           class="teacher-checkbox" 
                           data-teacher-id="${teacher.id}"
                           ${teacher.is_paid ? 'disabled' : ''}
                           onchange="updatePaymentSummary()">
                    <div class="teacher-info">
                        <div class="teacher-name">${teacher.full_name}</div>
                        <div class="teacher-details">
                            ${teacher.school_name} ‚Ä¢ 
                            <span class="status-indicator ${teacher.is_paid ? 'status-paid' : 'status-unpaid'}">
                                ${teacher.is_paid ? 'üí∞ Pagado' : '‚è≥ Pendiente'}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = listHTML;
            updatePaymentSummary();
        }

        function selectAllTeachers() {
            const checkboxes = document.querySelectorAll('.teacher-checkbox:not([disabled])');
            checkboxes.forEach(cb => cb.checked = true);
            updatePaymentSummary();
        }

        function deselectAllTeachers() {
            const checkboxes = document.querySelectorAll('.teacher-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            updatePaymentSummary();
        }

        function selectUnpaidOnly() {
            const checkboxes = document.querySelectorAll('.teacher-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = !cb.disabled; // Solo los no pagados (no disabled)
            });
            updatePaymentSummary();
        }

        function updatePaymentSummary() {
            const selectedCheckboxes = document.querySelectorAll('.teacher-checkbox:checked');
            const selectedCount = selectedCheckboxes.length;
            const summaryText = document.getElementById('summary-text');
            
            if (selectedCount === 0) {
                summaryText.textContent = 'No hay profesores seleccionados';
            } else {
                const totalAmount = selectedCount * 30; // $30 por profesor
                summaryText.innerHTML = `
                    <strong>${selectedCount} profesor${selectedCount > 1 ? 'es' : ''} seleccionado${selectedCount > 1 ? 's' : ''}</strong> 
                    ‚Ä¢ Monto total: <strong>${totalAmount} USD</strong>
                `;
            }
        }

        async function markSelectedAsPaid() {
            const selectedCheckboxes = document.querySelectorAll('.teacher-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('‚ö†Ô∏è Debes seleccionar al menos un profesor');
                return;
            }

            const teacherIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.teacherId);
            const confirmMessage = `¬øMarcar ${teacherIds.length} profesor${teacherIds.length > 1 ? 'es' : ''} como pagado${teacherIds.length > 1 ? 's' : ''}?`;
            
            if (confirm(confirmMessage)) {
                try {
                    const today = new Date().toISOString().split('T')[0];
                    
                    for (const teacherId of teacherIds) {
                        await fetch(`/api/teachers/${teacherId}/toggle-payment`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ is_paid: true })
                        });
                    }
                    
                    // Registrar en el calendario
                    if (!paymentConfig.completedPayments.includes(today)) {
                        paymentConfig.completedPayments.push(today);
                        savePaymentConfig();
                    }
                    
                    await loadTeachers();
                    renderTeachersPaymentList();
                    updateStats();
                    updateCalendar();
                    addActivityLog('payment', 'Pago Selectivo', `${teacherIds.length} profesores marcados como pagados`);
                    
                    alert(`‚úÖ ${teacherIds.length} profesor${teacherIds.length > 1 ? 'es' : ''} marcado${teacherIds.length > 1 ? 's' : ''} como pagado${teacherIds.length > 1 ? 's' : ''}`);
                } catch (error) {
                    console.error('Error en pago selectivo:', error);
                    alert('‚ùå Error al procesar los pagos');
                }
            }
        }

        async function markAllAsPaid() {
            const unpaidTeachers = teachers.filter(t => t.is_active && !t.is_paid);
            
            if (unpaidTeachers.length === 0) {
                alert('‚úÖ Todos los profesores activos ya est√°n marcados como pagados');
                return;
            }

            if (confirm(`¬øMarcar TODOS los ${unpaidTeachers.length} profesores pendientes como pagados?`)) {
                try {
                    const today = new Date().toISOString().split('T')[0];
                    
                    for (const teacher of unpaidTeachers) {
                        await fetch(`/api/teachers/${teacher.id}/toggle-payment`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ is_paid: true })
                        });
                    }
                    
                    // Registrar en el calendario
                    if (!paymentConfig.completedPayments.includes(today)) {
                        paymentConfig.completedPayments.push(today);
                        savePaymentConfig();
                    }
                    
                    await loadTeachers();
                    renderTeachersPaymentList();
                    updateStats();
                    updateCalendar();
                    addActivityLog('payment', 'Pago Masivo', 'Todos los profesores marcados como pagados');
                    
                    alert(`‚úÖ ${unpaidTeachers.length} profesores marcados como pagados`);
                } catch (error) {
                    console.error('Error en pago masivo:', error);
                    alert('‚ùå Error al procesar el pago masivo');
                }
            }
        }

        function generatePaymentReport() {
            const paid = teachers.filter(t => t.is_paid).length;
            const unpaid = teachers.filter(t => !t.is_paid).length;
            const total = teachers.length;
            
            const report = `
            üìä REPORTE DE PAGOS - ${new Date().toLocaleDateString()}
            
            Total Profesores: ${total}
            ‚úÖ Pagados: ${paid} (${((paid/total)*100).toFixed(1)}%)
            ‚è≥ Pendientes: ${unpaid} (${((unpaid/total)*100).toFixed(1)}%)
            
            üí∞ Ingresos recibidos: ${paid * 30} USD
            ‚ö†Ô∏è Ingresos pendientes: ${unpaid * 30} USD
            üìà Ingresos totales potenciales: ${total * 30} USD
            
            Profesores pendientes de pago:
            ${teachers.filter(t => !t.is_paid).map(t => `- ${t.full_name} (${t.school_name})`).join('\n')}
            `;
            
            alert(report);
            addActivityLog('report', 'Reporte Generado', 'Reporte de pagos consultado');
        }

        function updateCalendar() {
            const calendar = document.getElementById('payment-calendar');
            const currentMonth = document.getElementById('current-month');
            
            if (!calendar) return;
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            currentMonth.textContent = currentDate.toLocaleDateString('es-ES', { 
                month: 'long', 
                year: 'numeric' 
            });
            
            // Limpiar calendario
            calendar.innerHTML = '';
            
            // Calcular primer d√≠a del mes y d√≠as en el mes
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // D√≠as del mes anterior (para completar la primera semana)
            const prevMonth = new Date(year, month - 1, 1);
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const dayElement = createPaymentDayElement(day, 'other-month');
                calendar.appendChild(dayElement);
            }
            
            // D√≠as del mes actual
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayElement = createPaymentDayElement(day, '');
                
                // Marcar d√≠a actual
                if (dateStr === todayStr) {
                    dayElement.classList.add('today');
                }
                
                // Marcar d√≠a de pago programado
                if (day === paymentConfig.paymentDay) {
                    dayElement.classList.add('payment-scheduled');
                }
                
                // Marcar pagos completados
                if (paymentConfig.completedPayments.includes(dateStr)) {
                    dayElement.classList.add('payment-completed');
                }
                
                // Marcar fechas programadas espec√≠ficas
                if (paymentConfig.scheduledDates.includes(dateStr)) {
                    dayElement.classList.add('payment-scheduled');
                }
                
                // Marcar fines de semana
                const dayOfWeek = new Date(year, month, day).getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    dayElement.classList.add('weekend');
                }
                
                // Event listener para seleccionar fecha
                dayElement.addEventListener('click', () => selectPaymentDate(dateStr, dayElement));
                
                calendar.appendChild(dayElement);
            }
            
            // D√≠as del mes siguiente (para completar la √∫ltima semana)
            const totalCells = calendar.children.length;
            const remainingCells = 42 - totalCells; // 6 filas √ó 7 d√≠as
            
            for (let day = 1; day <= remainingCells && remainingCells < 14; day++) {
                const dayElement = createPaymentDayElement(day, 'other-month');
                calendar.appendChild(dayElement);
            }
            
            updatePaymentConfigDisplay();
        }

        function createPaymentDayElement(day, extraClass) {
            const dayElement = document.createElement('div');
            dayElement.className = `payment-day ${extraClass}`;
            dayElement.textContent = day;
            dayElement.dataset.day = day;
            return dayElement;
        }

        function selectPaymentDate(dateStr, dayElement) {
            // Remover selecci√≥n anterior
            document.querySelectorAll('.payment-day.selected').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Seleccionar nuevo d√≠a
            dayElement.classList.add('selected');
            selectedPaymentDate = dateStr;
            
            // Preguntar qu√© hacer con esta fecha
            const options = [
                'Programar como fecha de pago',
                'Marcar como pago completado',
                'Quitar programaci√≥n',
                'Cancelar'
            ];
            
            const choice = prompt(`üìÖ Fecha seleccionada: ${new Date(dateStr).toLocaleDateString('es-ES')}\n\nElige una opci√≥n:\n1. ${options[0]}\n2. ${options[1]}\n3. ${options[2]}\n4. ${options[3]}\n\nEscribe el n√∫mero (1-4):`);
            
            switch(choice) {
                case '1':
                    schedulePaymentDate(dateStr);
                    break;
                case '2':
                    markPaymentCompleted(dateStr);
                    break;
                case '3':
                    removePaymentDate(dateStr);
                    break;
                default:
                    dayElement.classList.remove('selected');
                    selectedPaymentDate = null;
            }
        }

        function schedulePaymentDate(dateStr) {
            if (!paymentConfig.scheduledDates.includes(dateStr)) {
                paymentConfig.scheduledDates.push(dateStr);
                savePaymentConfig();
                updateCalendar();
                addActivityLog('payment', 'Fecha Programada', `Fecha de pago programada: ${new Date(dateStr).toLocaleDateString('es-ES')}`);
                alert('‚úÖ Fecha de pago programada correctamente');
            }
        }

        function markPaymentCompleted(dateStr) {
            if (!paymentConfig.completedPayments.includes(dateStr)) {
                paymentConfig.completedPayments.push(dateStr);
                savePaymentConfig();
                updateCalendar();
                addActivityLog('payment', 'Pago Completado', `Pago marcado como completado: ${new Date(dateStr).toLocaleDateString('es-ES')}`);
                alert('‚úÖ Pago marcado como completado');
            }
        }

        function removePaymentDate(dateStr) {
            paymentConfig.scheduledDates = paymentConfig.scheduledDates.filter(date => date !== dateStr);
            paymentConfig.completedPayments = paymentConfig.completedPayments.filter(date => date !== dateStr);
            savePaymentConfig();
            updateCalendar();
            addActivityLog('payment', 'Fecha Removida', `Programaci√≥n removida: ${new Date(dateStr).toLocaleDateString('es-ES')}`);
            alert('‚úÖ Programaci√≥n removida');
        }

        function savePaymentConfig() {
            localStorage.setItem('paymentConfig', JSON.stringify(paymentConfig));
        }

        function loadPaymentConfig() {
            const saved = localStorage.getItem('paymentConfig');
            if (saved) {
                paymentConfig = { ...paymentConfig, ...JSON.parse(saved) };
            }
            updatePaymentConfigDisplay();
        }

        function updatePaymentConfigDisplay() {
            const paymentDayConfig = document.getElementById('payment-day-config');
            const autoPaymentReset = document.getElementById('auto-payment-reset');
            
            if (paymentDayConfig) {
                paymentDayConfig.textContent = paymentConfig.paymentDay;
            }
            
            if (autoPaymentReset) {
                autoPaymentReset.checked = paymentConfig.autoReset;
            }
        }

        function changePaymentDay() {
            const newDay = prompt('¬øQu√© d√≠a del mes debe ser el pago autom√°tico?\n(Ingresa un n√∫mero del 1 al 31):', paymentConfig.paymentDay);
            
            if (newDay && !isNaN(newDay) && newDay >= 1 && newDay <= 31) {
                paymentConfig.paymentDay = parseInt(newDay);
                savePaymentConfig();
                updateCalendar();
                addActivityLog('config', 'D√≠a de Pago Cambiado', `Nuevo d√≠a de pago: ${newDay}`);
                alert(`‚úÖ D√≠a de pago cambiado al ${newDay} de cada mes`);
            }
        }

        function toggleAutoPaymentReset() {
            const checkbox = document.getElementById('auto-payment-reset');
            paymentConfig.autoReset = checkbox.checked;
            savePaymentConfig();
            addActivityLog('config', 'Auto-Reset Cambiado', `Auto-reset ${paymentConfig.autoReset ? 'activado' : 'desactivado'}`);
        }

        function configurePaymentDates() {
            const config = `
            ‚öôÔ∏è CONFIGURACI√ìN DE FECHAS DE PAGO
            
            üìÖ D√≠a autom√°tico: ${paymentConfig.paymentDay} de cada mes
            üîÑ Auto-reset: ${paymentConfig.autoReset ? 'Activado' : 'Desactivado'}
            üìã Fechas programadas: ${paymentConfig.scheduledDates.length}
            üí∞ Pagos completados: ${paymentConfig.completedPayments.length}
            
            üí° INSTRUCCIONES:
            - Haz clic en cualquier d√≠a del calendario para programarlo
            - El d√≠a ${paymentConfig.paymentDay} de cada mes se marca autom√°ticamente
            - Los pagos se reinician autom√°ticamente cada mes
            
            ¬øDeseas restablecer toda la configuraci√≥n?
            `;
            
            if (confirm(config)) {
                if (confirm('‚ö†Ô∏è ¬øEst√°s seguro? Esto eliminar√° todas las fechas programadas')) {
                    paymentConfig = {
                        autoReset: true,
                        paymentDay: 15,
                        scheduledDates: [],
                        completedPayments: []
                    };
                    savePaymentConfig();
                    updateCalendar();
                    addActivityLog('config', 'Config Restablecida', 'Configuraci√≥n de pagos restablecida');
                    alert('‚úÖ Configuraci√≥n restablecida');
                }
            }
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            updateCalendar();
            
            // Auto-reset mensual si est√° activado
            if (paymentConfig.autoReset && direction === 1) {
                autoResetMonthlyPayments();
            }
        }

        function autoResetMonthlyPayments() {
            const currentMonth = currentDate.toISOString().slice(0, 7); // YYYY-MM
            const hasPaymentsThisMonth = paymentConfig.completedPayments.some(date => date.startsWith(currentMonth));
            
            if (!hasPaymentsThisMonth && paymentConfig.autoReset) {
                // Reiniciar todos los profesores a pendiente al entrar a un nuevo mes
                if (teachers.length > 0) {
                    setTimeout(() => {
                        if (confirm('üîÑ ¬øReiniciar el estado de pagos para el nuevo mes?\n\nTodos los profesores se marcar√°n como pendientes.')) {
                            resetAllPaymentsForNewMonth();
                        }
                    }, 1000);
                }
            }
        }

        async function resetAllPaymentsForNewMonth() {
            try {
                for (const teacher of teachers.filter(t => t.is_paid)) {
                    await fetch(`/api/teachers/${teacher.id}/toggle-payment`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ is_paid: false })
                    });
                }
                
                await loadTeachers();
                updateStats();
                addActivityLog('payment', 'Reset Mensual', 'Pagos reiniciados para el nuevo mes');
                alert('‚úÖ Pagos reiniciados para el nuevo mes');
            } catch (error) {
                console.error('Error reiniciando pagos:', error);
                alert('‚ùå Error al reiniciar pagos');
            }
        }

        // ========================================
        // GESTI√ìN DE SESIONES
        // ========================================
        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions/active');
                const data = await response.json();
                
                if (data.success) {
                    sessions = data.data;
                } else {
                    sessions = [];
                }
            } catch (error) {
                console.error('Error cargando sesiones:', error);
                sessions = [];
            }
            
            renderSessionsTable();
        }

        function renderSessionsTable() {
            const container = document.getElementById('sessions-table-container');
            
            if (sessions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #64748b;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üîí</div>
                        <h3>No hay sesiones activas</h3>
                        <p>Ning√∫n profesor tiene sesi√≥n iniciada en este momento</p>
                    </div>
                `;
                return;
            }
            
            const tableHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Profesor</th>
                                <th>Email</th>
                                <th>IP</th>
                                <th>√öltima Actividad</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sessions.map(session => `
                                <tr>
                                    <td><strong>${session.teacher_name}</strong></td>
                                    <td>${session.email}</td>
                                    <td><code>${session.ip || 'N/A'}</code></td>
                                    <td>${getTimeAgo(new Date(session.last_activity))}</td>
                                    <td>
                                        <span class="status-indicator ${session.status === 'active' ? 'status-active' : 'status-inactive'}">
                                            ${session.status === 'active' ? 'üü¢ Activo' : 'üü° Inactivo'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" onclick="disconnectSession(${session.id})">
                                            üö™ Desconectar
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHTML;
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            
            if (minutes < 1) return 'Ahora mismo';
            if (minutes < 60) return `Hace ${minutes} min`;
            
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `Hace ${hours} hora${hours > 1 ? 's' : ''}`;
            
            const days = Math.floor(hours / 24);
            return `Hace ${days} d√≠a${days > 1 ? 's' : ''}`;
        }

        async function disconnectSession(sessionId) {
            if (confirm('¬øDesconectar esta sesi√≥n?')) {
                try {
                    // Buscar el token de la sesi√≥n
                    const session = sessions.find(s => s.id === sessionId);
                    if (session) {
                        const response = await fetch('/api/teachers/logout', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                sessionToken: session.session_token
                            })
                        });
                        
                        if (response.ok) {
                            // Actualizar la lista
                            await loadSessions();
                            updateStats();
                            addActivityLog('session', 'Sesi√≥n Desconectada', `Sesi√≥n de ${session.teacher_name} terminada por administrador`);
                        } else {
                            alert('Error desconectando sesi√≥n');
                        }
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error desconectando sesi√≥n');
                }
            }
        }

        function refreshSessions() {
            loadSessions();
            updateStats(); // Actualizar estad√≠sticas tambi√©n
            addActivityLog('refresh', 'Actualizaci√≥n Manual', 'Estado de sesiones actualizado manualmente');
            
            // Mostrar feedback visual
            const button = document.querySelector('button[onclick="refreshSessions()"]');
            if (button) {
                const originalText = button.innerHTML;
                button.innerHTML = 'üîÑ Actualizando...';
                button.disabled = true;
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 1000);
            }
        }

        // ========================================
        // ESTAD√çSTICAS
        // ========================================
        function updateStats() {
            document.getElementById('total-teachers').textContent = teachers.length;
            document.getElementById('active-sessions').textContent = sessions.filter(s => s.status === 'active').length;
            document.getElementById('paid-teachers').textContent = teachers.filter(t => t.is_paid).length;
            document.getElementById('unpaid-teachers').textContent = teachers.filter(t => !t.is_paid).length;
        }

        // ========================================
        // LOG DE ACTIVIDAD
        // ========================================
        function addActivityLog(type, title, description) {
            const log = {
                id: Date.now(),
                type,
                title,
                description,
                timestamp: new Date()
            };
            
            // Obtener logs existentes del localStorage
            const existingLogs = JSON.parse(localStorage.getItem('adminActivityLog') || '[]');
            existingLogs.unshift(log); // Agregar al inicio
            
            // Mantener solo los √∫ltimos 50 logs
            if (existingLogs.length > 50) {
                existingLogs.splice(50);
            }
            
            localStorage.setItem('adminActivityLog', JSON.stringify(existingLogs));
            loadActivityLog();
        }

        function loadActivityLog() {
            const logs = JSON.parse(localStorage.getItem('adminActivityLog') || '[]');
            const container = document.getElementById('activity-log');
            
            if (logs.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #64748b;">No hay actividad registrada</p>';
                return;
            }
            
            const logHTML = logs.map(log => {
                const iconMap = {
                    status: 'üîÑ',
                    payment: 'üí∞',
                    session: 'üîí',
                    refresh: 'üîÑ',
                    report: 'üìä',
                    error: '‚ùå'
                };
                
                return `
                    <div class="log-entry">
                        <div class="log-icon">${iconMap[log.type] || 'üìù'}</div>
                        <div class="log-content">
                            <div class="log-title">${log.title}</div>
                            <div class="log-details">${log.description}</div>
                        </div>
                        <div class="log-time">${new Date(log.timestamp).toLocaleString()}</div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = logHTML;
        }

        function clearActivityLog() {
            if (confirm('¬øLimpiar todo el log de actividad?')) {
                localStorage.removeItem('adminActivityLog');
                loadActivityLog();
                addActivityLog('system', 'Log Limpiado', 'Historial de actividad eliminado');
            }
        }

        // ========================================
        // UTILIDADES
        // ========================================
        function logoutAdmin() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar la sesi√≥n administrativa?')) {
                sessionStorage.removeItem('adminSession');
                sessionStorage.removeItem('adminUser');
                addActivityLog('session', 'Logout Admin', 'Sesi√≥n administrativa cerrada');
                window.location.href = 'dashboard.html';
            }
        }

        // Agregar log inicial
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                addActivityLog('session', 'Login Admin', 'Sesi√≥n administrativa iniciada');
            }, 1000);
        });
    </script>
</body>
</html>