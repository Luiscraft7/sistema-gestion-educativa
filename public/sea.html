<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEA - Sistema de Evaluaci√≥n Acad√©mica</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 12px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 18px;
            opacity: 0.9;
            font-weight: 300;
        }

        .filters-section {
            padding: 30px 40px;
            background: linear-gradient(135deg, #f8fbff 0%, #f0f4f8 100%);
            border-bottom: 1px solid #e2e8f0;
        }

        .filters-row {
            display: grid;
            grid-template-columns: 1fr 1fr 200px 150px;
            gap: 20px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2d3748;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-select, .btn {
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            font-weight: 500;
        }

        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .form-select:hover {
            border-color: #a0aec0;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 13px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #718096, #4a5568);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(113, 128, 150, 0.3);
        }

        .content-section {
            padding: 40px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .summary-card {
            background: white;
            padding: 30px 25px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .summary-card:hover::before {
            transform: scaleX(1);
        }

        .summary-card h3 {
            font-size: 36px;
            color: #667eea;
            margin-bottom: 12px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .summary-card p {
            color: #4a5568;
            font-weight: 500;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .table-container {
            overflow-x: auto;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            margin-top: 30px;
            background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        .sea-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .sea-table th {
            background: linear-gradient(135deg, #1a202c, #2d3748);
            color: white;
            padding: 20px 15px;
            text-align: center;
            font-weight: 600;
            border: none;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 13px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .sea-table th small {
            font-size: 11px;
            opacity: 0.8;
            font-weight: 400;
            text-transform: none;
            display: block;
            margin-top: 4px;
        }

        .sea-table td {
            padding: 16px 15px;
            text-align: center;
            border: 1px solid #f7fafc;
            vertical-align: middle;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .sea-table tbody tr:nth-child(even) {
            background: #f8fafc;
        }

        .sea-table tbody tr:hover {
            background: #e6fffa;
            transform: scale(1.01);
        }

        .student-name {
            text-align: left !important;
            font-weight: 600;
            color: #2d3748;
            font-size: 15px;
        }

        .grade-cell {
            font-weight: 600;
            position: relative;
        }

        .grade-excellent {
            color: #22543d;
            background: linear-gradient(135deg, #d4f4dd, #b8e6c1);
            border-radius: 8px;
            padding: 6px 12px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.15);
        }

        .grade-good {
            color: #7c2d12;
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-radius: 8px;
            padding: 6px 12px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.15);
        }

        .grade-poor {
            color: #7f1d1d;
            background: linear-gradient(135deg, #fecaca, #fca5a5);
            border-radius: 8px;
            padding: 6px 12px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.15);
        }

        .grade-missing {
            color: #a0aec0;
            font-style: italic;
            opacity: 0.7;
            font-weight: 400;
        }

        .evaluation-column {
            min-width: 120px;
            position: relative;
        }

        .evaluation-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .evaluation-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .evaluation-title {
            font-weight: 600;
            font-size: 12px;
        }

        .evaluation-subtitle {
            font-size: 10px;
            opacity: 0.8;
        }

        /* Columnas especiales con colores m√°s pasteles y menos saturados */
        .cotidiano-column {
            background: linear-gradient(135deg, #4a6741, #68a085) !important;
            border-left: 5px solid #22543d !important;
            font-weight: 600;
            position: relative;
            color: white !important;
        }

        .cotidiano-column::before {
            content: "üìä";
            position: absolute;
            top: 8px;
            left: 8px;
            font-size: 16px;
        }

        .attendance-column {
            background: linear-gradient(135deg, #4a6741, #68a085) !important;
            border-left: 5px solid #22543d !important;
            font-weight: 600;
            position: relative;
            color: white !important;
        }

        .attendance-column::before {
            content: "üìÖ";
            position: absolute;
            top: 8px;
            left: 8px;
            font-size: 16px;
        }

        .total-column {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe) !important;
            border-left: 5px solid #3b82f6 !important;
            font-weight: 700;
            font-size: 16px;
            position: relative;
        }

        .total-column::before {
            content: "üéØ";
            position: absolute;
            top: 8px;
            left: 8px;
            font-size: 18px;
        }

        /* Headers mejorados para columnas especiales */
        .cotidiano-header, .attendance-header, .total-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 5px;
        }

        .cotidiano-header .column-title, 
        .cotidiano-header .column-subtitle,
        .attendance-header .column-title, 
        .attendance-header .column-subtitle {
            color: white !important;
        }

        .column-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .column-title {
            font-weight: 700;
            font-size: 14px;
            line-height: 1.2;
        }

        .column-subtitle {
            font-size: 11px;
            opacity: 0.9;
            font-weight: 400;
        }

        .loading {
            text-align: center;
            padding: 80px 20px;
            color: #4a5568;
        }

        .loading h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 24px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: linear-gradient(135deg, #fed7d7, #fc8181);
            color: #742a2a;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid #fc8181;
            border-left: 6px solid #e53e3e;
            box-shadow: 0 4px 20px rgba(229, 62, 62, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #4a5568;
        }

        .empty-state h3 {
            font-size: 28px;
            margin-bottom: 20px;
            color: #2d3748;
            font-weight: 600;
        }

        .empty-state p {
            font-size: 18px;
            line-height: 1.6;
            max-width: 500px;
            margin: 0 auto;
        }

        .back-button {
            margin-bottom: 25px;
        }

        /* Tooltips */
        .tooltip {
            position: relative;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #2d3748;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        /* Responsive Design Mejorado */
        @media (max-width: 1024px) {
            .filters-row {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .content-section {
                padding: 25px;
            }
        }

        @media (max-width: 768px) {
            .filters-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .filters-section {
                padding: 20px 25px;
            }
            
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .sea-table {
                font-size: 12px;
            }
            
            .sea-table th,
            .sea-table td {
                padding: 12px 8px;
            }
            
            .table-container {
                border-radius: 12px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .header {
                padding: 30px 25px;
            }

            .header h1 {
                font-size: 26px;
            }
        }

        @media (max-width: 480px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .sea-table th,
            .sea-table td {
                padding: 8px 6px;
                font-size: 11px;
            }

            .summary-card {
                padding: 20px 15px;
            }

            .summary-card h3 {
                font-size: 28px;
            }

            .content-section {
                padding: 20px;
            }
        }

        /* Animaciones mejoradas */
        .summary-card, .btn, .form-select {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Scrollbar personalizada para mejor UX */
        .table-container::-webkit-scrollbar {
            height: 10px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 5px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 5px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
        }

        /* Efectos de focus mejorados para accesibilidad */
        .btn:focus, .form-select:focus {
            outline: 3px solid rgba(102, 126, 234, 0.3);
            outline-offset: 2px;
        }

        /* Indicadores de progreso */
        .progress-indicator {
            position: absolute;
            top: 0;
            left: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* INDICADOR SIMPLE DE PER√çODO ACAD√âMICO */
        .period-indicator-banner {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            margin: 15px 0 25px 0;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .period-icon {
            font-size: 20px;
            color: rgba(255, 255, 255, 0.9);
        }

        .period-text {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .period-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .period-info {
            font-size: 16px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .period-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .period-badge .pulse {
            color: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        @media (max-width: 768px) {
            .period-indicator-banner {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .period-text {
                align-items: center;
            }

            .period-info {
                font-size: 14px;
            }
        }

        .period-indicator-banner.loading {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }

        .period-indicator-banner.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .period-indicator-banner.outdated {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
    </style>
</head>
<body>
    <script src="js/global-period-selector.js"></script>
    <div class="container">
        <!-- Header Mejorado -->
        <div class="header">
            <div class="header-content">
                <h1>üéØ SEA - Sistema de Evaluaci√≥n Acad√©mica</h1>
                <p>Vista consolidada de evaluaciones, cotidiano y asistencia con an√°lisis avanzado</p>
            </div>
            <div class="period-indicator-banner">
                <div class="period-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="period-text">
                    <span class="period-label">Per√≠odo Acad√©mico Activo:</span>
                    <span class="period-info" id="activePeriodDisplay">Luis Alfonso Carrera Mar√≠n - 2025 - Primer Semestre - San Marcos</span>
                </div>
                <div class="period-badge">
                    <i class="fas fa-circle pulse"></i>
                    <span>Activo</span>
                </div>
            </div>
        </div>

        <!-- Filters Section Mejorada -->
        <div class="filters-section">
            <div class="back-button">
                <button class="btn btn-secondary" onclick="window.location.href='dashboard.html'">
                    ‚Üê Volver
                </button>
            </div>
            
            <div class="filters-row">
                <div class="form-group">
                    <label for="gradeSelect">
                        üìö Grado Acad√©mico:
                    </label>
                    <select id="gradeSelect" class="form-select">
                        <option value="">Seleccione un grado...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="subjectSelect">
                        üî¨ Materia/Asignatura:
                    </label>
                    <select id="subjectSelect" class="form-select">
                        <option value="">Seleccione una materia...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button class="btn" onclick="loadSEAData()">
                        üîç Cargar SEA
                    </button>
                </div>
                
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-secondary" onclick="exportSEAData()">
                        üìÑ Exportar
                    </button>
                </div>
            </div>
        </div>

        <!-- Content Section -->
        <div class="content-section">
            <!-- Summary Cards Mejoradas -->
            <div class="summary-cards" id="summaryCards" style="display: none;">
                <div class="summary-card tooltip" data-tooltip="Cantidad total de estudiantes registrados">
                    <h3 id="totalStudents">0</h3>
                    <p>üë• Estudiantes Activos</p>
                </div>
                <div class="summary-card tooltip" data-tooltip="N√∫mero total de evaluaciones configuradas">
                    <h3 id="totalEvaluations">0</h3>
                    <p>üìù Evaluaciones Activas</p>
                </div>
                <div class="summary-card tooltip" data-tooltip="Ponderaci√≥n de la asistencia en el total">
                    <h3 id="attendanceWeight">10</h3>
                    <p>üìÖ Peso Asistencia (%)</p>
                </div>
                <div class="summary-card tooltip" data-tooltip="Ponderaci√≥n del cotidiano en el total">
                    <h3 id="cotidianoWeight">65</h3>
                    <p>üìä Peso Cotidiano (%)</p>
                </div>
                <div class="summary-card tooltip" data-tooltip="Total de ponderaci√≥n configurada">
                    <h3 id="totalPercentage">0</h3>
                    <p>üéØ Total Configurado (%)</p>
                </div>
            </div>

            <!-- Main Table Mejorada -->
            <div id="tableContainer">
                <div class="empty-state">
                    <h3>üéØ Bienvenido al M√≥dulo SEA Avanzado</h3>
                    <p>Seleccione un grado y materia para visualizar la evaluaci√≥n consolidada con an√°lisis detallado</p>
                    <p style="margin-top: 15px; font-size: 16px; color: #667eea; font-weight: 600;">
                        ‚ú® SEA integra evaluaciones, cotidiano y asistencia en una vista unificada
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;

        // Cargar al inicializar
        document.addEventListener('DOMContentLoaded', function() {
            const start = () => {
                loadGradeSubjects();
                // Limpiar animaciones al salir de la p√°gina
                window.addEventListener('beforeunload', clearAllAnimations);
            };
            if (window.globalPeriodSelector && window.globalPeriodSelector.isInitialized) {
                start();
            } else {
                const handler = () => {
                    window.removeEventListener('academicPeriodChanged', handler);
                    if (window.globalPeriodSelector && window.globalPeriodSelector.isInitialized) {
                        start();
                    }
                };
                window.addEventListener('academicPeriodChanged', handler, { once: true });
            }
        });

        // Funci√≥n para obtener icono seg√∫n tipo de evaluaci√≥n
        function getEvaluationIcon(type) {
            const icons = {
                'tarea': 'üìù',
                'examen': 'üìã',
                'proyecto': 'üé®',
                'quiz': 'üß©',
                'default': 'üìÑ'
            };
            return icons[type] || icons.default;
        }

        // Funci√≥n para obtener color seg√∫n tipo de evaluaci√≥n
        function getEvaluationColor(type) {
            const colors = {
                'tarea': '#667eea',
                'examen': '#f56565',
                'proyecto': '#48bb78',
                'quiz': '#ed8936',
                'default': '#718096'
            };
            return colors[type] || colors.default;
        }

        // Cargar combinaciones de grado-materia disponibles
        async function loadGradeSubjects() {
            try {
                const period = getCurrentAcademicPeriod();
                if (!period) {
                    showError('Per√≠odo acad√©mico no disponible');
                    return;
                }
                const params = new URLSearchParams();
                if (period.periodId) {
                    params.append('academic_period_id', period.periodId);
                }
                const url = `/api/sea/grade-subjects?${params.toString()}`;
                const response = await authenticatedFetch(url);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const grades = [...new Set(result.data.map(item => item.grade_level))].sort();
                    const gradeSelect = document.getElementById('gradeSelect');
                    
                    gradeSelect.innerHTML = '<option value="">Seleccione un grado...</option>';
                    grades.forEach(grade => {
                        gradeSelect.innerHTML += `<option value="${grade}">${grade}</option>`;
                    });
                    
                    // Event listener para cargar materias cuando se seleccione grado
                    gradeSelect.addEventListener('change', function() {
                        const selectedGrade = this.value;
                        const subjects = result.data
                            .filter(item => item.grade_level === selectedGrade)
                            .map(item => item.subject_area)
                            .sort();
                            
                        const subjectSelect = document.getElementById('subjectSelect');
                        subjectSelect.innerHTML = '<option value="">Seleccione una materia...</option>';
                        
                        subjects.forEach(subject => {
                            subjectSelect.innerHTML += `<option value="${subject}">${subject}</option>`;
                        });
                    });
                }
            } catch (error) {
                console.error('Error cargando grados-materias:', error);
                showError('Error cargando lista de grados y materias');
            }
        }

        window.loadGradeSubjects = loadGradeSubjects;

        // Cargar datos SEA
        async function loadSEAData() {
            const grade = document.getElementById('gradeSelect').value;
            const subject = document.getElementById('subjectSelect').value;
            
            if (!grade || !subject) {
                alert('Por favor seleccione grado y materia');
                return;
            }

            // Limpiar animaciones anteriores
            clearAllAnimations();
            
            showLoading();

            try {
                const period = getCurrentAcademicPeriod();
                if (!period) {
                    showError('Per√≠odo acad√©mico no disponible');
                    return;
                }
                const params = new URLSearchParams({
                    grade: grade,
                    subject: subject
                });
                if (period.periodId) {
                    params.append('academic_period_id', period.periodId);
                }
                const url = `/api/sea/consolidated?${params.toString()}`;
                const response = await authenticatedFetch(url);
                const result = await response.json();
                
                if (result.success) {
                    currentData = result.data;
                    displaySEAData(result.data);
                } else {
                    showError(result.message || 'Error cargando datos SEA');
                }
            } catch (error) {
                console.error('Error cargando datos SEA:', error);
                showError('Error de conexi√≥n al cargar datos SEA');
            }
        }

        window.loadSEAData = loadSEAData;

        // Funci√≥n para limpiar todas las animaciones activas
        function clearAllAnimations() {
            Object.keys(activeAnimations).forEach(animationId => {
                if (activeAnimations[animationId]) {
                    clearInterval(activeAnimations[animationId]);
                    activeAnimations[animationId] = null;
                }
            });
        }

        // Mostrar datos SEA en la tabla mejorada
        function displaySEAData(data) {
            updateSummaryCards(data.summary);
            
            if (!data.students || data.students.length === 0) {
                document.getElementById('tableContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>üì≠ No hay datos disponibles</h3>
                        <p>No se encontraron estudiantes con evaluaciones para esta combinaci√≥n de grado y materia</p>
                    </div>
                `;
                return;
            }

            // Obtener configuraci√≥n de pesos
            const weightConfig = data.weight_config || { cotidiano_weight: 25, attendance_weight: 5 };

            // Construir tabla con dise√±o mejorado
            let tableHTML = `
                <div class="table-container">
                    <table class="sea-table">
                        <thead>
                            <tr>
                                <th rowspan="2">üÜî C√©dula/ID</th>
                                <th rowspan="2">üë• Estudiante</th>
                                <th rowspan="2" class="attendance-column">
                                    <div class="attendance-header">
                                        <div class="column-icon">üìÖ</div>
                                        <div class="column-title">ASISTENCIA</div>
                                        <div class="column-subtitle">(${weightConfig.attendance_weight}%)</div>
                                    </div>
                                </th>
                                <th rowspan="2" class="cotidiano-column">
                                    <div class="cotidiano-header">
                                        <div class="column-icon">üìä</div>
                                        <div class="column-title">COTIDIANO</div>
                                        <div class="column-subtitle">(${weightConfig.cotidiano_weight}%)</div>
                                    </div>
                                </th>`;
            
            // Headers de evaluaciones con iconos din√°micos
            if (data.evaluations_list && data.evaluations_list.length > 0) {
                tableHTML += `<th colspan="${data.evaluations_list.length}">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 20px;">üìùüìã</span>
                        <span>EVALUACIONES</span>
                    </div>
                </th>`;
            }
            
            tableHTML += `
                                <th rowspan="2" class="total-column">
                                    <div class="total-header">
                                        <div class="column-icon">üéØ</div>
                                        <div class="column-title">TOTAL SEA</div>
                                        <div class="column-subtitle">(/100%)</div>
                                    </div>
                                </th>
                            </tr>
                            <tr>`;
            
            // Nombres de evaluaciones individuales con iconos
            if (data.evaluations_list && data.evaluations_list.length > 0) {
                data.evaluations_list.forEach(eval => {
                    const icon = getEvaluationIcon(eval.type);
                    const color = getEvaluationColor(eval.type);
                    tableHTML += `
                        <th class="evaluation-column" style="border-left: 3px solid ${color};">
                            <div class="evaluation-header">
                                <div class="evaluation-icon">${icon}</div>
                                <div class="evaluation-title">${eval.title}</div>
                                <div class="evaluation-subtitle">${eval.percentage}%</div>
                            </div>
                        </th>`;
                });
            }
            
            tableHTML += `</tr>
                        </thead>
                        <tbody>`;

            // Filas de estudiantes con dise√±o mejorado
            data.students.forEach((student, index) => {
                tableHTML += `
                    <tr style="animation: fadeInUp 0.3s ease ${index * 0.05}s both;">
                        <td>${student.student_cedula || student.student_code || '-'}</td>
                        <td class="student-name">${student.student_name}</td>`;
                
                // Nota de asistencia mejorada con colores din√°micos
                const attendanceGrade = student.attendance.grade_0_5 !== 'Sin datos' ? 
                    student.attendance.grade_0_5 : 'Sin datos';
                const attendanceClass = attendanceGrade !== 'Sin datos' ? 
                    getDynamicGradeClass(parseFloat(attendanceGrade), 5) : 'grade-missing';
                tableHTML += `<td class="attendance-column ${attendanceClass}" data-tooltip="Asistencia: ${student.attendance.attendance_percentage || 'N/A'}%">${attendanceGrade}</td>`;
                
                // Nota de cotidiano mejorada con colores din√°micos
                const cotidianoClass = student.cotidiano.total_grade !== 'Sin datos' ?
                    getDynamicGradeClass(parseFloat(student.cotidiano.total_grade), weightConfig.cotidiano_weight || 65) : 'grade-missing';
                tableHTML += `<td class="cotidiano-column ${cotidianoClass}" data-tooltip="Cotidiano total">${student.cotidiano.total_grade}</td>`;
                
                // Calificaciones de evaluaciones con colores din√°micos
                if (data.evaluations_list && data.evaluations_list.length > 0) {
                    data.evaluations_list.forEach(eval => {
                        const evalGrade = student.evaluations[eval.title];
                        const icon = getEvaluationIcon(eval.type);
                        if (evalGrade && evalGrade.grade !== 'Sin calificar') {
                            const gradeClass = getDynamicGradeClass(parseFloat(evalGrade.grade), eval.percentage);
                            tableHTML += `<td class="grade-cell ${gradeClass}" data-tooltip="${eval.title}: ${evalGrade.grade}/${eval.percentage}">${evalGrade.grade}</td>`;
                        } else {
                            tableHTML += `<td class="grade-missing" data-tooltip="No calificado">Sin calificar</td>`;
                        }
                    });
                }
                
                // Total SEA mejorado con c√°lculo din√°mico
                let totalSEA = 0;
                let hasData = false;
                
                // Sumar asistencia
                if (attendanceGrade !== 'Sin datos') {
                    totalSEA += parseFloat(attendanceGrade);
                    hasData = true;
                }
                
                // Sumar cotidiano
                if (student.cotidiano.total_grade !== 'Sin datos') {
                    totalSEA += parseFloat(student.cotidiano.total_grade);
                    hasData = true;
                }
                
                // Sumar evaluaciones
                if (data.evaluations_list && data.evaluations_list.length > 0) {
                    data.evaluations_list.forEach(eval => {
                        const evalGrade = student.evaluations[eval.title];
                        if (evalGrade && evalGrade.grade !== 'Sin calificar') {
                            totalSEA += parseFloat(evalGrade.grade);
                            hasData = true;
                        }
                    });
                }
                
                const totalSEADisplay = hasData ? totalSEA.toFixed(1) : 'Sin datos';
                const totalClass = hasData ? getGradeClass(totalSEA, 100) : 'grade-missing';
                
                tableHTML += `
                    <td class="total-column ${totalClass}" data-tooltip="Total acumulado: ${totalSEADisplay}/100">
                        <strong style="font-size: 16px;">${totalSEADisplay}</strong>
                    </td>`;
                
                tableHTML += `</tr>`;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>`;

            document.getElementById('tableContainer').innerHTML = tableHTML;
            document.getElementById('summaryCards').style.display = 'grid';

            // Agregar animaci√≥n de entrada
            const tableRows = document.querySelectorAll('.sea-table tbody tr');
            tableRows.forEach((row, index) => {
                setTimeout(() => {
                    row.style.opacity = '1';
                    row.style.transform = 'translateY(0)';
                }, index * 50);
            });
        }

        // Actualizar tarjetas de resumen
        function updateSummaryCards(summary) {
            // Primero actualizar los valores sin animaci√≥n para evitar bugs
            document.getElementById('totalStudents').textContent = summary.total_students;
            document.getElementById('totalEvaluations').textContent = summary.total_evaluations;
            
            // Calcular total configurado
            const evaluationsTotal = summary.total_percentage_configured || 0;
            const cotidianoValue = summary.cotidiano_weight || 65;
            const attendanceValue = summary.attendance_weight || 10;
            const grandTotal = evaluationsTotal + cotidianoValue + attendanceValue;
            
            document.getElementById('totalPercentage').textContent = grandTotal;
            document.getElementById('cotidianoWeight').textContent = cotidianoValue;
            document.getElementById('attendanceWeight').textContent = attendanceValue;

            // Animar solo n√∫meros que tienen sentido animar (evitar -2460 y valores locos)
            if (summary.total_students > 0) {
                animateNumber('totalStudents', 0, summary.total_students, 800);
            }
            
            if (summary.total_evaluations > 0) {
                animateNumber('totalEvaluations', 0, summary.total_evaluations, 800);
            }
            
            if (grandTotal > 0) {
                animateNumber('totalPercentage', 0, grandTotal, 800);
            }
        }

        // Variables globales para controlar animaciones
        let activeAnimations = {};

        // Animaci√≥n de n√∫meros mejorada y corregida
        function animateNumber(elementId, start, end, duration) {
            const element = document.getElementById(elementId);
            
            // Limpiar animaci√≥n anterior si existe
            if (activeAnimations[elementId]) {
                clearInterval(activeAnimations[elementId]);
                activeAnimations[elementId] = null;
            }
            
            // Si start y end son iguales, o si end es 0, mostrar directamente
            if (start === end || end === 0) {
                element.textContent = end;
                return;
            }
            
            const range = Math.abs(end - start);
            const increment = end > start ? 1 : -1;
            const stepTime = Math.max(Math.floor(duration / range), 1); // M√≠nimo 1ms
            let current = start;
            
            activeAnimations[elementId] = setInterval(() => {
                current += increment;
                element.textContent = current;
                
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    element.textContent = end; // Asegurar valor final
                    clearInterval(activeAnimations[elementId]);
                    activeAnimations[elementId] = null;
                }
            }, stepTime);
        }

        // Clasificar calificaciones por color (mejorado con valor m√°ximo)
        function getGradeClass(grade, maxValue = 100) {
            const percentage = (grade / maxValue) * 100;
            if (percentage >= 85) return 'grade-excellent';
            if (percentage >= 70) return 'grade-good';
            return 'grade-poor';
        }

        // Clasificar calificaciones din√°micas por porcentaje real
        function getDynamicGradeClass(currentValue, maxValue) {
            const percentage = (currentValue / maxValue) * 100;
            if (percentage >= 90) return 'grade-excellent';
            if (percentage >= 75) return 'grade-good';
            return 'grade-poor';
        }

        // Mostrar loading mejorado
        function showLoading() {
            // Limpiar animaciones y resetear valores
            clearAllAnimations();
            
            // Resetear valores de las cards durante loading
            document.getElementById('totalStudents').textContent = '0';
            document.getElementById('totalEvaluations').textContent = '0';
            document.getElementById('totalPercentage').textContent = '0';
            
            document.getElementById('tableContainer').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <h3>üîÑ Procesando datos SEA...</h3>
                    <p>Consolidando evaluaciones, cotidiano y asistencia</p>
                </div>
            `;
            document.getElementById('summaryCards').style.display = 'none';
        }

        // Mostrar error mejorado
        function showError(message) {
            // Limpiar animaciones en caso de error
            clearAllAnimations();
            
            document.getElementById('tableContainer').innerHTML = `
                <div class="error">
                    <strong>‚ùå Error del Sistema:</strong> ${message}
                    <p style="margin-top: 10px; font-size: 14px;">Verifique la conexi√≥n y vuelva a intentar.</p>
                </div>
            `;
            document.getElementById('summaryCards').style.display = 'none';
        }

        // Exportar datos mejorado
        function exportSEAData() {
            if (!currentData) {
                alert('No hay datos para exportar. Cargue los datos SEA primero.');
                return;
            }
            
            // Implementar exportaci√≥n avanzada
            alert('üöÄ Funci√≥n de exportaci√≥n avanzada en desarrollo\n\nPr√≥ximamente:\n‚Ä¢ Excel con formato\n‚Ä¢ PDF con gr√°ficos\n‚Ä¢ Reportes personalizados');
        }

        // Agregar CSS para animaciones
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
    <script>
        class SimplePeriodIndicator {
            constructor() { this.init(); }

            init() {
                this.updateDisplay();
                this.setupEventListeners();
                console.log('üìÖ Indicador simple de per√≠odo inicializado');
            }

            setupEventListeners() {
                window.addEventListener('academicPeriodChanged', () => {
                    console.log('üìÖ Per√≠odo cambi√≥, actualizando indicador...');
                    this.updateDisplay();
                    this.reloadPageData();
                });

                window.addEventListener('reloadPeriodData', () => {
                    console.log('üîÑ Recargando datos por cambio de per√≠odo...');
                    this.updateDisplay();
                    this.reloadPageData();
                });
            }

            updateDisplay() {
                const display = document.getElementById('activePeriodDisplay');
                if (!display) return;
                try {
                    const currentPeriod = getCurrentAcademicPeriod();
                    const teacherData = this.getTeacherInfo();
                    const text = this.buildPeriodText(currentPeriod, teacherData);
                    display.textContent = text;
                    this.updateBannerState('active');
                } catch (err) {
                    console.error('Error actualizando indicador de per√≠odo:', err);
                    display.textContent = 'Error cargando per√≠odo acad√©mico';
                    this.updateBannerState('error');
                }
            }

            getTeacherInfo() {
                const data = sessionStorage.getItem('teacherData');
                if (data) {
                    try {
                        const teacher = JSON.parse(data);
                        return { name: teacher.name || teacher.full_name || 'Profesor',
                                 school: teacher.school || teacher.school_name || 'Mi Escuela' };
                    } catch (e) { console.warn('Error parseando teacherData:', e); }
                }
                return { name: 'Profesor', school: 'Mi Escuela' };
            }

            buildPeriodText(period, teacher) {
                const periodTypeName = period.periodType === 'semester' ? 'Semestre' : 'Trimestre';
                const periodNumber = period.periodNumber === 1 ? 'Primer' : period.periodNumber === 2 ? 'Segundo' : 'Tercer';
                return `${teacher.name} - ${period.year} - ${periodNumber} ${periodTypeName} - ${teacher.school}`;
            }

            updateBannerState(state) {
                const banner = document.querySelector('.period-indicator-banner');
                if (!banner) return;
                banner.classList.remove('loading', 'error', 'outdated');
                if (state !== 'active') banner.classList.add(state);
            }

            reloadPageData() {
                if (typeof window.loadGradeSubjects === 'function') {
                    console.log('üîÑ Recargando listas de grados y materias...');
                    window.loadGradeSubjects();
                }
                if (typeof window.loadSEAData === 'function') {
                    console.log('üîÑ Recargando datos SEA...');
                    window.loadSEAData();
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.simplePeriodIndicator = new SimplePeriodIndicator();
        });

        window.updatePeriodIndicator = function() {
            if (window.simplePeriodIndicator) {
                window.simplePeriodIndicator.updateDisplay();
            }
        };
    </script>
</body>
</html>