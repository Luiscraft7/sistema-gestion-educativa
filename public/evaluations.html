<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìù Evaluaciones - Sistema Educativo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1600px; margin: 0 auto; }
        
        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .header h1 { color: #333; font-size: 28px; margin-bottom: 5px; }
        .header p { color: #666; font-size: 14px; }
        
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .card-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }
        
        .card-body { padding: 20px; }
        
        .filter-group { margin-bottom: 15px; }
        
        .filter-label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }
        
        .filter-select, .form-input, .form-textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .filter-select:focus, .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .filter-select:disabled, .form-input:disabled {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }
        
        .evaluation-creator {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .evaluation-creator.hidden { display: none; }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group { margin-bottom: 15px; }
        
        .main-area {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .main-header {
            padding: 25px;
            border-bottom: 1px solid #eee;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .main-title { font-size: 24px; font-weight: 600; margin-bottom: 5px; }
        .main-subtitle { font-size: 14px; opacity: 0.9; }
        
        .loading-state, .empty-state {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .empty-state h3 { margin-bottom: 10px; color: #333; }
        
        .evaluations-list {
            padding: 20px;
        }
        
        .evaluation-item {
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .evaluation-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        }
        
        .evaluation-item.active {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .evaluation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .evaluation-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .evaluation-meta {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 12px;
            color: #666;
        }
        
        .evaluation-description {
            color: #666;
            margin: 10px 0;
            line-height: 1.5;
        }
        
        .evaluation-stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .evaluation-stat {
            text-align: center;
        }
        
        .evaluation-stat-number {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
        }
        
        .evaluation-stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }
        
        .evaluation-type-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 8px;
        }
        
        .type-tarea { background: #e3f2fd; color: #1976d2; }
        .type-examen { background: #fff3e0; color: #f57c00; }
        .type-proyecto { background: #e8f5e8; color: #388e3c; }
        .type-quiz { background: #fce4ec; color: #c2185b; }
        
        .students-table {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }
        
        tbody tr:hover { background: #f8f9fa; }
        
        .student-photo {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        .student-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }
        
        .student-id {
            color: #666;
            font-size: 11px;
        }
        
        .grade-input {
            width: 80px;
            padding: 6px 8px;
            border: 2px solid #e1e1e1;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
        }
        
        .grade-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .grade-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .points-display {
            font-size: 14px;
            font-weight: 600;
        }
        
        .percentage-display {
            font-size: 24px;
            font-weight: 700;
            padding: 8px 12px;
            border-radius: 8px;
            min-width: 60px;
            text-align: center;
        }
        
        .grade-A { background: #d4edda; color: #155724; }
        .grade-B { background: #d1ecf1; color: #0c5460; }
        .grade-C { background: #fff3cd; color: #856404; }
        .grade-D { background: #f8d7da; color: #721c24; }
        .grade-F { background: #f5c6cb; color: #721c24; }
        .grade-none { background: #e9ecef; color: #495057; }
        
        .quick-actions {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-input {
            width: 250px;
        }

        @media (max-width: 768px) {
            .search-input {
                width: 100%;
                margin-top: 10px;
            }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message.show { display: block; }

        /* INDICADOR SIMPLE DE PER√çODO ACAD√âMICO */
        .period-indicator-banner {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            margin: 15px 0 25px 0;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .period-icon {
            font-size: 20px;
            color: rgba(255, 255, 255, 0.9);
        }

        .period-text {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .period-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .period-info {
            font-size: 16px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .period-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .period-badge .pulse {
            color: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        @media (max-width: 768px) {
            .period-indicator-banner {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .period-text {
                align-items: center;
            }

            .period-info {
                font-size: 14px;
            }
        }

        .period-indicator-banner.loading {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }

        .period-indicator-banner.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .period-indicator-banner.outdated {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: 2;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .evaluation-stats {
                flex-direction: column;
                gap: 10px;
            }
        }

        .final-grade-display {
            text-align: center;
        }

        .final-percentage-display {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            min-width: 50px;
        }


    </style>
</head>
<body>
    <script src="js/global-period-selector.js"></script>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>üìù M√≥dulo de Evaluaciones</h1>
                <p>Gesti√≥n y calificaci√≥n de evaluaciones por grado y materia</p>
                <div class="period-indicator-banner">
                    <div class="period-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="period-text">
                        <span class="period-label">Per√≠odo Acad√©mico Activo:</span>
                        <span class="period-info" id="activePeriodDisplay">2025 - Primer Semestre - Escuela Las Flores</span>
                    </div>
                    <div class="period-badge">
                        <i class="fas fa-circle pulse"></i>
                        <span>Activo</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-success" onclick="exportGrades()" id="exportBtn" style="display: none;">
                    üìÑ Exportar Calificaciones
                </button>
                <a href="dashboard.html" class="btn btn-secondary">
                    ‚Üê Dashboard
                </a>
            </div>
        </div>

        <!-- Mensajes -->
        <div id="successMessage" class="message success">‚úÖ Operaci√≥n completada exitosamente</div>
        <div id="errorMessage" class="message error">‚ùå Error en la operaci√≥n</div>

        <!-- Contenido Principal -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Filtros -->
                <div class="card">
                    <div class="card-header">
                        üéØ Selecci√≥n de Curso
                    </div>
                    <div class="card-body">
                        <div class="filter-group">
                            <label class="filter-label">1. Seleccionar Grado:</label>
                            <select class="filter-select" id="gradeFilter" onchange="loadSubjectsForGrade()">
                                <option value="">Seleccionar grado...</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">2. Seleccionar Materia:</label>
                            <select class="filter-select" id="subjectFilter" onchange="loadStudentsAndEvaluations()" disabled>
                                <option value="">Primero seleccione un grado</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-primary" style="width: 100%;" onclick="loadStudentsAndEvaluations()" disabled id="loadBtn">
                                üîÑ Cargar Curso
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Crear Evaluaci√≥n -->
                <div class="card">
                    <div class="card-header">
                        ‚ûï Nueva Evaluaci√≥n
                    </div>
                    <div class="card-body">
                        <div class="evaluation-creator hidden" id="evaluationCreator">
                            <form id="evaluationForm" onsubmit="createEvaluation(event)">
                                <div class="form-group">
                                    <label class="filter-label">T√≠tulo de la Evaluaci√≥n:</label>
                                    <input type="text" class="form-input" id="evaluationTitle" placeholder="Ej: Examen de Matem√°ticas #1" required>
                                </div>
                                <div class="form-group">
                                    <label class="filter-label">Tipo de Evaluaci√≥n:</label>
                                    <select class="form-input" id="evaluationType" required>
                                        <option value="tarea">üìã Tarea</option>
                                        <option value="examen">üìä Examen</option>
                                        <option value="proyecto">üéØ Proyecto</option>
                                        <option value="quiz">‚ö° Quiz</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="filter-label">Descripci√≥n/Objetivo:</label>
                                    <textarea class="form-textarea" id="evaluationDescription" rows="3" placeholder="Describe el objetivo de la evaluaci√≥n..."></textarea>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="filter-label">% de la Nota Final:</label>
                                        <input type="number" class="form-input" id="evaluationPercentage" min="1" max="100" value="10" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="filter-label">Puntos M√°ximos:</label>
                                        <input type="number" class="form-input" id="evaluationMaxPoints" min="1" max="1000" value="100" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="filter-label">Fecha de Entrega (opcional):</label>
                                    <input type="date" class="form-input" id="evaluationDueDate">
                                    <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                        Puede agregarse despu√©s de revisar la evaluaci√≥n
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success" style="width: 100%;">
                                    üíæ Crear Evaluaci√≥n
                                </button>
                            </form>
                        </div>
                        <div id="evaluationCreatorPlaceholder">
                            <p style="color: #666; text-align: center; font-style: italic;">
                                Seleccione grado y materia para crear evaluaciones
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Estad√≠sticas -->
                <div class="card" id="statsCard" style="display: none;">
                    <div class="card-header">
                        üìä Estad√≠sticas del Curso
                    </div>
                    <div class="card-body">
                        <div class="evaluation-stats">
                            <div class="evaluation-stat">
                                <div class="evaluation-stat-number" id="totalStudents">0</div>
                                <div class="evaluation-stat-label">Estudiantes</div>
                            </div>
                            <div class="evaluation-stat">
                                <div class="evaluation-stat-number" id="totalEvaluations">0</div>
                                <div class="evaluation-stat-label">Evaluaciones</div>
                            </div>
                            <div class="evaluation-stat">
                                <div class="evaluation-stat-number" id="avgGrade">0%</div>
                                <div class="evaluation-stat-label">Promedio</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- √Årea Principal -->
            <div class="main-area">
                <!-- Header Principal -->
                <div class="main-header">
                    <div class="main-title" id="mainTitle">
                        üìù Gesti√≥n de Evaluaciones
                    </div>
                    <div class="main-subtitle" id="mainSubtitle">
                        Seleccione grado y materia para comenzar
                    </div>
                </div>

                <!-- Estados de Carga -->
                <div id="loadingState" class="loading-state">
                    üîÑ Seleccione grado y materia para cargar evaluaciones...
                </div>
                
                <div id="emptyState" class="empty-state" style="display: none;">
                    <h3>üìù No hay evaluaciones creadas</h3>
                    <p>Cree la primera evaluaci√≥n para este curso</p>
                </div>

                <!-- Lista de Evaluaciones -->
                <div id="evaluationsContainer" style="display: none;">
                    <div class="evaluations-list" id="evaluationsList">
                        <!-- Las evaluaciones se cargan aqu√≠ -->
                    </div>
                </div>

                <!-- Tabla de Calificaciones -->
                <div id="gradingContainer" style="display: none;">
                    <div class="quick-actions">
                        <span style="font-weight: 600; color: #333;">Calificando:</span>
                        <span id="currentEvaluationTitle" style="color: #667eea; font-weight: 600;"></span>
                        <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                            <input type="text" class="form-input search-input" id="studentSearch" placeholder="Buscar estudiante..." oninput="filterStudents()">
                            <button class="btn btn-success btn-sm" onclick="saveAllGrades()">
                                üíæ Guardar Todas las Calificaciones
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="closeGrading()">
                                ‚Üê Volver a Evaluaciones
                            </button>
                        </div>
                    </div>
                    
                    <div class="students-table">
                        <table id="gradingTable">
                            <thead>
                                <tr>
                                    <th>Estudiante</th>
                                    <th>Puntos Obtenidos</th>
                                    <th>Nota (0-100)</th>
                                    <th>% Ganado Nota Final</th>
                                    <th>Fecha Calificaci√≥n</th>
                                    <th>Observaciones</th>
                                </tr>
                            </thead>
                            <tbody id="gradingTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Evaluaci√≥n -->
    <div class="modal" id="editEvaluationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚úèÔ∏è Editar Evaluaci√≥n</h2>
                <button class="close-btn" onclick="closeEditEvaluationModal()">&times;</button>
            </div>
            
            <form id="editEvaluationForm" onsubmit="updateEvaluation(event)">
                <div class="form-group">
                    <label class="filter-label">T√≠tulo de la Evaluaci√≥n:</label>
                    <input type="text" class="form-input" id="editEvaluationTitle" required>
                </div>
                <div class="form-group">
                    <label class="filter-label">Tipo de Evaluaci√≥n:</label>
                    <select class="form-input" id="editEvaluationType" required>
                        <option value="tarea">üìã Tarea</option>
                        <option value="examen">üìä Examen</option>
                        <option value="proyecto">üéØ Proyecto</option>
                        <option value="quiz">‚ö° Quiz</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="filter-label">Descripci√≥n/Objetivo:</label>
                    <textarea class="form-textarea" id="editEvaluationDescription" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="filter-label">% de la Nota Final:</label>
                        <input type="number" class="form-input" id="editEvaluationPercentage" min="1" max="100" required>
                    </div>
                    <div class="form-group">
                        <label class="filter-label">Puntos M√°ximos:</label>
                        <input type="number" class="form-input" id="editEvaluationMaxPoints" min="1" max="1000" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="filter-label">Fecha de Entrega (opcional):</label>
                    <input type="date" class="form-input" id="editEvaluationDueDate">
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditEvaluationModal()">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="deleteEvaluation()">Eliminar Evaluaci√≥n</button>
                    <button type="submit" class="btn btn-primary">Actualizar Evaluaci√≥n</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========================================
        // VARIABLES GLOBALES
        // ========================================
        let currentGrade = '';
        let currentSubject = '';
        let students = [];
        let evaluations = [];
        let currentEvaluation = null;
        let currentEvaluationId = null;

        // Helper para peticiones autenticadas
        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('sessionToken');

            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            };

            const mergedOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...(options.headers || {})
                }
            };

            const response = await fetch(url, mergedOptions);

            if (response.status === 401) {
                localStorage.removeItem('sessionToken');
                localStorage.removeItem('teacherInfo');
                window.location.href = '/login.html';
                return;
            }

            return response;
        }

        // ========================================
        // INICIALIZACI√ìN
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando m√≥dulo de evaluaciones...');
            loadGrades();
        });

        // ========================================
        // CARGA DE DATOS
        // ========================================
        async function loadGrades() {
            try {
                console.log('üìö Cargando grados...');
                
                const response = await authenticatedFetch('/api/grades');
                const result = await response.json();
                
                const gradeFilter = document.getElementById('gradeFilter');
                gradeFilter.innerHTML = '<option value="">Seleccionar grado...</option>';
                
                if (result.success) {
                    result.data.forEach(grade => {
                        gradeFilter.innerHTML += `<option value="${grade.name}">${grade.name}</option>`;
                    });
                    console.log('‚úÖ Grados cargados:', result.data.length);
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando grados:', error);
                showMessage('error', 'Error cargando grados');
            }
        }

        async function loadSubjectsForGrade() {
            const grade = document.getElementById('gradeFilter').value;
            const subjectFilter = document.getElementById('subjectFilter');
            const loadBtn = document.getElementById('loadBtn');
            
            if (!grade) {
                subjectFilter.innerHTML = '<option value="">Primero seleccione un grado</option>';
                subjectFilter.disabled = true;
                loadBtn.disabled = true;
                hideEvaluationCreator();
                resetMainArea();
                return;
            }
            
            try {
                console.log('üìñ Cargando materias para grado:', grade);
                
                const response = await authenticatedFetch(`/api/grade-subjects/${encodeURIComponent(grade)}`);
                const result = await response.json();
                
                subjectFilter.innerHTML = '<option value="">Seleccionar materia...</option>';
                
                if (result.success && result.data.length > 0) {
                    result.data.forEach(assignment => {
                        subjectFilter.innerHTML += `<option value="${assignment.subject_name}">${assignment.subject_name}</option>`;
                    });
                    subjectFilter.disabled = false;
                    console.log('‚úÖ Materias cargadas:', result.data.length);
                } else {
                    subjectFilter.innerHTML = '<option value="">No hay materias asignadas a este grado</option>';
                    subjectFilter.disabled = true;
                }
                
                loadBtn.disabled = true;
                hideEvaluationCreator();
                resetMainArea();
                
            } catch (error) {
                console.error('‚ùå Error cargando materias:', error);
                showMessage('error', 'Error cargando materias para el grado');
            }
        }

        async function loadStudentsAndEvaluations() {
            const grade = document.getElementById('gradeFilter').value;
            const subject = document.getElementById('subjectFilter').value;
            
            if (!grade || !subject) {
                hideEvaluationCreator();
                resetMainArea();
                return;
            }
            
            currentGrade = grade;
            currentSubject = subject;
            
            try {
                console.log('üë• Cargando estudiantes y evaluaciones...', { grade, subject });
                
                // Actualizar interfaz
                document.getElementById('mainTitle').textContent = `üìù Evaluaciones de ${subject}`;
                document.getElementById('mainSubtitle').textContent = `Grado: ${grade}`;
                document.getElementById('loadingState').style.display = 'block';
                
                // Cargar estudiantes
                await loadStudents();
                
                // Cargar evaluaciones
                await loadEvaluations();
                
                // Mostrar creador de evaluaciones
                showEvaluationCreator();
                
                // Habilitar bot√≥n
                document.getElementById('loadBtn').disabled = false;
                
                console.log('‚úÖ Datos cargados correctamente');
                
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                showMessage('error', 'Error cargando estudiantes y evaluaciones');
            }
        }

        async function loadStudents() {
            const period = getCurrentAcademicPeriod();
            const params = new URLSearchParams({
                year: period.year,
                period_type: period.periodType,
                period_number: period.periodNumber
            });
            const response = await authenticatedFetch(`/api/students?${params.toString()}`);
            if (!response) return;
            const result = await response.json();
            
            if (result.success) {
                students = result.data.filter(student => {
                    return student.grade_level === currentGrade && 
                           student.subject_area === currentSubject && 
                           student.status === 'active';
                });
                
                console.log('üë• Estudiantes filtrados:', students.length);
                updateStats();
            }
        }

        async function loadEvaluations() {
            try {
                const period = getCurrentAcademicPeriod();
                const params = new URLSearchParams({
                    grade: currentGrade,
                    subject: currentSubject,
                    year: period.year,
                    period_type: period.periodType,
                    period_number: period.periodNumber
                });
                const response = await authenticatedFetch(`/api/evaluations?${params.toString()}`);
                const result = await response.json();
                
                if (result.success) {
                    evaluations = result.data || [];
                    console.log('üìù Evaluaciones cargadas:', evaluations.length);
                    
                    updateStats();
                    renderEvaluations();
                } else {
                    showMessage('error', 'Error: ' + result.message);
                }
            } catch (error) {
                console.error('‚ùå Error cargando evaluaciones:', error);
                showMessage('error', 'Error de conexi√≥n al cargar evaluaciones');
            }
        }

        // ========================================
        // RENDERIZADO
        // ========================================
        function renderEvaluations() {
            if (!evaluations.length) {
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('evaluationsContainer').style.display = 'none';
                return;
            }
            
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('evaluationsContainer').style.display = 'block';
            
            document.getElementById('evaluationsList').innerHTML = evaluations.map(evaluation => {
                const dueDate = evaluation.due_date ? 
                    new Date(evaluation.due_date).toLocaleDateString('es-ES') : 'Sin fecha';
                const createdDate = new Date(evaluation.created_at).toLocaleDateString('es-ES');
                
                const totalStudents = evaluation.total_students || 0;
                const graded = evaluation.total_grades || 0;
                const pending = Math.max(0, totalStudents - graded);
                
                // Determinar icono por tipo
                const typeIcon = {
                    'tarea': 'üìã',
                    'examen': 'üìä', 
                    'proyecto': 'üéØ',
                    'quiz': '‚ö°'
                }[evaluation.type] || 'üìù';
                
                return `
                    <div class="evaluation-item" onclick="selectEvaluation(${evaluation.id})">
                        <div class="evaluation-header">
                            <div class="evaluation-title">
                                ${typeIcon} ${evaluation.title}
                                <span class="evaluation-type-badge type-${evaluation.type || 'tarea'}">
                                    ${evaluation.type || 'tarea'}
                                </span>
                            </div>
                            <div class="evaluation-meta">
                                <span>üìÖ ${evaluation.due_date ? 'Entrega: ' + dueDate : 'Creada: ' + createdDate}</span>
                                <span>‚öñÔ∏è ${evaluation.percentage}% de la nota</span>
                                <span>üìä ${evaluation.max_points} pts m√°x</span>
                            </div>
                        </div>
                        <div class="evaluation-description">${evaluation.description || 'Sin descripci√≥n'}</div>
                        <div class="evaluation-stats">
                            <div class="evaluation-stat">
                                <div class="evaluation-stat-number">${graded}</div>
                                <div class="evaluation-stat-label">Calificados</div>
                            </div>
                            <div class="evaluation-stat">
                                <div class="evaluation-stat-number">${pending}</div>
                                <div class="evaluation-stat-label">Pendientes</div>
                            </div>
                            <div class="evaluation-stat">
                                <div class="evaluation-stat-number">${evaluation.avg_grade ? 
                                    evaluation.avg_grade.toFixed(1) + '%' : '-'}</div>
                                <div class="evaluation-stat-label">Promedio</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectEvaluationAndStartGrading(evaluationId) {
            // Buscar la evaluaci√≥n reci√©n creada
            currentEvaluation = evaluations.find(e => e.id === evaluationId);
            if (!currentEvaluation) {
                console.log('Evaluaci√≥n no encontrada, recargando...');
                setTimeout(() => selectEvaluationAndStartGrading(evaluationId), 1000);
                return;
            }
            
            currentEvaluationId = evaluationId;
            showMessage('success', `üéØ Comenzando calificaci√≥n de: ${currentEvaluation.title}`);
            
            // Ir directamente a calificar
            startGrading(evaluationId);
        }

        function selectEvaluation(evaluationId) {
            currentEvaluationId = evaluationId;
            currentEvaluation = evaluations.find(e => e.id === evaluationId);
            
            if (!currentEvaluation) return;
            
            // Actualizar estilos
            document.querySelectorAll('.evaluation-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // Mostrar opciones
            showEvaluationActions(currentEvaluation);
        }

        function showEvaluationActions(evaluation) {
            const actionsHtml = `
                <div class="evaluation-actions" style="display: flex; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                    <button class="btn btn-primary btn-sm" onclick="startGrading(${evaluation.id})">
                        ‚úèÔ∏è Calificar Estudiantes
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="editEvaluation(${evaluation.id})">
                        üìù Editar Evaluaci√≥n
                    </button>
                    <button class="btn btn-info btn-sm" onclick="viewEvaluationStats(${evaluation.id})">
                        üìä Ver Estad√≠sticas
                    </button>
                </div>
            `;
            
            const evaluationItem = event.currentTarget;
            
            // Limpiar TODOS los botones anteriores de TODAS las evaluaciones
            document.querySelectorAll('.evaluation-actions').forEach(actions => {
                actions.remove();
            });
            
            // Agregar nuevos botones
            evaluationItem.insertAdjacentHTML('beforeend', actionsHtml);
        }

        // ========================================
        // GESTI√ìN DE EVALUACIONES
        // ========================================
        async function createEvaluation(event) {
            event.preventDefault();
            
            try {
                const dueDate = document.getElementById('evaluationDueDate').value;
                const evaluationData = {
                    title: document.getElementById('evaluationTitle').value,
                    type: document.getElementById('evaluationType').value,
                    description: document.getElementById('evaluationDescription').value,
                    percentage: parseFloat(document.getElementById('evaluationPercentage').value),
                    max_points: parseFloat(document.getElementById('evaluationMaxPoints').value),
                    due_date: dueDate || null,
                    grade_level: currentGrade,
                    subject_area: currentSubject
                };
                
                console.log('üìù Creando evaluaci√≥n:', evaluationData);
                
                const response = await authenticatedFetch('/api/evaluations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(evaluationData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', '‚úÖ Evaluaci√≥n creada correctamente');
                    document.getElementById('evaluationForm').reset();
                    await loadEvaluations();
                    
                    // Inmediatamente mostrar la nueva evaluaci√≥n para calificaci√≥n
                    const newEvaluationId = result.data.id;
                    setTimeout(() => {
                        selectEvaluationAndStartGrading(newEvaluationId);
                    }, 500);
                } else {
                    showMessage('error', 'Error: ' + result.message);
                }
                
            } catch (error) {
                console.error('‚ùå Error creando evaluaci√≥n:', error);
                showMessage('error', 'Error creando evaluaci√≥n: ' + error.message);
            }
        }

        function editEvaluation(evaluationId) {
            const evaluation = evaluations.find(e => e.id === evaluationId);
            if (!evaluation) return;
            
            currentEvaluationId = evaluationId;
            
            document.getElementById('editEvaluationTitle').value = evaluation.title;
            document.getElementById('editEvaluationType').value = evaluation.type || 'tarea';
            document.getElementById('editEvaluationDescription').value = evaluation.description || '';
            document.getElementById('editEvaluationPercentage').value = evaluation.percentage;
            document.getElementById('editEvaluationMaxPoints').value = evaluation.max_points;
            document.getElementById('editEvaluationDueDate').value = evaluation.due_date;
            
            document.getElementById('editEvaluationModal').classList.add('show');
        }

        async function updateEvaluation(event) {
            event.preventDefault();
            
            try {
                const dueDate = document.getElementById('editEvaluationDueDate').value;
                const evaluationData = {
                    title: document.getElementById('editEvaluationTitle').value,
                    type: document.getElementById('editEvaluationType').value,
                    description: document.getElementById('editEvaluationDescription').value,
                    percentage: parseFloat(document.getElementById('editEvaluationPercentage').value),
                    max_points: parseFloat(document.getElementById('editEvaluationMaxPoints').value),
                    due_date: dueDate || null
                };
                
                const response = await authenticatedFetch(`/api/evaluations/${currentEvaluationId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(evaluationData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', '‚úÖ Evaluaci√≥n actualizada correctamente');
                    closeEditEvaluationModal();
                    await loadEvaluations();
                } else {
                    showMessage('error', 'Error: ' + result.message);
                }
                
            } catch (error) {
                console.error('‚ùå Error actualizando evaluaci√≥n:', error);
                showMessage('error', 'Error actualizando evaluaci√≥n: ' + error.message);
            }
        }

        async function deleteEvaluation() {
            if (!confirm('¬øEst√° seguro de eliminar esta evaluaci√≥n y todas sus calificaciones?')) {
                return;
            }
            
            try {
                const response = await authenticatedFetch(`/api/evaluations/${currentEvaluationId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', '‚úÖ Evaluaci√≥n eliminada correctamente');
                    closeEditEvaluationModal();
                    await loadEvaluations();
                } else {
                    showMessage('error', 'Error: ' + result.message);
                }
                
            } catch (error) {
                console.error('‚ùå Error eliminando evaluaci√≥n:', error);
                showMessage('error', 'Error eliminando evaluaci√≥n');
            }
        }

        // ========================================
        // FUNCIONES DE CALIFICACI√ìN
        // ========================================
        async function startGrading(evaluationId) {
            currentEvaluationId = evaluationId;
            currentEvaluation = evaluations.find(e => e.id === evaluationId);
            
            if (!currentEvaluation) {
                showMessage('error', 'No se encontr√≥ la evaluaci√≥n');
                return;
            }
            
            try {
                console.log('üîÑ Iniciando calificaci√≥n para evaluaci√≥n:', evaluationId);
                
                // Mostrar estado de carga
                document.getElementById('evaluationsContainer').style.display = 'none';
                document.getElementById('gradingContainer').style.display = 'block';
                document.getElementById('currentEvaluationTitle').textContent = currentEvaluation.title;
                
                // Mostrar indicador de carga en la tabla
                document.getElementById('gradingTableBody').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
                            üîÑ Cargando estudiantes para calificar...
                        </td>
                    </tr>
                `;
                
                // Cargar datos de calificaciones desde la API
                const response = await authenticatedFetch(`/api/evaluation-grades/${evaluationId}`);
                const result = await response.json();
                
                console.log('üì• Respuesta completa de la API:', result);
                
                if (result.success && result.data) {
                    console.log('üë• Estudiantes recibidos de la API:', result.data.length);
                    
                    if (result.data.length === 0) {
                        document.getElementById('gradingTableBody').innerHTML = `
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
                                    üìù No hay estudiantes registrados para esta evaluaci√≥n
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    // Usar los datos directamente de la API
                    renderGradingTable(result.data);
                } else {
                    console.error('‚ùå Error en respuesta de la API:', result);
                    document.getElementById('gradingTableBody').innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: #dc3545;">
                                ‚ùå Error: ${result.message || 'No se pudieron cargar los estudiantes'}
                            </td>
                        </tr>
                    `;
                }
                
            } catch (error) {
                console.error('‚ùå Error iniciando calificaci√≥n:', error);
                showMessage('error', 'Error cargando calificaciones: ' + error.message);
                
                document.getElementById('gradingTableBody').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #dc3545;">
                            ‚ùå Error de conexi√≥n: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        function renderGradingTable(studentsWithGrades) {
            const tbody = document.getElementById('gradingTableBody');
            
            if (!tbody) {
                console.error('‚ùå No se encontr√≥ el elemento gradingTableBody');
                return;
            }
            
            console.log('üé® Renderizando tabla de calificaciones...');
            console.log('üìä Datos recibidos:', studentsWithGrades);
            
            // Verificar que tenemos datos
            if (!studentsWithGrades || studentsWithGrades.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                            üìù No hay estudiantes para mostrar
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Limpiar tabla
            tbody.innerHTML = '';
            
            // Renderizar cada estudiante
            studentsWithGrades.forEach((studentData, index) => {
                console.log(`üë§ Renderizando estudiante ${index + 1}:`, studentData);
                
                // Extraer datos del estudiante
                const initials = ((studentData.first_name?.[0] || '') + (studentData.first_surname?.[0] || '')).toUpperCase();
                const fullName = `${studentData.first_surname || ''} ${studentData.second_surname || ''} ${studentData.first_name || ''}`.trim();
                
                // Datos de calificaci√≥n (pueden existir o no)
                const pointsEarned = studentData.points_earned || '';
                const maxPoints = studentData.max_points || currentEvaluation.max_points || 100;
                const percentage = pointsEarned ? Math.round((pointsEarned / maxPoints) * 100) : 0;
                const finalGradePercentage = pointsEarned ? ((pointsEarned / maxPoints) * currentEvaluation.percentage).toFixed(2) : 0;
                const gradeDate = studentData.grade_date ? new Date(studentData.grade_date).toLocaleDateString('es-ES') : '';
                const notes = studentData.notes || '';
                
                // Crear fila
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="student-photo">${initials}</div>
                            <div>
                                <div class="student-name">${fullName}</div>
                                <div class="student-id">${studentData.student_id || studentData.id || '-'}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <input type="number" 
                            class="grade-input" 
                            min="0" 
                            max="${maxPoints}" 
                            step="0.5"
                            value="${pointsEarned}"
                            placeholder="0"
                            data-student-id="${studentData.id || studentData.student_id}"
                            onchange="updateGradeDisplay(this)">
                        <div style="font-size: 11px; color: #666; margin-top: 2px;">
                            de ${maxPoints} pts
                        </div>
                    </td>
                    <td>
                        <div class="grade-display">
                            <div class="percentage-display ${getGradeClass(percentage)}" id="percentage-${studentData.id || studentData.student_id}">
                                ${pointsEarned ? percentage + '%' : '-'}
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="final-grade-display">
                            <div class="final-percentage-display ${getFinalGradeClass(finalGradePercentage)}" id="final-percentage-${studentData.id || studentData.student_id}">
                                ${pointsEarned ? finalGradePercentage + '%' : '-'}
                            </div>
                            <div style="font-size: 10px; color: #666; margin-top: 2px;">
                                de ${currentEvaluation.percentage}%
                            </div>
                        </div>
                    </td>
                    <td>
                        <span id="date-${studentData.id || studentData.student_id}" style="font-size: 12px; color: #666;">
                            ${gradeDate || '-'}
                        </span>
                    </td>
                    <td>
                        <input type="text" 
                            class="form-input" 
                            style="font-size: 12px; padding: 4px 8px;"
                            placeholder="Observaciones..."
                            value="${notes}"
                            data-student-id="${studentData.id || studentData.student_id}"
                            data-field="notes">
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            console.log('‚úÖ Tabla renderizada con', studentsWithGrades.length, 'estudiantes');
        }

        function updateGradeDisplay(input) {
            const studentId = input.dataset.studentId;
            const pointsEarned = parseFloat(input.value) || 0;
            const maxPoints = currentEvaluation.max_points || 100;
            const percentage = Math.round((pointsEarned / maxPoints) * 100);
            const finalGradePercentage = ((pointsEarned / maxPoints) * currentEvaluation.percentage).toFixed(2);
            
            console.log('üìù Actualizando display de calificaci√≥n:', { 
                studentId, 
                pointsEarned, 
                percentage, 
                finalGradePercentage,
                evaluationPercentage: currentEvaluation.percentage 
            });
            
            // Actualizar porcentaje de la evaluaci√≥n
            const percentageDisplay = document.getElementById(`percentage-${studentId}`);
            if (percentageDisplay) {
                percentageDisplay.textContent = pointsEarned > 0 ? percentage + '%' : '-';
                percentageDisplay.className = `percentage-display ${getGradeClass(percentage)}`;
            }
            
            // Actualizar porcentaje ganado de la nota final
            const finalPercentageDisplay = document.getElementById(`final-percentage-${studentId}`);
            if (finalPercentageDisplay) {
                finalPercentageDisplay.textContent = pointsEarned > 0 ? finalGradePercentage + '%' : '-';
                finalPercentageDisplay.className = `final-percentage-display ${getFinalGradeClass(finalGradePercentage)}`;
            }
            
            // Actualizar fecha
            const dateDisplay = document.getElementById(`date-${studentId}`);
            if (dateDisplay && pointsEarned > 0) {
                dateDisplay.textContent = new Date().toLocaleDateString('es-ES');
            }
        }

        function getGradeClass(percentage) {
            if (percentage >= 90) return 'grade-A';
            if (percentage >= 80) return 'grade-B';
            if (percentage >= 70) return 'grade-C';
            if (percentage >= 60) return 'grade-D';
            if (percentage > 0) return 'grade-F';
            return 'grade-none';
        }


        function getFinalGradeClass(finalPercentage) {
            const percentage = parseFloat(finalPercentage);
            if (percentage >= currentEvaluation.percentage * 0.9) return 'grade-excellent';
            if (percentage >= currentEvaluation.percentage * 0.8) return 'grade-good';
            if (percentage >= currentEvaluation.percentage * 0.7) return 'grade-regular';
            return 'grade-poor';
        }

        async function saveAllGrades() {
            try {
                const gradeInputs = document.querySelectorAll('.grade-input');
                const notesInputs = document.querySelectorAll('input[data-field="notes"]');
                const gradesToSave = [];
                
                gradeInputs.forEach(input => {
                    const studentId = parseInt(input.dataset.studentId);
                    const pointsEarned = parseFloat(input.value);
                    
                    if (pointsEarned >= 0) {
                        const notesInput = document.querySelector(`input[data-field="notes"][data-student-id="${studentId}"]`);
                        const percentage = Math.round((pointsEarned / currentEvaluation.max_points) * 100);
                        
                        gradesToSave.push({
                            assignment_id: currentEvaluationId,
                            student_id: studentId,
                            points_earned: pointsEarned,
                            percentage: percentage,
                            notes: notesInput ? notesInput.value : ''
                        });
                    }
                });
                
                if (gradesToSave.length === 0) {
                    showMessage('error', 'No hay calificaciones para guardar');
                    return;
                }
                
                console.log('üíæ Guardando calificaciones:', gradesToSave);
                
                const response = await authenticatedFetch('/api/evaluation-grades', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ grades: gradesToSave })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', `‚úÖ ${gradesToSave.length} calificaciones guardadas correctamente`);
                    await loadEvaluations(); // Actualizar estad√≠sticas
                } else {
                    showMessage('error', 'Error: ' + result.message);
                }
                
            } catch (error) {
                console.error('‚ùå Error guardando calificaciones:', error);
                showMessage('error', 'Error guardando calificaciones');
            }
        }

        function closeGrading() {
            document.getElementById('gradingContainer').style.display = 'none';
            document.getElementById('evaluationsContainer').style.display = 'block';
            currentEvaluationId = null;
            currentEvaluation = null;
        }

        // ========================================
        // UTILIDADES
        // ========================================
        function showEvaluationCreator() {
            document.getElementById('evaluationCreator').classList.remove('hidden');
            document.getElementById('evaluationCreatorPlaceholder').style.display = 'none';
        }

        function hideEvaluationCreator() {
            document.getElementById('evaluationCreator').classList.add('hidden');
            document.getElementById('evaluationCreatorPlaceholder').style.display = 'block';
        }

        function resetMainArea() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('evaluationsContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('gradingContainer').style.display = 'none';
            document.getElementById('statsCard').style.display = 'none';
            
            document.getElementById('mainTitle').textContent = 'üìù Gesti√≥n de Evaluaciones';
            document.getElementById('mainSubtitle').textContent = 'Seleccione grado y materia para comenzar';
        }

        function updateStats() {
            document.getElementById('totalStudents').textContent = students.length;
            document.getElementById('totalEvaluations').textContent = evaluations.length;
            
            if (evaluations.length > 0) {
                const avgGrade = evaluations.reduce((sum, evaluation) => sum + (evaluation.avg_grade || 0), 0) / evaluations.length;
                document.getElementById('avgGrade').textContent = avgGrade.toFixed(1) + '%';
                document.getElementById('statsCard').style.display = 'block';
                document.getElementById('exportBtn').style.display = 'inline-flex';
            } else {
                document.getElementById('avgGrade').textContent = '0%';
                document.getElementById('statsCard').style.display = 'none';
                document.getElementById('exportBtn').style.display = 'none';
            }
        }

        function closeEditEvaluationModal() {
            document.getElementById('editEvaluationModal').classList.remove('show');
            currentEvaluationId = null;
        }

        function showMessage(type, message) {
            const messageEl = document.getElementById(type + 'Message');
            messageEl.textContent = message;
            messageEl.classList.add('show');
            
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 5000);
        }

        function exportGrades() {
            showMessage('success', 'üìÑ Funci√≥n de exportar en desarrollo');
        }

        function viewEvaluationStats(evaluationId) {
            showMessage('success', 'üìä Funci√≥n de estad√≠sticas detalladas en desarrollo');
        }

        function filterStudents() {
            const query = document.getElementById('studentSearch').value.toLowerCase();
            document.querySelectorAll('#gradingTableBody tr').forEach(row => {
                const name = row.querySelector('.student-name')?.textContent.toLowerCase() || '';
                const id = row.querySelector('.student-id')?.textContent.toLowerCase() || '';
                if (name.includes(query) || id.includes(query)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Cerrar modales al hacer clic fuera
        document.getElementById('editEvaluationModal').addEventListener('click', function(event) {
            if (event.target === this) closeEditEvaluationModal();
        });

        // ===============================
        // INDICADOR SIMPLE DE PER√çODO
        // ===============================
        class SimplePeriodIndicator {
            constructor() { this.init(); }

            init() {
                this.updateDisplay();
                this.setupEventListeners();
                console.log('üìÖ Indicador simple de per√≠odo inicializado');
            }

            setupEventListeners() {
                window.addEventListener('academicPeriodChanged', () => {
                    console.log('üìÖ Per√≠odo cambi√≥, actualizando indicador...');
                    this.updateDisplay();
                    this.reloadPageData();
                });

                window.addEventListener('reloadPeriodData', () => {
                    console.log('üîÑ Recargando datos por cambio de per√≠odo...');
                    this.updateDisplay();
                    this.reloadPageData();
                });
            }

            updateDisplay() {
                const display = document.getElementById('activePeriodDisplay');
                if (!display) return;
                try {
                    const currentPeriod = getCurrentAcademicPeriod();
                    const teacherData = this.getTeacherInfo();
                    const text = this.buildPeriodText(currentPeriod, teacherData);
                    display.textContent = text;
                    this.updateBannerState('active');
                } catch (err) {
                    console.error('Error actualizando indicador de per√≠odo:', err);
                    display.textContent = 'Error cargando per√≠odo acad√©mico';
                    this.updateBannerState('error');
                }
            }

            getTeacherInfo() {
                const data = sessionStorage.getItem('teacherData');
                if (data) {
                    try {
                        const teacher = JSON.parse(data);
                        return { name: teacher.name || teacher.full_name || 'Profesor', school: teacher.school || teacher.school_name || 'Mi Escuela' };
                    } catch (e) { console.warn('Error parseando teacherData:', e); }
                }
                return { name: 'Profesor', school: 'Mi Escuela' };
            }

            buildPeriodText(period, teacher) {
                const periodTypeName = period.periodType === 'semester' ? 'Semestre' : 'Trimestre';
                const periodNumber = period.periodNumber === 1 ? 'Primer' : period.periodNumber === 2 ? 'Segundo' : 'Tercer';
                return `${teacher.name} - ${period.year} - ${periodNumber} ${periodTypeName} - ${teacher.school}`;
            }

            updateBannerState(state) {
                const banner = document.querySelector('.period-indicator-banner');
                if (!banner) return;
                banner.classList.remove('loading', 'error', 'outdated');
                if (state !== 'active') banner.classList.add(state);
            }

            reloadPageData() {
                if (typeof window.loadStudentsAndEvaluations === 'function') {
                    console.log('üîÑ Recargando evaluaciones y estudiantes...');
                    window.loadStudentsAndEvaluations();
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.simplePeriodIndicator = new SimplePeriodIndicator();
        });

        window.updatePeriodIndicator = function() {
            if (window.simplePeriodIndicator) {
                window.simplePeriodIndicator.updateDisplay();
            }
        };
        window.loadStudentsAndEvaluations = loadStudentsAndEvaluations;
    </script>
</body>
</html>