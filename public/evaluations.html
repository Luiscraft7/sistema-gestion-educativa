<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìùEvaluaciones - Sistema Educativo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1600px; margin: 0 auto; }
        
        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .header h1 { color: #333; font-size: 28px; margin-bottom: 5px; }
        .header p { color: #666; font-size: 14px; }
        
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .card-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }
        
        .card-body { padding: 20px; }
        
        .filter-group { margin-bottom: 15px; }
        
        .filter-label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }
        
        .filter-select, .form-input, .form-textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .filter-select:focus, .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .filter-select:disabled, .form-input:disabled {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }
        
        .task-creator {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .task-creator.hidden { display: none; }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group { margin-bottom: 15px; }
        
        .main-area {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .main-header {
            padding: 25px;
            border-bottom: 1px solid #eee;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .main-title { font-size: 24px; font-weight: 600; margin-bottom: 5px; }
        .main-subtitle { font-size: 14px; opacity: 0.9; }
        
        .loading-state, .empty-state {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .empty-state h3 { margin-bottom: 10px; color: #333; }
        
        .tasks-list {
            padding: 20px;
        }
        
        .task-item {
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .task-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        }
        
        .task-item.active {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .task-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .task-meta {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 12px;
            color: #666;
        }
        
        .task-description {
            color: #666;
            margin: 10px 0;
            line-height: 1.5;
        }
        
        .task-stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .task-stat {
            text-align: center;
        }
        
        .task-stat-number {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
        }
        
        .task-stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }
        
        .students-table {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }
        
        tbody tr:hover { background: #f8f9fa; }
        
        .student-photo {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        .student-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }
        
        .student-id {
            color: #666;
            font-size: 11px;
        }
        
        .grade-input {
            width: 80px;
            padding: 6px 8px;
            border: 2px solid #e1e1e1;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
        }
        
        .grade-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .grade-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .points-display {
            font-size: 14px;
            font-weight: 600;
        }
        
        .percentage-display {
            font-size: 24px;
            font-weight: 700;
            padding: 8px 12px;
            border-radius: 8px;
            min-width: 60px;
            text-align: center;
        }
        
        .grade-A { background: #d4edda; color: #155724; }
        .grade-B { background: #d1ecf1; color: #0c5460; }
        .grade-C { background: #fff3cd; color: #856404; }
        .grade-D { background: #f8d7da; color: #721c24; }
        .grade-F { background: #f5c6cb; color: #721c24; }
        .grade-none { background: #e9ecef; color: #495057; }
        
        .quick-actions {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message.show { display: block; }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: 2;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .task-stats {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>üìù M√≥dulo de Evaluaciones</h1>
                <p>Gesti√≥n y calificaci√≥n de Evaluaciones por grado y materia</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-success" onclick="exportGrades()" id="exportBtn" style="display: none;">
                    üìÑ Exportar Calificaciones
                </button>
                <a href="dashboard.html" class="btn btn-secondary">
                    ‚Üê Dashboard
                </a>
            </div>
        </div>

        <!-- Mensajes -->
        <div id="successMessage" class="message success">‚úÖ Operaci√≥n completada exitosamente</div>
        <div id="errorMessage" class="message error">‚ùå Error en la operaci√≥n</div>

        <!-- Contenido Principal -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Filtros -->
                <div class="card">
                    <div class="card-header">
                        üéØ Selecci√≥n de Curso
                    </div>
                    <div class="card-body">
                        <div class="filter-group">
                            <label class="filter-label">1. Seleccionar Grado:</label>
                            <select class="filter-select" id="gradeFilter" onchange="loadSubjectsForGrade()">
                                <option value="">Seleccionar grado...</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">2. Seleccionar Materia:</label>
                            <select class="filter-select" id="subjectFilter" onchange="loadStudentsAndTasks()" disabled>
                                <option value="">Primero seleccione un grado</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-primary" style="width: 100%;" onclick="loadStudentsAndTasks()" disabled id="loadBtn">
                                üîÑ Cargar Curso
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Crear Tarea -->
                <div class="card">
                    <div class="card-header">
                        ‚ûï Nueva Tarea
                    </div>
                    <div class="card-body">
                        <div class="task-creator hidden" id="taskCreator">
                            <form id="taskForm" onsubmit="createTask(event)">
                                <div class="form-group">
                                    <label class="filter-label">T√≠tulo de la evaluacion:</label>
                                    <input type="text" class="form-input" id="taskTitle" placeholder="Ej: Tarea de Matem√°ticas #1" required>
                                </div>
                                <div class="form-group">
                                    <label class="filter-label">Descripci√≥n/Objetivo:</label>
                                    <textarea class="form-textarea" id="taskDescription" rows="3" placeholder="Describe el objetivo de la tarea..."></textarea>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="filter-label">% de la Nota Final:</label>
                                        <input type="number" class="form-input" id="taskPercentage" min="1" max="100" value="10" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="filter-label">Puntos M√°ximos:</label>
                                        <input type="number" class="form-input" id="taskMaxPoints" min="1" max="1000" value="100" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="filter-label">Fecha de Entrega (opcional):</label>
                                    <input type="date" class="form-input" id="taskDueDate">
                                    <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                        Puede agregarse despu√©s de revisar la tarea
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success" style="width: 100%;">
                                    üíæ Crear Tarea
                                </button>
                            </form>
                        </div>
                        <div id="taskCreatorPlaceholder">
                            <p style="color: #666; text-align: center; font-style: italic;">
                                Seleccione grado y materia para crear tareas
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Estad√≠sticas -->
                <div class="card" id="statsCard" style="display: none;">
                    <div class="card-header">
                        üìä Estad√≠sticas del Curso
                    </div>
                    <div class="card-body">
                        <div class="task-stats">
                            <div class="task-stat">
                                <div class="task-stat-number" id="totalStudents">0</div>
                                <div class="task-stat-label">Estudiantes</div>
                            </div>
                            <div class="task-stat">
                                <div class="task-stat-number" id="totalTasks">0</div>
                                <div class="task-stat-label">Tareas</div>
                            </div>
                            <div class="task-stat">
                                <div class="task-stat-number" id="avgGrade">0%</div>
                                <div class="task-stat-label">Promedio</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- √Årea Principal -->
            <div class="main-area">
                <!-- Header Principal -->
                <div class="main-header">
                    <div class="main-title" id="mainTitle">
                        üìù Gesti√≥n de Evaluaciones
                    </div>
                    <div class="main-subtitle" id="mainSubtitle">
                        Seleccione grado y materia para comenzar
                    </div>
                </div>

                <!-- Estados de Carga -->
                <div id="loadingState" class="loading-state">
                    üîÑ Seleccione grado y materia para cargar Evaluaciones...
                </div>
                
                <div id="emptyState" class="empty-state" style="display: none;">
                    <h3>üìù No hay evaluaciones creadas</h3>
                    <p>Cree la primera evaluacion para este curso</p>
                </div>

                <!-- Lista de Tareas -->
                <div id="tasksContainer" style="display: none;">
                    <div class="tasks-list" id="tasksList">
                        <!-- Las tareas se cargan aqu√≠ -->
                    </div>
                </div>

                <!-- Tabla de Calificaciones -->
                <div id="gradingContainer" style="display: none;">
                    <div class="quick-actions">
                        <span style="font-weight: 600; color: #333;">Calificando:</span>
                        <span id="currentTaskTitle" style="color: #667eea; font-weight: 600;"></span>
                        <div style="margin-left: auto; display: flex; gap: 10px;">
                            <button class="btn btn-success btn-sm" onclick="saveAllGrades()">
                                üíæ Guardar Todas las Calificaciones
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="closeGrading()">
                                ‚Üê Volver a evaluaciones
                            </button>
                        </div>
                    </div>
                    
                    <div class="students-table">
                        <table id="gradingTable">
                            <thead>
                                <tr>
                                    <th>Estudiante</th>
                                    <th>Puntos Obtenidos</th>
                                    <th>Nota (0-100)</th>
                                    <th>Fecha Calificaci√≥n</th>
                                    <th>Observaciones</th>
                                </tr>
                            </thead>
                            <tbody id="gradingTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Tarea -->
    <div class="modal" id="editTaskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚úèÔ∏è Editar Tarea</h2>
                <button class="close-btn" onclick="closeEditTaskModal()">&times;</button>
            </div>
            
            <form id="editTaskForm" onsubmit="updateTask(event)">
                <div class="form-group">
                    <label class="filter-label">T√≠tulo de la Evaluaci√≥n:</label>
                    <input type="text" class="form-input" id="editTaskTitle" required>
                </div>
                <div class="form-group">
                    <label class="filter-label">Descripci√≥n/Objetivo:</label>
                    <textarea class="form-textarea" id="editTaskDescription" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="filter-label">% de la Nota Final:</label>
                        <input type="number" class="form-input" id="editTaskPercentage" min="1" max="100" required>
                    </div>
                    <div class="form-group">
                        <label class="filter-label">Puntos M√°ximos:</label>
                        <input type="number" class="form-input" id="editTaskMaxPoints" min="1" max="1000" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="filter-label">Fecha de Entrega (opcional):</label>
                    <input type="date" class="form-input" id="editTaskDueDate">
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditTaskModal()">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="deleteTask()">Eliminar Tarea</button>
                    <button type="submit" class="btn btn-primary">Actualizar Tarea</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========================================
        // VARIABLES GLOBALES
        // ========================================
        let currentGrade = '';
        let currentSubject = '';
        let students = [];
        let evaluations = [];
        let currentEvaluation = null;
        let currentTaskId = null;

        // ========================================
        // INICIALIZACI√ìN
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando m√≥dulo de tareas...');
            loadGrades();
        });

        // ========================================
        // CARGA DE DATOS
        // ========================================
        async function loadGrades() {
            try {
                console.log('üìö Cargando grados...');
                
                const response = await fetch('/api/grades');
                const result = await response.json();
                
                const gradeFilter = document.getElementById('gradeFilter');
                gradeFilter.innerHTML = '<option value="">Seleccionar grado...</option>';
                
                if (result.success) {
                    result.data.forEach(grade => {
                        gradeFilter.innerHTML += `<option value="${grade.name}">${grade.name}</option>`;
                    });
                    console.log('‚úÖ Grados cargados:', result.data.length);
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando grados:', error);
                showMessage('error', 'Error cargando grados');
            }
        }

        async function loadSubjectsForGrade() {
            const grade = document.getElementById('gradeFilter').value;
            const subjectFilter = document.getElementById('subjectFilter');
            const loadBtn = document.getElementById('loadBtn');
            
            if (!grade) {
                subjectFilter.innerHTML = '<option value="">Primero seleccione un grado</option>';
                subjectFilter.disabled = true;
                loadBtn.disabled = true;
                hideTaskCreator();
                resetMainArea();
                return;
            }
            
            try {
                console.log('üìñ Cargando materias para grado:', grade);
                
                const response = await fetch(`/api/grade-subjects/${encodeURIComponent(grade)}`);
                const result = await response.json();
                
                subjectFilter.innerHTML = '<option value="">Seleccionar materia...</option>';
                
                if (result.success && result.data.length > 0) {
                    result.data.forEach(assignment => {
                        subjectFilter.innerHTML += `<option value="${assignment.subject_name}">${assignment.subject_name}</option>`;
                    });
                    subjectFilter.disabled = false;
                    console.log('‚úÖ Materias cargadas:', result.data.length);
                } else {
                    subjectFilter.innerHTML = '<option value="">No hay materias asignadas a este grado</option>';
                    subjectFilter.disabled = true;
                }
                
                loadBtn.disabled = true;
                hideTaskCreator();
                resetMainArea();
                
            } catch (error) {
                console.error('‚ùå Error cargando materias:', error);
                showMessage('error', 'Error cargando materias para el grado');
            }
        }

        async function loadStudentsAndTasks() {
            const grade = document.getElementById('gradeFilter').value;
            const subject = document.getElementById('subjectFilter').value;
            
            if (!grade || !subject) {
                hideTaskCreator();
                resetMainArea();
                return;
            }
            
            currentGrade = grade;
            currentSubject = subject;
            
            try {
                console.log('üë• Cargando estudiantes y tareas...', { grade, subject });
                
                // Actualizar interfaz
                document.getElementById('mainTitle').textContent = `üìù Tareas de ${subject}`;
                document.getElementById('mainSubtitle').textContent = `Grado: ${grade}`;
                document.getElementById('loadingState').style.display = 'block';
                
                // Cargar estudiantes
                await loadStudents();
                
                // Cargar tareas
                await loadTasks();
                
                // Mostrar creador de tareas
                showTaskCreator();
                
                // Habilitar bot√≥n
                document.getElementById('loadBtn').disabled = false;
                
                console.log('‚úÖ Datos cargados correctamente');
                
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                showMessage('error', 'Error cargando estudiantes y tareas');
            }
        }

        async function loadStudents() {
            const response = await fetch('/api/students');
            const result = await response.json();
            
            if (result.success) {
                students = result.data.filter(student => {
                    return student.grade_level === currentGrade && 
                           student.subject_area === currentSubject && 
                           student.status === 'active';
                });
                
                console.log('üë• Estudiantes filtrados:', students.length);
                updateStats();
            }
        }

        async function loadEvaluations() {
            try {
                const response = await fetch(`/api/evaluations?grade=${currentGrade}&subject=${currentSubject}`);
                const result = await response.json();
                
                if (result.success) {
                    evaluations = result.data || [];
                    console.log('üìù Evaluaciones cargadas:', evaluations.length);
                    
                    updateStats();
                    renderEvaluations();
                } else {
                    showMessage('error', 'Error: ' + result.message);
                }
            } catch (error) {
                console.error('‚ùå Error cargando evaluaciones:', error);
                showMessage('error', 'Error de conexi√≥n al cargar evaluaciones');
            }
        }


        // ========================================
        // RENDERIZADO
        // ========================================
        function renderEvaluations() {
            if (!evaluations.length) {
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('tasksContainer').style.display = 'none';
                return;
            }
            
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('tasksContainer').style.display = 'block';
            
            document.getElementById('tasksList').innerHTML = evaluations.map(evaluation => {
                const dueDate = evaluation.due_date ? 
                    new Date(evaluation.due_date).toLocaleDateString('es-ES') : 'Sin fecha';
                const createdDate = new Date(evaluation.created_at).toLocaleDateString('es-ES');
                
                const totalStudents = evaluation.total_students || 0;
                const graded = evaluation.total_grades || 0;
                const pending = Math.max(0, totalStudents - graded);
                
                // Determinar icono por tipo
                const typeIcon = {
                    'tarea': 'üìã',
                    'examen': 'üìä', 
                    'proyecto': 'üéØ',
                    'quiz': '‚ö°'
                }[evaluation.type] || 'üìù';
                
                return `
                    <div class="task-item" onclick="selectEvaluation(${evaluation.id})">
                        <div class="task-header">
                            <div class="task-title">${typeIcon} ${evaluation.title}</div>
                            <div class="task-meta">
                                <span>üìÖ ${evaluation.due_date ? 'Entrega: ' + dueDate : 'Creada: ' + createdDate}</span>
                                <span>‚öñÔ∏è ${evaluation.percentage}% de la nota</span>
                                <span>üìä ${evaluation.max_points} pts m√°x</span>
                            </div>
                        </div>
                        <div class="task-description">${evaluation.description || 'Sin descripci√≥n'}</div>
                        <div class="task-stats">
                            <div class="task-stat">
                                <div class="task-stat-number">${graded}</div>
                                <div class="task-stat-label">Calificados</div>
                            </div>
                            <div class="task-stat">
                                <div class="task-stat-number">${pending}</div>
                                <div class="task-stat-label">Pendientes</div>
                            </div>
                            <div class="task-stat">
                                <div class="task-stat-number">${evaluation.avg_grade ? 
                                    evaluation.avg_grade.toFixed(1) + '%' : '-'}</div>
                                <div class="task-stat-label">Promedio</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectTaskAndStartGrading(taskId) {
            // Buscar la tarea reci√©n creada
            currentTask = tasks.find(t => t.id === taskId);
            if (!currentTask) {
                console.log('Tarea no encontrada, recargando...');
                setTimeout(() => selectTaskAndStartGrading(taskId), 1000);
                return;
            }
            
            currentTaskId = taskId;
            showMessage('success', `üéØ Comenzando calificaci√≥n de: ${currentTask.title}`);
            
            // Ir directamente a calificar
            startGrading(taskId);
        }

        function selectTask(taskId) {
            currentTaskId = taskId;
            currentTask = tasks.find(t => t.id === taskId);
            
            if (!currentTask) return;
            
            // Actualizar estilos
            document.querySelectorAll('.task-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // Mostrar opciones
            showTaskActions(currentTask);
        }

        function showTaskActions(task) {
            const actionsHtml = `
                <div class="task-actions" style="display: flex; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                    <button class="btn btn-primary btn-sm" onclick="startGrading(${task.id})">
                        ‚úèÔ∏è Calificar Estudiantes
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="editTask(${task.id})">
                        üìù Editar Tarea
                    </button>
                    <button class="btn btn-info btn-sm" onclick="viewTaskStats(${task.id})">
                        üìä Ver Estad√≠sticas
                    </button>
                </div>
            `;
            
            const taskItem = event.currentTarget;
            
            // ‚úÖ CORREGIR: Limpiar TODOS los botones anteriores de TODAS las tareas
            document.querySelectorAll('.task-actions').forEach(actions => {
                actions.remove();
            });
            
            // Agregar nuevos botones
            taskItem.insertAdjacentHTML('beforeend', actionsHtml);
        }

        // ========================================
        // GESTI√ìN DE TAREAS
        // ========================================
        async function createTask(event) {
            event.preventDefault();
            
            try {
                const dueDate = document.getElementById('taskDueDate').value;
                const taskData = {
                    title: document.getElementById('taskTitle').value,
                    description: document.getElementById('taskDescription').value,
                    percentage: parseFloat(document.getElementById('taskPercentage').value),
                    max_points: parseFloat(document.getElementById('taskMaxPoints').value),
                    due_date: dueDate || null, // Opcional
                    grade_level: currentGrade,
                    subject_area: currentSubject
                };
                
                console.log('üìù Creando tarea:', taskData);
                
                const response = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(taskData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', '‚úÖ Tarea creada correctamente');
                    document.getElementById('taskForm').reset();
                    await loadTasks();
                    
                    // Inmediatamente mostrar la nueva tarea para calificaci√≥n
                    const newTaskId = result.data.id;
                    setTimeout(() => {
                        selectTaskAndStartGrading(newTaskId);
                    }, 500);
                } else {
                    showMessage('error', 'Error: ' + result.message);
                }
                
            } catch (error) {
                console.error('‚ùå Error creando tarea:', error);
                showMessage('error', 'Error creando tarea: ' + error.message);
            }
        }

        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            currentTaskId = taskId;
            
            document.getElementById('editTaskTitle').value = task.title;
            document.getElementById('editTaskDescription').value = task.description || '';
            document.getElementById('editTaskPercentage').value = task.percentage;
            document.getElementById('editTaskMaxPoints').value = task.max_points;
            document.getElementById('editTaskDueDate').value = task.due_date;
            
            document.getElementById('editTaskModal').classList.add('show');
        }

        async function updateTask(event) {
            event.preventDefault();
            
            try {
                const dueDate = document.getElementById('editTaskDueDate').value;
                const taskData = {
                    title: document.getElementById('editTaskTitle').value,
                    description: document.getElementById('editTaskDescription').value,
                    percentage: parseFloat(document.getElementById('editTaskPercentage').value),
                    max_points: parseFloat(document.getElementById('editTaskMaxPoints').value),
                    due_date: dueDate || null // Opcional
                };
                
                const response = await fetch(`/api/tasks/${currentTaskId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(taskData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', '‚úÖ Tarea actualizada correctamente');
                    closeEditTaskModal();
                    await loadTasks();
                } else {
                    showMessage('error', 'Error: ' + result.message);
                }
                
            } catch (error) {
                console.error('‚ùå Error actualizando tarea:', error);
                showMessage('error', 'Error actualizando tarea: ' + error.message);
            }
        }

        async function deleteTask() {
            if (!confirm('¬øEst√° seguro de eliminar esta tarea y todas sus calificaciones?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/tasks/${currentTaskId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', '‚úÖ Tarea eliminada correctamente');
                    closeEditTaskModal();
                    await loadTasks();
                } else {
                    showMessage('error', 'Error: ' + result.message);
                }
                
            } catch (error) {
                console.error('‚ùå Error eliminando tarea:', error);
                showMessage('error', 'Error eliminando tarea');
            }
        }

        // ========================================
        // FUNCIONES DE CALIFICACI√ìN CORREGIDAS
        // ========================================

        async function startGrading(taskId) {
            currentTaskId = taskId;
            currentTask = tasks.find(t => t.id === taskId);
            
            if (!currentTask) {
                showMessage('error', 'No se encontr√≥ la tarea');
                return;
            }
            
            try {
                console.log('üîÑ Iniciando calificaci√≥n para tarea:', taskId);
                
                // Mostrar estado de carga
                document.getElementById('tasksContainer').style.display = 'none';
                document.getElementById('gradingContainer').style.display = 'block';
                document.getElementById('currentTaskTitle').textContent = currentTask.title;
                
                // Mostrar indicador de carga en la tabla
                document.getElementById('gradingTableBody').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
                            üîÑ Cargando estudiantes para calificar...
                        </td>
                    </tr>
                `;
                
                // Cargar datos de calificaciones desde la API
                const response = await fetch(`/api/task-grades/${taskId}`);
                const result = await response.json();
                
                console.log('üì• Respuesta completa de la API:', result);
                
                if (result.success && result.data) {
                    console.log('üë• Estudiantes recibidos de la API:', result.data.length);
                    
                    if (result.data.length === 0) {
                        document.getElementById('gradingTableBody').innerHTML = `
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
                                    üìù No hay estudiantes registrados para esta tarea
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    // Usar los datos directamente de la API
                    renderGradingTable(result.data);
                } else {
                    console.error('‚ùå Error en respuesta de la API:', result);
                    document.getElementById('gradingTableBody').innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: #dc3545;">
                                ‚ùå Error: ${result.message || 'No se pudieron cargar los estudiantes'}
                            </td>
                        </tr>
                    `;
                }
                
            } catch (error) {
                console.error('‚ùå Error iniciando calificaci√≥n:', error);
                showMessage('error', 'Error cargando calificaciones: ' + error.message);
                
                document.getElementById('gradingTableBody').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #dc3545;">
                            ‚ùå Error de conexi√≥n: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        function renderGradingTable(studentsWithGrades) {
            const tbody = document.getElementById('gradingTableBody');
            
            if (!tbody) {
                console.error('‚ùå No se encontr√≥ el elemento gradingTableBody');
                return;
            }
            
            console.log('üé® Renderizando tabla de calificaciones...');
            console.log('üìä Datos recibidos:', studentsWithGrades);
            
            // Verificar que tenemos datos
            if (!studentsWithGrades || studentsWithGrades.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
                            üìù No hay estudiantes para mostrar
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Limpiar tabla
            tbody.innerHTML = '';
            
            // Renderizar cada estudiante
            studentsWithGrades.forEach((studentData, index) => {
                console.log(`üë§ Renderizando estudiante ${index + 1}:`, studentData);
                
                // Extraer datos del estudiante
                const initials = ((studentData.first_name?.[0] || '') + (studentData.first_surname?.[0] || '')).toUpperCase();
                const fullName = `${studentData.first_surname || ''} ${studentData.second_surname || ''} ${studentData.first_name || ''}`.trim();
                
                // Datos de calificaci√≥n (pueden existir o no)
                const pointsEarned = studentData.points_earned || '';
                const maxPoints = studentData.max_points || currentTask.max_points || 100;
                const percentage = pointsEarned ? Math.round((pointsEarned / maxPoints) * 100) : 0;
                const gradeDate = studentData.grade_date ? new Date(studentData.grade_date).toLocaleDateString('es-ES') : '';
                const notes = studentData.notes || '';
                
                // Crear fila
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="student-photo">${initials}</div>
                            <div>
                                <div class="student-name">${fullName}</div>
                                <div class="student-id">${studentData.student_id || studentData.id || '-'}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <input type="number" 
                            class="grade-input" 
                            min="0" 
                            max="${maxPoints}" 
                            step="0.5"
                            value="${pointsEarned}"
                            placeholder="0"
                            data-student-id="${studentData.id || studentData.student_id}"
                            onchange="updateGradeDisplay(this)">
                        <div style="font-size: 11px; color: #666; margin-top: 2px;">
                            de ${maxPoints} pts
                        </div>
                    </td>
                    <td>
                        <div class="grade-display">
                            <div class="percentage-display ${getGradeClass(percentage)}" id="percentage-${studentData.id || studentData.student_id}">
                                ${pointsEarned ? percentage + '%' : '-'}
                            </div>
                        </div>
                    </td>
                    <td>
                        <span id="date-${studentData.id || studentData.student_id}" style="font-size: 12px; color: #666;">
                            ${gradeDate || '-'}
                        </span>
                    </td>
                    <td>
                        <input type="text" 
                            class="form-input" 
                            style="font-size: 12px; padding: 4px 8px;"
                            placeholder="Observaciones..."
                            value="${notes}"
                            data-student-id="${studentData.id || studentData.student_id}"
                            data-field="notes">
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            console.log('‚úÖ Tabla renderizada con', studentsWithGrades.length, 'estudiantes');
        }

        function updateGradeDisplay(input) {
            const studentId = input.dataset.studentId;
            const pointsEarned = parseFloat(input.value) || 0;
            const maxPoints = currentTask.max_points || 100;
            const percentage = Math.round((pointsEarned / maxPoints) * 100);
            
            console.log('üìù Actualizando display de calificaci√≥n:', { studentId, pointsEarned, percentage });
            
            const percentageDisplay = document.getElementById(`percentage-${studentId}`);
            if (percentageDisplay) {
                percentageDisplay.textContent = pointsEarned > 0 ? percentage + '%' : '-';
                percentageDisplay.className = `percentage-display ${getGradeClass(percentage)}`;
            }
            
            // Actualizar fecha
            const dateDisplay = document.getElementById(`date-${studentId}`);
            if (dateDisplay && pointsEarned > 0) {
                dateDisplay.textContent = new Date().toLocaleDateString('es-ES');
            }
        }

        function getGradeClass(percentage) {
            if (percentage >= 90) return 'grade-A';
            if (percentage >= 80) return 'grade-B';
            if (percentage >= 70) return 'grade-C';
            if (percentage >= 60) return 'grade-D';
            if (percentage > 0) return 'grade-F';
            return 'grade-none';
        }

        async function saveAllGrades() {
            try {
                const gradeInputs = document.querySelectorAll('.grade-input');
                const notesInputs = document.querySelectorAll('input[data-field="notes"]');
                const gradesToSave = [];
                
                gradeInputs.forEach(input => {
                    const studentId = parseInt(input.dataset.studentId);
                    const pointsEarned = parseFloat(input.value);
                    
                    if (pointsEarned >= 0) {
                        const notesInput = document.querySelector(`input[data-field="notes"][data-student-id="${studentId}"]`);
                        const percentage = Math.round((pointsEarned / currentTask.max_points) * 100);
                        
                        gradesToSave.push({
                            assignment_id: currentTaskId,  // ‚úÖ CAMBIAR: era task_id, debe ser assignment_id
                            student_id: studentId,
                            points_earned: pointsEarned,
                            percentage: percentage,
                            notes: notesInput ? notesInput.value : ''
                        });
                    }
                });
                
                if (gradesToSave.length === 0) {
                    showMessage('error', 'No hay calificaciones para guardar');
                    return;
                }
                
                console.log('üíæ Guardando calificaciones:', gradesToSave);
                
                const response = await fetch('/api/task-grades', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ grades: gradesToSave })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('success', `‚úÖ ${gradesToSave.length} calificaciones guardadas correctamente`);
                    await loadTasks(); // Actualizar estad√≠sticas
                } else {
                    showMessage('error', 'Error: ' + result.message);
                }
                
            } catch (error) {
                console.error('‚ùå Error guardando calificaciones:', error);
                showMessage('error', 'Error guardando calificaciones');
            }
        }

        function closeGrading() {
            document.getElementById('gradingContainer').style.display = 'none';
            document.getElementById('tasksContainer').style.display = 'block';
            currentTaskId = null;
            currentTask = null;
        }

        // ========================================
        // UTILIDADES
        // ========================================
        function showTaskCreator() {
            document.getElementById('taskCreator').classList.remove('hidden');
            document.getElementById('taskCreatorPlaceholder').style.display = 'none';
        }

        function hideTaskCreator() {
            document.getElementById('taskCreator').classList.add('hidden');
            document.getElementById('taskCreatorPlaceholder').style.display = 'block';
        }

        function resetMainArea() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('tasksContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('gradingContainer').style.display = 'none';
            document.getElementById('statsCard').style.display = 'none';
            
            document.getElementById('mainTitle').textContent = 'üìù Gesti√≥n de Tareas';
            document.getElementById('mainSubtitle').textContent = 'Seleccione grado y materia para comenzar';
        }

        function updateStats() {
            document.getElementById('totalStudents').textContent = students.length;
            document.getElementById('totalTasks').textContent = tasks.length;
            
            if (tasks.length > 0) {
                const avgGrade = tasks.reduce((sum, task) => sum + (task.avg_grade || 0), 0) / tasks.length;
                document.getElementById('avgGrade').textContent = avgGrade.toFixed(1) + '%';
                document.getElementById('statsCard').style.display = 'block';
                document.getElementById('exportBtn').style.display = 'inline-flex';
            } else {
                document.getElementById('avgGrade').textContent = '0%';
                document.getElementById('statsCard').style.display = 'none';
                document.getElementById('exportBtn').style.display = 'none';
            }
        }

        function closeEditTaskModal() {
            document.getElementById('editTaskModal').classList.remove('show');
            currentTaskId = null;
        }

        function showMessage(type, message) {
            const messageEl = document.getElementById(type + 'Message');
            messageEl.textContent = message;
            messageEl.classList.add('show');
            
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 5000);
        }

        function exportGrades() {
            showMessage('success', 'üìÑ Funci√≥n de exportar en desarrollo');
        }

        function viewTaskStats(taskId) {
            showMessage('success', 'üìä Funci√≥n de estad√≠sticas detalladas en desarrollo');
        }

        // Cerrar modales al hacer clic fuera
        document.getElementById('editTaskModal').addEventListener('click', function(event) {
            if (event.target === this) closeEditTaskModal();
        });
    </script>
</body>
</html>